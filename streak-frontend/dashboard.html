<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#0f8a73" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Streak Up" />
    <meta name="apple-mobile-web-app-title" content="Streak Up" />
    <meta name="description" content="Streak Up dashboard for tracking habits, checking progress, and sharing streak reports." />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/icons/favicon-32.png" />
    <link rel="shortcut icon" href="./assets/icons/favicon-32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/icons/apple-touch-icon.png" />
    <title>Dashboard - Streak Up</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Manrope:wght@400;600;700;800&family=Sora:wght@400;600;700&display=swap");

      :root {
        --bg: #edf5f2;
        --card: #ffffff;
        --muted: #5b7572;
        --text: #132625;
        --accent: #0f9d7d;
        --accent-dark: #0b775f;
        --border: #d7e7e2;
        --danger: #b4432f;
        --ok: #17785f;
      }

      * { box-sizing: border-box; }

      html,
      body {
        width: 100%;
        max-width: 100%;
      }

      body {
        margin: 0;
        min-height: 100dvh;
        min-height: 100vh;
        font-family: "Sora", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 4% 0%, rgba(15, 157, 125, 0.22), transparent 26%),
          radial-gradient(circle at 100% 8%, rgba(255, 170, 83, 0.2), transparent 26%),
          linear-gradient(180deg, #f6faf9 0%, #edf5f2 100%),
          var(--bg);
        padding:
          max(0px, env(safe-area-inset-top))
          max(0px, env(safe-area-inset-right))
          max(0px, env(safe-area-inset-bottom))
          max(0px, env(safe-area-inset-left));
        overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
      }

      .app {
        width: 100%;
        max-width: 520px;
        margin: 0 auto;
        padding: 1rem clamp(0.62rem, 3.6vw, 0.8rem) calc(6rem + min(env(safe-area-inset-bottom, 0px), 12px));
      }

      .title { margin: 0; font-family: "DM Serif Display", serif; font-size: clamp(1.95rem, 8vw, 2.4rem); letter-spacing: 0.01em; }
      .subtitle { margin: 0.36rem 0 0; color: var(--muted); font-size: 0.92rem; }
      .meta { margin: 0.46rem 0 0; color: #58706d; font-size: 0.84rem; }
      .welcome-label {
        margin: 0;
        font-size: 0.72rem;
        font-weight: 700;
        font-family: "Sora", sans-serif;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #000000;
      }

      .welcome-name {
        margin: 0.16rem 0 0;
        font-size: clamp(1.34rem, 6.3vw, 2.02rem);
        font-weight: 800;
        font-family: "Sora", sans-serif;
        letter-spacing: 0.01em;
        line-height: 1.2;
        color: #000000;
        word-break: break-word;
        overflow-wrap: anywhere;
      }

      .row {
        margin-top: 0.74rem;
        border: none;
        border-radius: 0;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.1rem 0;
        box-shadow: none;
      }

      .user-name { font-weight: 700; font-size: 0.86rem; letter-spacing: 0.01em; }

      .btn {
        border: none;
        border-radius: 12px;
        min-height: 42px;
        padding: 0.52rem 0.78rem;
        font: inherit;
        font-size: 0.83rem;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.14s ease, box-shadow 0.18s ease;
      }

      .btn:hover:not(:disabled) { transform: translateY(-1px); }
      .btn:disabled {
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
      }
      .btn-main {
        color: #fff;
        background: linear-gradient(135deg, var(--accent), #14b48f);
        box-shadow: 0 8px 16px rgba(15, 157, 125, 0.3);
      }
      .btn-soft { color: #1e5a50; background: #ebfaf4; border: 1px solid #cbebde; }
      .btn-ghost { color: #2a554e; background: #f4faf8; border: 1px solid var(--border); }
      .card-actions .btn-main:disabled {
        color: #f8fdfb;
        border: 1px solid #95c8b7;
        background: linear-gradient(135deg, #9ec9b9, #8db8ab);
      }

      .status { min-height: 1.2rem; margin-top: 0.7rem; font-size: 0.85rem; color: var(--muted); }
      .status.error { color: var(--danger); }
      .status.success { color: var(--ok); }
      .install-banner {
        margin-top: 0.42rem;
        border: 1px solid #bfe6da;
        border-radius: 18px;
        background:
          radial-gradient(circle at 0% -40%, rgba(20, 180, 143, 0.28), transparent 55%),
          linear-gradient(150deg, #f8fffc 0%, #eaf7f2 100%);
        box-shadow: 0 12px 24px rgba(13, 70, 57, 0.08);
        padding: 0.82rem 0.84rem;
        display: grid;
        grid-template-columns: auto minmax(0, 1fr) auto;
        gap: 0.72rem;
        align-items: center;
      }
      .install-banner[hidden] { display: none !important; }
      .install-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: linear-gradient(145deg, #0f9d7d, #14b48f);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.38);
        display: grid;
        place-items: center;
        color: #ffffff;
      }
      .install-icon svg {
        width: 22px;
        height: 22px;
        display: block;
      }
      .install-copy {
        display: grid;
        gap: 0.18rem;
        min-width: 0;
      }
      .install-title {
        margin: 0;
        font-size: 0.88rem;
        font-weight: 800;
        color: #12443a;
        letter-spacing: 0.01em;
      }
      .install-status {
        margin: 0;
        font-size: 0.77rem;
        color: #4f746d;
        line-height: 1.45;
      }
      .install-status.success { color: #127c61; }
      .install-status.error { color: var(--danger); }
      .install-cta-btn {
        min-width: 128px;
        min-height: 40px;
        border-radius: 12px;
        color: #fff;
        font-size: 0.8rem;
        background: linear-gradient(135deg, #0f9d7d, #14b48f);
        box-shadow: 0 10px 20px rgba(15, 157, 125, 0.28);
      }
      @media (max-width: 460px) {
        .install-banner {
          grid-template-columns: auto minmax(0, 1fr);
        }
        .install-cta-btn {
          grid-column: 1 / -1;
          width: 100%;
        }
      }

      .tab-section { display: none; margin-top: 0.95rem; }
      .tab-section.active { display: block; }

      .summary {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.58rem;
      }

      .sum-card {
        border: none;
        border-radius: 0;
        background: transparent;
        padding: 0.32rem 0.14rem 0.52rem;
        box-shadow: none;
      }

      .sum-card::after {
        content: "";
        display: block;
        width: 100%;
        height: 2px;
        margin-top: 0.46rem;
        border-radius: 999px;
        background: linear-gradient(90deg, #9dcfc1, #d4e7df);
      }

      .sum-card:nth-child(1)::after {
        background: linear-gradient(90deg, #16a67c, #7ecfb2);
      }

      .sum-card:nth-child(2)::after {
        background: linear-gradient(90deg, #1b79d8, #8ec3ff);
      }

      .sum-card:nth-child(3)::after {
        background: linear-gradient(90deg, #d58a22, #edc076);
      }

      .sum-label { font-size: 0.73rem; color: #607a78; font-weight: 600; }
      .sum-value { margin-top: 0.2rem; font-size: 1.42rem; font-weight: 700; letter-spacing: 0.01em; }

      .panel {
        margin-top: 1.02rem;
        border: none;
        border-radius: 0;
        background: transparent;
        padding: 0;
        box-shadow: none;
        overflow: visible;
      }

      .panel h2 {
        margin: 0;
        display: inline-block;
        padding-bottom: 0.3rem;
        font-size: 1.02rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border-bottom: 1px solid rgba(16, 48, 42, 0.24);
      }

      .panel p { margin: 0.4rem 0 0; font-size: 0.84rem; color: #5c7472; line-height: 1.4; }

      .report-summary-grid {
        margin-top: 0.66rem;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.48rem;
      }

      .report-summary-empty {
        grid-column: 1 / -1;
        border: 1px dashed #cdd9d6;
        border-radius: 12px;
        background: #f9fcfb;
        padding: 0.66rem 0.72rem;
        color: #5f7775;
        font-size: 0.82rem;
      }

      .report-kpi {
        border: 1px solid #d5e1de;
        border-radius: 12px;
        background: #f7fbfa;
        padding: 0.58rem 0.62rem;
        display: grid;
        gap: 0.16rem;
      }

      .report-kpi-label {
        margin: 0;
        font-size: 0.68rem;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #617977;
      }

      .report-kpi-value {
        margin: 0;
        font-size: 1.06rem;
        font-weight: 800;
        color: #143631;
      }

      .report-kpi-hint {
        margin: 0;
        font-size: 0.74rem;
        color: #62817b;
      }

      .report-filter-wrap {
        margin-top: 0.68rem;
        display: grid;
        gap: 0.28rem;
      }

      .report-filter-select {
        appearance: none;
      }

      .report-detail {
        margin-top: 0.62rem;
      }

      .report-detail .calendar-report {
        border: 1px solid #d8e4f1;
        border-top: 1px solid #d8e4f1;
        border-radius: 14px;
        background: #f8fbff;
        padding: 0.68rem;
      }

      .report-detail .calendar-report-empty {
        border-radius: 14px;
      }

      .streak-list { margin-top: 0.6rem; display: grid; gap: 0; }
      .card {
        position: relative;
        border: none;
        border-top: 1px solid rgba(16, 54, 47, 0.16);
        border-radius: 0;
        background: var(--card-bg, transparent);
        padding: 0.92rem 0.08rem 0.92rem 0.92rem;
        display: grid;
        gap: 0.64rem;
        box-shadow: none;
        cursor: pointer;
        transition: background-color 0.16s ease, transform 0.14s ease;
        overflow: visible;
      }

      .card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0.72rem;
        bottom: 0.72rem;
        width: 4px;
        border-radius: 999px;
        background: var(--card-border, #1aa684);
        opacity: 0.94;
      }

      .card.selected {
        border-top-color: rgba(15, 138, 115, 0.46);
        background:
          linear-gradient(180deg, rgba(255, 255, 255, 0.42) 0%, rgba(255, 255, 255, 0.24) 100%),
          var(--card-bg, transparent);
      }

      .card:hover {
        transform: translateX(2px);
      }

      .card-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        min-width: 0;
      }

      .card-head {
        display: flex;
        align-items: center;
        gap: 0.55rem;
        flex: 1 1 0%;
        max-width: 100%;
        min-width: 0;
        overflow: hidden;
      }

      .card-icon {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: transparent;
        color: var(--card-icon-color, #f26f24);
        font-size: 1rem;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: none;
        border: 2px solid var(--card-icon-inset, #9dcaba);
      }

      .card-name {
        display: block;
        margin: 0;
        font-size: 1.12rem;
        font-weight: 700;
        color: #132927;
        flex: 1 1 0%;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card-calendar-btn {
        border: none;
        background: transparent;
        color: #1c70d7;
        font: inherit;
        font-size: 0.76rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.32rem;
        padding: 0.1rem 0;
        border-radius: 0;
        cursor: pointer;
        flex-shrink: 0;
      }

      .card-calendar-btn:hover {
        text-decoration: underline;
      }

      .card-tools {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.3rem;
        flex-wrap: wrap;
        flex-shrink: 0;
      }

      .icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        border: 1px solid #c8dad4;
        background: transparent;
        color: #2c5d55;
        font-size: 0.88rem;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .icon-btn:hover:not(:disabled) {
        background: rgba(31, 135, 113, 0.12);
      }

      .icon-btn.archive {
        border-color: #c9d9f8;
        background: transparent;
        color: #335ec0;
      }

      .icon-btn.restore {
        border-color: #c7e1d4;
        background: transparent;
        color: #187658;
      }

      .icon-btn.delete {
        border-color: #e9c9c9;
        background: transparent;
        color: #b14444;
      }

      .icon-btn.share {
        border-color: #c7daf5;
        background: transparent;
        color: #2b67c4;
      }

      .card-archived {
        filter: saturate(0.82);
      }

      .card-completed { border-top-color: rgba(113, 160, 53, 0.32); }

      .complete-badge {
        margin: 0;
        padding: 0.2rem 0.48rem;
        border: 1px solid #b6d99c;
        border-radius: 999px;
        background: #eefbe3;
        color: #3f7a20;
        font-size: 0.68rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        display: inline-flex;
        width: fit-content;
      }

      .card-goal-label {
        margin: 0;
        font-size: 0.72rem;
        color: #6f8481;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .card-goal-text {
        margin: 0.12rem 0 0;
        font-size: 0.98rem;
        font-weight: 700;
        color: #1d3532;
        line-height: 1.35;
        overflow-wrap: anywhere;
        word-break: break-word;
      }

      .week-track {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.34rem;
      }

      .week-item {
        display: grid;
        justify-items: center;
        gap: 0.24rem;
        min-width: 0;
      }

      .week-block {
        width: min(100%, 34px);
        aspect-ratio: 1 / 1;
        border-radius: 999px;
        border: 1px solid #d5e3df;
        background: #eef3f1;
        color: #8ea7a1;
        font-size: 0.8rem;
        font-weight: 700;
        display: grid;
        place-items: center;
        transition: transform 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
      }

      .week-check {
        width: 14px;
        height: 14px;
        display: inline-flex;
      }

      .week-check svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .week-check path {
        fill: none;
        stroke: currentColor;
        stroke-width: 2.3;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .week-today-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: currentColor;
      }

      .week-block.done {
        background: linear-gradient(135deg, #1fc775, #16af66);
        border-color: #19b56f;
        color: #ffffff;
        box-shadow: 0 7px 14px rgba(26, 170, 102, 0.25);
      }

      .week-block.today {
        background: #e3f4ff;
        border-color: #2f8fd8;
        color: #2f8fd8;
      }

      .week-block.today.done {
        background: linear-gradient(135deg, #1fc775, #16af66);
        border-color: #19b56f;
        color: #ffffff;
      }

      .week-block.missed {
        background: #fff2eb;
        border-color: #efc8b8;
        color: #ba6c53;
      }

      .week-block.inactive,
      .week-block.future {
        background: #f6f8f8;
        border-color: #e2e9e8;
        color: #a4b3b0;
      }

      .week-label {
        font-size: 0.65rem;
        color: #829896;
        font-weight: 700;
        letter-spacing: 0.08em;
      }

      .week-item.done .week-label {
        color: #2f8a69;
      }

      .week-item.today .week-label {
        color: #2f74a5;
      }

      .week-item.done.today .week-label {
        color: #2f8a69;
      }

      .card-stats {
        border-top: 1px dashed #cbded8;
        padding-top: 0.6rem;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.46rem;
      }

      .card-stat {
        display: grid;
        gap: 0.16rem;
        padding: 0 0 0 0.5rem;
        border: none;
        border-radius: 0;
        border-left: 2px solid rgba(19, 45, 42, 0.22);
        background: transparent;
      }

      .card-stat + .card-stat {
        padding-left: 0.5rem;
      }

      .card-stat-label {
        font-size: 0.76rem;
        color: #627876;
        font-weight: 600;
      }

      .card-stat-value {
        margin: 0;
        font-size: 1.12rem;
        font-weight: 700;
        line-height: 1.14;
        color: #122625;
      }

      .card-actions {
        display: flex;
        gap: 0.42rem;
      }

      .card-actions .btn-main {
        flex: 1;
        min-height: 46px;
        border-radius: 13px;
      }

      .empty {
        border: none;
        border-left: 3px solid #c7dbd4;
        border-radius: 0;
        background: transparent;
        padding: 0.64rem 0 0.64rem 0.7rem;
        font-size: 0.86rem;
        color: #64817d;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .calendar-backdrop {
        position: fixed;
        inset: 0;
        z-index: 70;
        opacity: 0;
        pointer-events: none;
        background: rgba(10, 20, 34, 0.46);
        transition: opacity 0.24s ease;
      }

      .calendar-backdrop.show {
        opacity: 1;
        pointer-events: auto;
      }

      .calendar-sheet {
        position: fixed;
        inset-inline: 0;
        bottom: 0;
        z-index: 75;
        pointer-events: none;
        transform: translateY(104%);
        transition: transform 0.28s ease;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        overflow: hidden;
        padding:
          0
          max(0.6rem, env(safe-area-inset-right))
          calc(0.62rem + env(safe-area-inset-bottom))
          max(0.6rem, env(safe-area-inset-left));
      }

      .calendar-sheet.open {
        pointer-events: auto;
        transform: translateY(0);
      }

      .calendar-sheet-card {
        position: relative;
        width: min(500px, 100%);
        max-width: 500px;
        margin: 0 auto;
        border: 1px solid #d9e5f4;
        border-radius: 18px;
        background: linear-gradient(180deg, #fbfdff 0%, #f4f8ff 100%);
        box-shadow: 0 -14px 36px rgba(16, 26, 40, 0.2);
        max-height: calc(100dvh - 1.4rem - env(safe-area-inset-bottom));
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }

      .calendar-handle {
        width: 62px;
        height: 5px;
        border-radius: 999px;
        background: #d5deea;
        margin: 0.56rem auto 0.32rem;
      }

      .calendar-head {
        display: grid;
        grid-template-columns: 40px 1fr 40px;
        align-items: center;
        gap: 0.4rem;
        padding: 0 0.6rem;
      }

      .month-wrap {
        text-align: center;
        min-width: 0;
      }

      .selected-label {
        margin: 0;
        font-size: 0.76rem;
        color: #647487;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .month {
        margin-top: 0.2rem;
        font-size: 1.02rem;
        font-weight: 700;
        color: #1a2a43;
      }

      .month-nav-btn {
        width: 34px;
        height: 34px;
        border: 1px solid #cfdaea;
        border-radius: 999px;
        background: #ffffff;
        color: #2f425d;
        font: inherit;
        font-size: 1.35rem;
        line-height: 1;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .month-nav-btn:active {
        transform: scale(0.97);
      }

      .today-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        min-height: 30px;
        padding: 0.2rem 0.74rem;
        border: 1px solid #c8d6ec;
        border-radius: 999px;
        background: #ffffff;
        color: #355075;
        font: inherit;
        font-size: 0.76rem;
        font-weight: 700;
      }

      .calendar-top-actions {
        margin-top: 0.4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.38rem;
        padding: 0 0.62rem;
      }

      .close-pill {
        border-color: #d8dfe9;
        color: #4f6177;
        background: #f5f8fd;
      }

      .calendar-scroll-hint {
        margin: 0.28rem 0 0;
        text-align: center;
        font-size: 0.66rem;
        color: #6c7f96;
        font-weight: 600;
        letter-spacing: 0.03em;
      }

      .weekdays, .grid {
        margin-top: 0.62rem;
        padding: 0 0.58rem;
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.42rem;
      }

      .weekday {
        text-align: center;
        font-size: 0.74rem;
        color: #667482;
        font-weight: 600;
      }

      .day {
        position: relative;
        width: 100%;
        aspect-ratio: 1 / 1;
        border: 1px solid #dde4ed;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.86rem;
        font-weight: 600;
        color: #667789;
        background: #ffffff;
      }

      .day.empty {
        border-color: transparent;
        background: transparent;
        color: transparent;
      }

      .day.done {
        border-color: #1fc475;
        background: linear-gradient(135deg, #22cb7a, #16ac66);
        color: #ffffff;
        box-shadow: 0 8px 14px rgba(23, 177, 103, 0.25);
      }

      .day.today {
        border-color: #2c7ffd;
      }

      .day.done.today {
        border-color: #1fc475;
        background: linear-gradient(135deg, #22cb7a, #16ac66);
        color: #ffffff;
        box-shadow: 0 8px 14px rgba(23, 177, 103, 0.25);
      }

      .day.today::after {
        content: "";
        position: absolute;
        left: 30%;
        right: 30%;
        bottom: -6px;
        height: 3px;
        border-radius: 999px;
        background: #2c7ffd;
      }

      .day.missed {
        border-color: #f0cbc5;
        background: #fff3f1;
        color: #b35e4f;
      }

      .day.future,
      .day.inactive,
      .day.after {
        border-color: #e4e9f0;
        background: #f6f8fb;
        color: #9aa7b5;
      }

      .calendar-sheet-stats {
        margin-top: 0.82rem;
        border-top: 1px solid #d9e3f2;
        background: #eef4ff;
        padding:
          0.8rem
          0.94rem
          0.84rem;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 0.72rem;
      }

      .calendar-sheet-stat {
        min-width: 0;
      }

      .calendar-sheet-label {
        margin: 0;
        font-size: 0.82rem;
        color: #213b5d;
        line-height: 1.22;
      }

      .calendar-sheet-value {
        margin: 0.2rem 0 0;
        font-size: 1.22rem;
        font-weight: 700;
        color: #1966d4;
      }

      .calendar-sheet-divider {
        width: 1px;
        align-self: stretch;
        background: #cad5e7;
      }

      .share-backdrop {
        position: fixed;
        inset: 0;
        z-index: 84;
        opacity: 0;
        pointer-events: none;
        background: rgba(9, 19, 32, 0.42);
        transition: opacity 0.22s ease;
      }

      .share-backdrop.show {
        opacity: 1;
        pointer-events: auto;
      }

      .share-sheet {
        position: fixed;
        inset-inline: 0;
        bottom: 0;
        z-index: 85;
        pointer-events: none;
        transform: translateY(104%);
        transition: transform 0.24s ease;
        padding:
          0
          max(0.64rem, env(safe-area-inset-right))
          calc(0.62rem + env(safe-area-inset-bottom))
          max(0.64rem, env(safe-area-inset-left));
      }

      .share-sheet.open {
        pointer-events: auto;
        transform: translateY(0);
      }

      .share-sheet-card {
        max-width: 500px;
        margin: 0 auto;
        border: 1px solid #d4e1f1;
        border-radius: 18px;
        background: linear-gradient(180deg, #fdfefe 0%, #f4f8ff 100%);
        box-shadow: 0 -16px 36px rgba(12, 24, 39, 0.22);
        padding: 0.64rem 0.74rem 0.76rem;
      }

      .share-handle {
        width: 60px;
        height: 5px;
        border-radius: 999px;
        background: #d2ddea;
        margin: 0.04rem auto 0.42rem;
      }

      .share-title {
        margin: 0;
        text-align: center;
        font-size: 0.92rem;
        font-weight: 800;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: #233f5f;
      }

      .share-subtitle {
        margin: 0.22rem 0 0;
        text-align: center;
        font-size: 0.76rem;
        color: #5f7593;
      }

      .share-grid {
        margin-top: 0.58rem;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.38rem;
      }

      .share-btn {
        border: 1px solid #ceddee;
        border-radius: 12px;
        min-height: 44px;
        padding: 0.34rem 0.4rem;
        background: #ffffff;
        color: #1f446f;
        font: inherit;
        font-size: 0.74rem;
        font-weight: 700;
        display: inline-grid;
        place-items: center;
        text-align: center;
      }

      .share-btn:hover {
        background: #f3f8ff;
      }

      .share-close {
        margin-top: 0.58rem;
        width: 100%;
        border: 1px solid #cfdae8;
        border-radius: 12px;
        min-height: 42px;
        background: #f6f9fd;
        color: #425972;
        font: inherit;
        font-size: 0.8rem;
        font-weight: 700;
      }

      .share-note {
        margin: 0.34rem 0 0;
        text-align: center;
        font-size: 0.67rem;
        color: #637e99;
      }

      .share-status {
        margin: 0.28rem 0 0;
        min-height: 1.04rem;
        text-align: center;
        font-size: 0.75rem;
        color: #3f5a79;
      }

      .share-status.success {
        color: #15785e;
      }

      .share-status.error {
        color: #b14444;
      }

      .calendar-report {
        border-top: 1px solid #d8e2f1;
        background: #f8fbff;
        padding:
          0.74rem
          0.94rem
          calc(0.9rem + env(safe-area-inset-bottom));
        display: grid;
        gap: 0.56rem;
      }

      .calendar-report-empty {
        border: 1px dashed #cdd9eb;
        border-radius: 12px;
        padding: 0.56rem 0.66rem;
        font-size: 0.8rem;
        color: #5f7290;
        background: #ffffff;
      }

      .calendar-report-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .calendar-report-title {
        margin: 0;
        font-size: 0.88rem;
        font-weight: 800;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #223c5f;
      }

      .calendar-report-sub {
        margin: 0;
        font-size: 0.72rem;
        color: #5a7395;
        font-weight: 700;
      }

      .calendar-report-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.42rem;
      }

      .calendar-report-card {
        border: 1px solid #d3deed;
        border-radius: 12px;
        background: #ffffff;
        padding: 0.54rem 0.62rem;
        display: grid;
        gap: 0.28rem;
      }

      .calendar-report-key {
        margin: 0;
        font-size: 0.68rem;
        color: #5e7390;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .calendar-report-value {
        margin: 0;
        font-size: 1rem;
        color: #1b3558;
        font-weight: 800;
        line-height: 1.15;
      }

      .calendar-report-block {
        border: 1px solid #d3deed;
        border-radius: 12px;
        background: #ffffff;
        padding: 0.56rem 0.62rem;
      }

      .calendar-report-block-title {
        margin: 0;
        font-size: 0.75rem;
        color: #355476;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .calendar-report-list {
        margin: 0.42rem 0 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 0.28rem;
      }

      .calendar-report-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.6rem;
        font-size: 0.78rem;
        color: #405d7e;
      }

      .calendar-report-list strong {
        margin-left: auto;
        color: #173d73;
        font-size: 0.8rem;
        font-weight: 800;
        white-space: nowrap;
      }

      .calendar-report-note {
        margin: 0.36rem 0 0;
        font-size: 0.68rem;
        color: #607893;
        font-weight: 600;
      }

      .calendar-report-timeline {
        margin-top: 0.44rem;
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.24rem;
      }

      .timeline-pill {
        display: grid;
        justify-items: center;
        gap: 0.16rem;
        min-width: 0;
      }

      .timeline-dot {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        border: 1px solid #d3dfef;
        background: #f4f8fd;
        color: #8da0b8;
        display: grid;
        place-items: center;
        font-size: 0.7rem;
        font-weight: 800;
      }

      .timeline-pill.done .timeline-dot {
        border-color: #20bf74;
        background: linear-gradient(135deg, #27ca80, #15a467);
        color: #ffffff;
      }

      .timeline-pill.missed .timeline-dot {
        border-color: #efc3b8;
        background: #fff1ed;
        color: #bc604e;
      }

      .timeline-pill.pending .timeline-dot {
        border-color: #d0dae7;
        background: #f1f5f9;
        color: #7c8fa8;
      }

      .timeline-pill.inactive .timeline-dot {
        border-color: #dde5f0;
        background: #f5f8fb;
        color: #a3b2c2;
      }

      .timeline-day {
        font-size: 0.58rem;
        font-weight: 700;
        color: #6c8098;
        letter-spacing: 0.03em;
      }

      .timeline-pill.today .timeline-day {
        color: #6f8098;
      }

      body.calendar-open {
        overflow: hidden;
      }

      body.calendar-open .bottom {
        transform: translateY(110%);
      }

      .form { margin-top: 0.74rem; display: grid; gap: 0.6rem; }
      .field { display: grid; gap: 0.28rem; }
      .label { font-size: 0.8rem; color: var(--muted); }
      .input, .time {
        width: 100%;
        border: none;
        border-bottom: 1px solid var(--border);
        border-radius: 0;
        background: rgba(255, 255, 255, 0.42);
        min-height: 44px;
        padding: 0.62rem 0.2rem;
        font: inherit;
        font-size: 16px;
      }
      .input:focus, .time:focus { outline: 2px solid rgba(15,138,115,0.28); border-color: var(--accent); }
      .two { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }

      .toggle {
        border: none;
        border-left: 2px dashed #a4c8bc;
        border-radius: 0;
        background: transparent;
        padding: 0.42rem 0 0.42rem 0.62rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }
      .toggle span { font-size: 0.8rem; color: #365955; }

      .switch { position: relative; display: inline-block; width: 48px; height: 28px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; inset: 0; border-radius: 999px; background: #d6e6e1; }
      .slider::before {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        left: 3px;
        top: 3px;
        border-radius: 50%;
        background: #fff;
        transition: 0.2s;
      }
      .switch input:checked + .slider { background: #159176; }
      .switch input:checked + .slider::before { transform: translateX(20px); }

      .hidden { display: none; }

      .reminder-settings-grid {
        margin-top: 0.62rem;
        display: grid;
        gap: 0.5rem;
      }

      .reminder-settings-title {
        margin: 0;
        font-size: 0.78rem;
        font-weight: 700;
        color: #3a6059;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .reminder-note {
        margin: 0;
        font-size: 0.74rem;
        color: #5d7772;
        line-height: 1.35;
      }

      .reminder-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.42rem;
      }

      .reminder-control-status {
        margin-top: 0.1rem;
      }

      .profile-row {
        margin-top: 0.56rem;
        border: none;
        border-left: 2px solid #c6dcd5;
        border-radius: 0;
        background: transparent;
        padding: 0.36rem 0 0.36rem 0.62rem;
      }
      .profile-key { font-size: 0.72rem; color: var(--muted); }
      .profile-value { margin-top: 0.15rem; font-size: 0.92rem; font-weight: 700; }

      .bottom {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 40;
        border-top: 1px solid #d7e4e0;
        background: rgba(246, 251, 249, 0.95);
        backdrop-filter: blur(10px);
        transition: transform 0.24s ease;
        padding:
          0.5rem
          max(0.7rem, env(safe-area-inset-right))
          calc(0.5rem + env(safe-area-inset-bottom))
          max(0.7rem, env(safe-area-inset-left));
      }

      .bottom-grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 0.32rem; }
      .tab-btn {
        border: none;
        border-radius: 0;
        border-bottom: 2px solid transparent;
        min-height: 34px;
        font: inherit;
        font-size: 0.74rem;
        font-weight: 700;
        color: #2c5a53;
        background: transparent;
        box-shadow: none;
      }
      .tab-btn.active {
        color: #0a7d64;
        border-bottom-color: #0f9d7d;
        background: transparent;
        box-shadow: none;
      }

      @media (max-width: 420px) {
        .app { padding-inline: 0.56rem; }
        .summary { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .sum-card { padding: 0.28rem 0.1rem 0.46rem; border-radius: 0; }
        .sum-label { font-size: 0.66rem; }
        .sum-value { font-size: 1.04rem; }
        .bottom-grid { gap: 0.28rem; }
        .tab-btn { font-size: 0.64rem; min-height: 32px; }
        .report-summary-grid { gap: 0.36rem; }
        .report-kpi { padding: 0.5rem 0.54rem; }
        .report-kpi-label { font-size: 0.62rem; }
        .report-kpi-value { font-size: 0.95rem; }
        .report-kpi-hint { font-size: 0.7rem; }
        .report-detail .calendar-report { padding: 0.56rem; }
        .panel { padding: 0; }
        .card { padding: 0.78rem 0.04rem 0.78rem 0.78rem; gap: 0.56rem; border-radius: 0; }
        .two { grid-template-columns: 1fr; }
        .card-top {
          flex-direction: column;
          align-items: stretch;
          gap: 0.46rem;
        }
        .card-head { width: 100%; }
        .card-calendar-btn {
          align-self: flex-start;
          font-size: 0.74rem;
          padding: 0.3rem 0.5rem;
        }
        .card-tools { width: 100%; justify-content: flex-start; }
        .card-name { font-size: 1rem; }
        .card-goal-text { font-size: 0.9rem; }
        .week-track { gap: 0.24rem; }
        .week-block { width: min(100%, 30px); }
        .week-label { font-size: 0.58rem; letter-spacing: 0.04em; }
        .card-stats { gap: 0.36rem; }
        .card-stat { padding: 0 0 0 0.5rem; }
        .card-stat + .card-stat { padding-left: 0.5rem; }
        .card-stat-value { font-size: 1.1rem; }
        .card-actions { flex-direction: column; }
        .weekdays, .grid { gap: 0.34rem; padding: 0 0.48rem; }
        .day { font-size: 0.8rem; }
        .calendar-sheet-value { font-size: 1.05rem; }
        .calendar-top-actions { gap: 0.32rem; padding-inline: 0.5rem; }
        .today-pill { min-height: 28px; font-size: 0.7rem; padding: 0.18rem 0.62rem; }
        .calendar-scroll-hint { font-size: 0.62rem; }
        .calendar-report { padding-inline: 0.76rem; }
        .calendar-report-grid { gap: 0.34rem; }
        .calendar-report-card,
        .calendar-report-block { padding: 0.5rem 0.54rem; }
        .calendar-report-list li { font-size: 0.74rem; }
        .calendar-report-list strong { font-size: 0.76rem; }
        .timeline-dot { width: 20px; height: 20px; font-size: 0.64rem; }
        .timeline-day { font-size: 0.54rem; }
        .share-grid { gap: 0.32rem; }
        .share-btn { min-height: 40px; font-size: 0.7rem; padding: 0.3rem 0.32rem; }
        .share-sheet-card { padding: 0.56rem 0.58rem 0.66rem; }
        .welcome-label { font-size: 0.68rem; }
        .welcome-name { font-size: clamp(1.16rem, 6.2vw, 1.5rem); }
      }

      @media (max-width: 360px) {
        .app { padding-inline: 0.5rem; }
        .card { padding: 0.7rem 0.04rem 0.7rem 0.74rem; border-radius: 0; }
        .card-name { font-size: 0.95rem; }
        .card-goal-text { font-size: 0.86rem; }
        .week-track { gap: 0.18rem; }
        .week-block { width: min(100%, 27px); }
        .week-label { font-size: 0.54rem; letter-spacing: 0.02em; }
        .card-stats { grid-template-columns: 1fr; }
      }

      /* Modern UI refresh, scoped to dashboard body class */
      body.modern-ui {
        --neo-bg-0: #f4f8ff;
        --neo-bg-1: #eef8f4;
        --neo-surface: rgba(255, 255, 255, 0.8);
        --neo-surface-strong: rgba(255, 255, 255, 0.92);
        --neo-border: rgba(73, 114, 128, 0.2);
        --neo-border-strong: rgba(56, 95, 110, 0.28);
        --neo-text: #162a33;
        --neo-muted: #617886;
        --neo-brand: #0e9a7f;
        --neo-brand-strong: #0b826b;
        --neo-blue: #2089d5;
        --neo-orange: #de8c35;
      }

      body.modern-ui {
        font-family: "Manrope", "Sora", sans-serif;
        color: var(--neo-text);
        background:
          radial-gradient(1120px 620px at -14% -18%, rgba(76, 198, 157, 0.34), transparent 60%),
          radial-gradient(760px 460px at 108% 0%, rgba(255, 179, 102, 0.28), transparent 58%),
          linear-gradient(160deg, var(--neo-bg-0) 0%, var(--neo-bg-1) 50%, #f9fbfd 100%);
        position: relative;
      }

      body.modern-ui::before {
        content: "";
        position: fixed;
        inset: -18vmax;
        pointer-events: none;
        z-index: 0;
        opacity: 0.34;
        background:
          repeating-linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.28) 0,
            rgba(255, 255, 255, 0.28) 1px,
            transparent 1px,
            transparent 32px
          ),
          repeating-linear-gradient(
            0deg,
            rgba(255, 255, 255, 0.22) 0,
            rgba(255, 255, 255, 0.22) 1px,
            transparent 1px,
            transparent 32px
          );
        animation: none;
      }

      body.modern-ui::after {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        opacity: 0.22;
        background-image:
          radial-gradient(rgba(255, 255, 255, 0.9) 0.55px, transparent 0.55px),
          radial-gradient(rgba(16, 41, 53, 0.26) 0.45px, transparent 0.45px);
        background-position: 0 0, 16px 16px;
        background-size: 24px 24px, 24px 24px;
      }

      body.modern-ui .app {
        position: relative;
        z-index: 1;
        max-width: 980px;
        padding: 1.05rem clamp(0.72rem, 3.6vw, 1.1rem) calc(6.4rem + min(env(safe-area-inset-bottom, 0px), 12px));
      }

      body.modern-ui .bg-graphics {
        position: absolute;
        inset: 0 0 auto;
        height: 340px;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }

      body.modern-ui .app > *:not(.bg-graphics) {
        position: relative;
        z-index: 1;
      }

      body.modern-ui .bg-blob {
        position: absolute;
        filter: blur(1px);
      }

      body.modern-ui .bg-blob path {
        fill: rgba(53, 152, 195, 0.16);
      }

      body.modern-ui .bg-blob-a {
        width: 300px;
        top: -110px;
        right: -120px;
      }

      body.modern-ui .bg-blob-b {
        width: 260px;
        top: -86px;
        left: -110px;
      }

      body.modern-ui header {
        position: relative;
        z-index: 1;
        border: 1px solid var(--neo-border);
        border-radius: 24px;
        background:
          linear-gradient(140deg, rgba(255, 255, 255, 0.88) 0%, rgba(255, 255, 255, 0.74) 65%),
          linear-gradient(180deg, rgba(14, 154, 127, 0.07) 0%, rgba(32, 137, 213, 0.04) 100%);
        padding: clamp(1rem, 2.6vw, 1.24rem);
        box-shadow:
          0 22px 40px rgba(25, 54, 66, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        animation: riseIn 0.5s ease both;
      }

      body.modern-ui .hero {
        display: grid;
        grid-template-columns: minmax(0, 1fr) clamp(140px, 25vw, 220px);
        align-items: center;
        gap: 0.88rem;
      }

      body.modern-ui .hero-copy {
        min-width: 0;
      }

      body.modern-ui .hero-visual {
        justify-self: end;
        width: min(100%, 220px);
      }

      body.modern-ui .hero-svg {
        display: block;
        width: 100%;
        height: auto;
      }

      body.modern-ui .welcome-label {
        font-size: 0.66rem;
        color: #2f5261;
        letter-spacing: 0.18em;
      }

      body.modern-ui .welcome-name {
        margin-top: 0.22rem;
        font-family: "DM Serif Display", serif;
        font-size: clamp(1.55rem, 4.8vw, 2.48rem);
        line-height: 1.12;
        color: #0f2731;
      }

      body.modern-ui .meta {
        margin-top: 0.5rem;
        font-size: 0.86rem;
        color: #486775;
      }

      body.modern-ui .status {
        margin-top: 0.72rem;
        padding: 0.45rem 0.7rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.62);
        border: 1px solid rgba(96, 125, 141, 0.24);
      }

      body.modern-ui .status:empty {
        display: none;
      }

      body.modern-ui .summary {
        margin-top: 1rem;
        gap: 0.72rem;
      }

      body.modern-ui .sum-card {
        position: relative;
        overflow: hidden;
        border: 1px solid var(--neo-border);
        border-radius: 18px;
        padding: 0.72rem 0.8rem 0.84rem;
        background:
          linear-gradient(140deg, rgba(255, 255, 255, 0.88) 0%, rgba(255, 255, 255, 0.72) 72%),
          var(--neo-surface);
        box-shadow: 0 12px 24px rgba(17, 40, 49, 0.08);
        backdrop-filter: blur(8px);
        animation: popIn 0.46s ease both;
      }

      body.modern-ui .sum-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      body.modern-ui .sum-hint {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        min-width: 3.05rem;
        padding: 0.16rem 0.45rem;
        border-radius: 999px;
        background: rgba(20, 52, 66, 0.08);
        color: #4d6674;
        font-size: 0.64rem;
        font-weight: 700;
        line-height: 1;
        white-space: nowrap;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      body.modern-ui .sum-card:nth-child(2) {
        animation-delay: 0.06s;
      }

      body.modern-ui .sum-card:nth-child(3) {
        animation-delay: 0.12s;
      }

      body.modern-ui .sum-card::before {
        content: "";
        position: absolute;
        right: -26px;
        top: -30px;
        width: 92px;
        height: 92px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.28);
      }

      body.modern-ui .sum-card::after {
        display: none;
      }

      body.modern-ui .sum-label {
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #57717f;
      }

      body.modern-ui .sum-value {
        margin-top: 0;
        font-size: clamp(1.18rem, 2.4vw, 1.44rem);
        font-weight: 800;
        color: #0f2a31;
      }

      body.modern-ui .sum-value.bump {
        animation: valuePulse 0.34s ease;
      }

      body.modern-ui .sum-ring {
        position: relative;
        width: 112px;
        height: 112px;
        margin: 0.46rem auto 0;
      }

      body.modern-ui .progress-ring {
        width: 112px;
        height: 112px;
        transform: rotate(-90deg);
      }

      body.modern-ui .ring-track,
      body.modern-ui .ring-fill {
        fill: none;
        stroke-width: 10;
      }

      body.modern-ui .ring-track {
        stroke: rgba(113, 138, 149, 0.22);
      }

      body.modern-ui .ring-fill {
        stroke-linecap: round;
        stroke-dasharray: 282.743;
        stroke-dashoffset: 282.743;
        transition: stroke-dashoffset 0.36s ease;
      }

      body.modern-ui .ring-fill.ring-active {
        stroke: #0e9a7f;
      }

      body.modern-ui .ring-fill.ring-done {
        stroke: #2089d5;
      }

      body.modern-ui .ring-fill.ring-planned {
        stroke: #de8c35;
      }

      body.modern-ui .sum-center {
        position: absolute;
        inset: 0;
        display: grid;
        place-content: center;
        justify-items: center;
        line-height: 1.05;
      }

      body.modern-ui .sum-unit {
        font-size: 0.62rem;
        color: #607a87;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      body.modern-ui .section-wave {
        margin-top: 0.68rem;
        height: 54px;
        overflow: hidden;
        border-radius: 10px;
        position: relative;
      }

      body.modern-ui .section-wave .wave-svg {
        width: 118%;
        height: 100%;
        display: block;
        transform: translateX(-8%);
        animation: waveDrift 9s ease-in-out infinite alternate;
      }

      body.modern-ui .section-wave .wave-back {
        fill: rgba(80, 122, 139, 0.14);
        animation: waveBackPulse 7.5s ease-in-out infinite alternate;
      }

      body.modern-ui .section-wave .wave-front {
        fill: rgba(44, 118, 147, 0.2);
        animation: waveFrontPulse 5.5s ease-in-out infinite alternate;
      }

      body.modern-ui .tab-section {
        margin-top: 1rem;
      }

      body.modern-ui .tab-section.active {
        animation: riseIn 0.28s ease both;
      }

      body.modern-ui .tab-section.active.tab-enter {
        animation: none;
      }

      body.modern-ui .panel {
        margin-top: 0.86rem;
        border: 1px solid var(--neo-border);
        border-radius: 24px;
        background:
          linear-gradient(160deg, rgba(255, 255, 255, 0.91) 0%, rgba(249, 253, 255, 0.8) 70%),
          var(--neo-surface);
        padding: clamp(0.92rem, 2.4vw, 1.22rem);
        box-shadow:
          0 24px 42px rgba(15, 33, 40, 0.09),
          inset 0 1px 0 rgba(255, 255, 255, 0.84);
        backdrop-filter: blur(8px);
      }

      body.modern-ui .tab-section.active.tab-enter .panel {
        animation: none;
      }

      body.modern-ui .tab-section.active.tab-enter .panel:nth-of-type(2) {
        animation-delay: 0.06s;
      }

      body.modern-ui .panel h2 {
        border-bottom: none;
        padding: 0;
        font-size: 0.96rem;
        letter-spacing: 0.11em;
        color: #2a4654;
      }

      body.modern-ui .panel p {
        margin-top: 0.34rem;
        color: #5a7482;
      }

      body.modern-ui .report-summary-grid {
        gap: 0.42rem;
      }

      body.modern-ui .report-kpi {
        border-color: rgba(95, 127, 142, 0.26);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.72);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.74);
      }

      body.modern-ui .report-summary-empty {
        border-color: rgba(97, 126, 141, 0.38);
        background: rgba(255, 255, 255, 0.66);
        color: #607a89;
      }

      body.modern-ui .report-kpi-label {
        color: #637e8e;
      }

      body.modern-ui .report-kpi-value {
        color: #183748;
      }

      body.modern-ui .report-kpi-hint {
        color: #5e7a87;
      }

      body.modern-ui .report-filter-wrap {
        margin-top: 0.72rem;
      }

      body.modern-ui .report-detail .calendar-report {
        border-color: rgba(95, 127, 142, 0.28);
        background: linear-gradient(180deg, rgba(239, 247, 255, 0.88) 0%, rgba(246, 251, 255, 0.94) 100%);
      }

      body.modern-ui .streak-list {
        margin-top: 0.86rem;
        gap: 0.66rem;
      }

      body.modern-ui .card {
        border: 1px solid rgba(67, 111, 126, 0.2);
        border-top: 1px solid rgba(67, 111, 126, 0.2);
        border-radius: 18px;
        padding: 0.9rem 0.8rem 0.84rem 0.9rem;
        background:
          linear-gradient(158deg, rgba(255, 255, 255, 0.66) 0%, rgba(255, 255, 255, 0.36) 100%),
          var(--card-bg, rgba(255, 255, 255, 0.35));
        box-shadow: var(--card-shadow, 0 14px 28px rgba(18, 40, 52, 0.14));
        transition: transform 0.22s ease, box-shadow 0.22s ease, border-color 0.2s ease;
        animation: none;
        animation-delay: var(--stagger-delay, 0ms);
      }

      body.modern-ui .card::before {
        left: 0.34rem;
        top: 0.5rem;
        bottom: 0.5rem;
        width: 5px;
      }

      body.modern-ui .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 22px 32px rgba(16, 36, 46, 0.16);
      }

      body.modern-ui .card.selected {
        border-color: rgba(14, 154, 127, 0.44);
        box-shadow: 0 24px 36px rgba(14, 121, 102, 0.2);
      }

      body.modern-ui .card-icon {
        width: 38px;
        height: 38px;
        border: 1px solid rgba(75, 112, 122, 0.2);
        background:
          radial-gradient(circle at 22% 22%, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.1)),
          var(--card-icon-bg, rgba(255, 255, 255, 0.24));
        box-shadow:
          inset 0 0 0 4px var(--card-icon-inset, rgba(132, 172, 160, 0.36)),
          0 10px 18px rgba(16, 37, 44, 0.12);
      }

      body.modern-ui .card-icon svg {
        width: 20px;
        height: 20px;
        display: block;
      }

      body.modern-ui .card-name {
        font-size: 1.08rem;
        font-weight: 800;
        color: #102932;
      }

      body.modern-ui .card-calendar-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.32rem;
        padding: 0.28rem 0.68rem;
        border: 1px solid rgba(20, 124, 160, 0.3);
        border-radius: 999px;
        background: rgba(37, 146, 198, 0.12);
        color: #1f5d93;
        font-size: 0.74rem;
        font-weight: 700;
      }

      body.modern-ui .card-calendar-btn .btn-icon {
        width: 14px;
        height: 14px;
      }

      body.modern-ui .card-calendar-btn .btn-icon svg {
        width: 100%;
        height: 100%;
      }

      body.modern-ui .card-calendar-btn:hover {
        text-decoration: none;
        background: rgba(37, 146, 198, 0.2);
      }

      body.modern-ui .card-tools {
        gap: 0.42rem;
      }

      body.modern-ui .icon-btn {
        position: relative;
        width: 32px;
        height: 32px;
        border: 1px solid rgba(94, 130, 143, 0.32);
        background: rgba(255, 255, 255, 0.65);
        transition: transform 0.18s ease, background-color 0.18s ease, box-shadow 0.18s ease;
      }

      body.modern-ui .icon-btn .btn-icon {
        width: 15px;
        height: 15px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      body.modern-ui .icon-btn .btn-icon svg {
        width: 100%;
        height: 100%;
      }

      body.modern-ui .icon-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 8px 14px rgba(16, 34, 43, 0.16);
      }

      body.modern-ui .icon-btn.archive {
        border-color: rgba(50, 116, 210, 0.38);
        color: #2c5fb5;
      }

      body.modern-ui .icon-btn.restore {
        border-color: rgba(20, 146, 100, 0.38);
        color: #177453;
      }

      body.modern-ui .icon-btn.delete {
        border-color: rgba(190, 83, 83, 0.34);
        color: #a13c3c;
      }

      body.modern-ui .icon-btn.share {
        border-color: rgba(56, 123, 210, 0.4);
        color: #2b67c4;
      }

      body.modern-ui .complete-badge {
        border: 1px solid rgba(93, 157, 38, 0.34);
        background: linear-gradient(145deg, #edf9dd 0%, #dbf0bd 100%);
        color: #3d7322;
      }

      body.modern-ui .card-goal-label {
        margin-top: 0.12rem;
        font-size: 0.68rem;
        letter-spacing: 0.1em;
        color: #617886;
      }

      body.modern-ui .card-goal-text {
        margin-top: 0;
        font-size: 0.93rem;
        color: #16323e;
      }

      body.modern-ui .week-heatmap {
        border: 1px solid rgba(95, 130, 144, 0.22);
        border-radius: 13px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.7) 0%, rgba(246, 252, 255, 0.64) 100%);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.72);
        padding: 0.4rem 0.48rem 0.46rem;
      }

      body.modern-ui .week-track {
        gap: 0.28rem;
      }

      body.modern-ui .week-block {
        border-color: rgba(114, 145, 158, 0.24);
        background: rgba(214, 224, 230, 0.34);
        color: #88a0aa;
        animation: weekDotIn 0.28s ease both;
        animation-delay: calc(var(--week-index, 0) * 35ms);
      }

      body.modern-ui .week-block.done {
        border-color: rgba(24, 166, 107, 0.7);
        background: linear-gradient(135deg, #25c982, #159f68);
        color: #ffffff;
        box-shadow: 0 7px 14px rgba(22, 160, 104, 0.26);
      }

      body.modern-ui .week-block.today {
        border-color: rgba(38, 137, 213, 0.66);
        background: rgba(72, 168, 239, 0.16);
        color: #1f80c7;
      }

      body.modern-ui .week-block.today.done {
        border-color: rgba(24, 166, 107, 0.7);
        background: linear-gradient(135deg, #25c982, #159f68);
        color: #ffffff;
      }

      body.modern-ui .week-block.missed {
        border-color: rgba(214, 143, 121, 0.38);
        background: rgba(255, 221, 205, 0.46);
        color: #c07157;
      }

      body.modern-ui .week-block.inactive,
      body.modern-ui .week-block.future {
        border-color: rgba(150, 173, 184, 0.26);
        background: rgba(220, 229, 234, 0.34);
        color: #9aadb7;
      }

      body.modern-ui .week-label {
        color: #6f8793;
      }

      body.modern-ui .card-stats {
        border-top: 1px solid rgba(91, 125, 138, 0.24);
        padding-top: 0.56rem;
      }

      body.modern-ui .card-stat {
        border-left: none;
        border-radius: 13px;
        padding: 0.5rem 0.62rem;
        background: rgba(255, 255, 255, 0.56);
        box-shadow: inset 0 0 0 1px rgba(104, 136, 148, 0.14);
      }

      body.modern-ui .card-stat + .card-stat {
        padding-left: 0.62rem;
      }

      body.modern-ui .card-stat-label {
        font-size: 0.72rem;
        color: #607986;
      }

      body.modern-ui .card-stat-value {
        font-size: 1.04rem;
        color: #17313d;
      }

      body.modern-ui .card-actions {
        margin-top: 0.1rem;
      }

      body.modern-ui .btn {
        border-radius: 14px;
        min-height: 44px;
        font-weight: 800;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }

      body.modern-ui .btn:hover:not(:disabled) {
        transform: translateY(-1px);
      }

      body.modern-ui .btn-main {
        background: linear-gradient(135deg, var(--neo-brand) 0%, #12a486 48%, var(--neo-brand-strong) 100%);
        box-shadow: 0 14px 24px rgba(10, 137, 112, 0.28);
      }

      body.modern-ui .btn-main:hover:not(:disabled) {
        filter: saturate(1.06) brightness(1.02);
      }

      body.modern-ui .btn-soft {
        border: 1px solid rgba(16, 148, 121, 0.28);
        background: rgba(17, 157, 128, 0.12);
        color: #0f6f5c;
      }

      body.modern-ui .btn-ghost {
        border: 1px solid rgba(93, 126, 141, 0.28);
        background: rgba(255, 255, 255, 0.68);
      }

      body.modern-ui .empty {
        border: 1px dashed rgba(95, 126, 140, 0.38);
        border-left: 1px dashed rgba(95, 126, 140, 0.38);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.58);
        padding: 0.7rem 0.82rem;
      }

      body.modern-ui .empty-state {
        border: 1px dashed rgba(95, 126, 140, 0.38);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.62);
        padding: 0.84rem 0.76rem;
        display: grid;
        justify-items: center;
        gap: 0.48rem;
        text-align: center;
      }

      body.modern-ui .empty-art {
        width: 94px;
        height: 70px;
      }

      body.modern-ui .empty-art svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      body.modern-ui .empty-title {
        font-size: 0.82rem;
        font-weight: 800;
        color: #345462;
      }

      body.modern-ui .empty-copy {
        font-size: 0.78rem;
        color: #5e7885;
        line-height: 1.4;
      }

      body.modern-ui .form {
        margin-top: 0.84rem;
        gap: 0.72rem;
      }

      body.modern-ui .label {
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #4f6a77;
      }

      body.modern-ui .input,
      body.modern-ui .time {
        border: 1px solid rgba(99, 128, 141, 0.28);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.84);
        min-height: 46px;
        padding: 0.64rem 0.74rem;
      }

      body.modern-ui .input:focus,
      body.modern-ui .time:focus {
        outline: none;
        border-color: rgba(14, 154, 127, 0.66);
        box-shadow: 0 0 0 3px rgba(14, 154, 127, 0.2);
      }

      body.modern-ui .toggle {
        border: 1px solid rgba(96, 124, 139, 0.28);
        border-left: 1px solid rgba(96, 124, 139, 0.28);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.72);
        padding: 0.56rem 0.66rem;
      }

      body.modern-ui .toggle span {
        font-size: 0.82rem;
        color: #355766;
      }

      body.modern-ui .slider {
        background: #c9d9df;
      }

      body.modern-ui .switch input:checked + .slider {
        background: linear-gradient(135deg, #14a286, #0b886f);
      }

      body.modern-ui .profile-row {
        border: 1px solid rgba(100, 130, 144, 0.26);
        border-left: 1px solid rgba(100, 130, 144, 0.26);
        border-radius: 14px;
        padding: 0.56rem 0.68rem;
        background: rgba(255, 255, 255, 0.68);
      }

      body.modern-ui .reminder-settings-title {
        color: #305463;
      }

      body.modern-ui .reminder-note {
        color: #5d7684;
      }

      body.modern-ui .profile-key {
        color: #5f7885;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      body.modern-ui .profile-value {
        color: #132e39;
        font-weight: 800;
      }

      body.modern-ui .calendar-backdrop {
        background: rgba(7, 20, 31, 0.5);
        backdrop-filter: blur(3px);
      }

      body.modern-ui .calendar-sheet-card {
        border: 1px solid rgba(73, 115, 129, 0.26);
        border-radius: 24px;
        background:
          linear-gradient(160deg, rgba(255, 255, 255, 0.92) 0%, rgba(243, 250, 255, 0.84) 72%),
          #ffffff;
        box-shadow: 0 -22px 44px rgba(11, 28, 36, 0.24);
      }

      body.modern-ui .calendar-head {
        padding: 0 0.72rem;
        gap: 0.52rem;
      }

      body.modern-ui .selected-label {
        display: inline-block;
        margin: 0 auto;
        max-width: min(88%, 240px);
        padding: 0.18rem 0.5rem;
        border-radius: 999px;
        background: rgba(21, 112, 207, 0.08);
        color: #5a7082;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      body.modern-ui .month {
        margin-top: 0.28rem;
        font-size: 1.18rem;
        letter-spacing: 0.01em;
      }

      body.modern-ui .calendar-handle {
        background: #cad9e4;
      }

      body.modern-ui .month-nav-btn {
        border-color: rgba(114, 140, 153, 0.28);
        background: rgba(255, 255, 255, 0.9);
      }

      body.modern-ui .today-pill {
        border-color: rgba(16, 150, 122, 0.3);
        background: rgba(18, 156, 128, 0.1);
        color: #0f6f5c;
      }

      body.modern-ui .close-pill {
        border-color: rgba(112, 134, 148, 0.34);
        background: rgba(216, 227, 236, 0.36);
        color: #4d6274;
      }

      body.modern-ui .calendar-scroll-hint {
        color: #6a8191;
      }

      body.modern-ui .day {
        border-color: rgba(115, 139, 151, 0.3);
        background: rgba(255, 255, 255, 0.82);
        transition: border-color 0.16s ease, box-shadow 0.16s ease, background-color 0.16s ease;
      }

      body.modern-ui .day.empty {
        border-color: transparent;
        background: transparent;
        box-shadow: none;
        color: transparent;
        pointer-events: none;
      }

      body.modern-ui .day.done {
        border-color: #23bf78;
        background: linear-gradient(130deg, #23c87e, #149f68);
        color: #ffffff;
        box-shadow: 0 8px 14px rgba(35, 191, 120, 0.24);
      }

      body.modern-ui .day.today {
        border-color: #2588d2;
        background: rgba(37, 136, 210, 0.08);
        box-shadow: inset 0 0 0 2px rgba(37, 136, 210, 0.22);
      }

      body.modern-ui .day.done.today {
        border-color: #23bf78;
        background: linear-gradient(130deg, #23c87e, #149f68);
        color: #ffffff;
        box-shadow: 0 8px 14px rgba(35, 191, 120, 0.24);
      }

      body.modern-ui .day.today::after {
        display: none;
      }

      body.modern-ui .calendar-sheet-stats {
        border-top: 1px solid rgba(104, 132, 149, 0.24);
        background: linear-gradient(180deg, rgba(232, 241, 252, 0.94) 0%, rgba(238, 246, 255, 0.84) 100%);
      }

      body.modern-ui .calendar-sheet-label {
        color: #2e4a64;
      }

      body.modern-ui .calendar-sheet-value {
        color: #1570cf;
      }

      body.modern-ui .share-sheet-card {
        border: 1px solid rgba(78, 117, 132, 0.28);
        background:
          linear-gradient(160deg, rgba(255, 255, 255, 0.92) 0%, rgba(241, 249, 255, 0.84) 74%),
          #ffffff;
      }

      body.modern-ui .share-title {
        color: #25485f;
      }

      body.modern-ui .share-subtitle {
        color: #617d91;
      }

      body.modern-ui .share-btn {
        border-color: rgba(100, 130, 145, 0.28);
        background: rgba(255, 255, 255, 0.76);
        color: #24507a;
      }

      body.modern-ui .share-btn:hover {
        background: rgba(232, 244, 255, 0.82);
      }

      body.modern-ui .share-close {
        border-color: rgba(105, 133, 148, 0.32);
        background: rgba(234, 243, 251, 0.72);
        color: #456278;
      }

      body.modern-ui .share-note {
        color: #678195;
      }

      body.modern-ui .share-status {
        color: #3f5e78;
      }

      body.modern-ui .calendar-report {
        border-top: 1px solid rgba(108, 136, 151, 0.26);
        background: linear-gradient(180deg, rgba(239, 247, 255, 0.88) 0%, rgba(246, 251, 255, 0.94) 100%);
      }

      body.modern-ui .calendar-report-empty {
        border-color: rgba(96, 124, 141, 0.36);
        background: rgba(255, 255, 255, 0.74);
        color: #60798a;
      }

      body.modern-ui .calendar-report-title {
        color: #27485d;
      }

      body.modern-ui .calendar-report-sub {
        color: #5f7b8e;
      }

      body.modern-ui .calendar-report-card,
      body.modern-ui .calendar-report-block {
        border-color: rgba(100, 130, 146, 0.26);
        background: rgba(255, 255, 255, 0.76);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
      }

      body.modern-ui .calendar-report-key {
        color: #627b90;
      }

      body.modern-ui .calendar-report-value {
        color: #163b53;
      }

      body.modern-ui .calendar-report-block-title {
        color: #355f7e;
      }

      body.modern-ui .calendar-report-list li {
        color: #46657f;
      }

      body.modern-ui .calendar-report-list strong {
        color: #1b4f86;
      }

      body.modern-ui .calendar-report-note {
        color: #678092;
      }

      body.modern-ui .timeline-dot {
        border-color: rgba(127, 151, 168, 0.34);
        background: rgba(223, 233, 240, 0.4);
        color: #88a2b4;
      }

      body.modern-ui .timeline-pill.done .timeline-dot {
        border-color: rgba(26, 168, 110, 0.76);
      }

      body.modern-ui .timeline-pill.missed .timeline-dot {
        border-color: rgba(216, 141, 120, 0.5);
        background: rgba(255, 219, 206, 0.56);
      }

      body.modern-ui .timeline-pill.pending .timeline-dot {
        border-color: rgba(141, 160, 176, 0.45);
        background: rgba(220, 228, 236, 0.48);
        color: #7f95a7;
      }

      body.modern-ui .timeline-day {
        color: #6f8798;
      }

      body.modern-ui .bottom {
        left: 50%;
        right: auto;
        width: min(920px, calc(100% - 0.86rem));
        bottom: 0.3rem;
        transform: translateX(-50%);
        border: 1px solid var(--neo-border-strong);
        border-radius: 18px;
        background: rgba(250, 253, 255, 0.84);
        box-shadow: 0 16px 30px rgba(18, 39, 49, 0.16);
        backdrop-filter: blur(16px);
        padding:
          0.24rem
          max(0.44rem, env(safe-area-inset-right))
          calc(0.24rem + min(env(safe-area-inset-bottom, 0px), 9px))
          max(0.44rem, env(safe-area-inset-left));
      }

      body.modern-ui.calendar-open .bottom {
        transform: translate(-50%, 130%);
      }

      body.modern-ui .bottom-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.2rem;
        align-items: center;
      }

      body.modern-ui .tab-btn {
        display: inline-grid;
        justify-items: center;
        align-content: center;
        gap: 0.12rem;
        min-height: 40px;
        padding: 0.26rem 0.12rem;
        border-radius: 11px;
        border-bottom: none;
        font-size: 0.7rem;
        color: #355664;
        line-height: 1;
        transition: transform 0.18s ease, color 0.18s ease, background-color 0.18s ease, box-shadow 0.18s ease;
      }

      body.modern-ui .tab-icon {
        width: 15px;
        height: 15px;
        display: inline-flex;
      }

      body.modern-ui .tab-icon svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      body.modern-ui .tab-icon .icon-outline {
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      body.modern-ui .tab-icon .icon-fill {
        fill: currentColor;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      body.modern-ui .tab-btn.active .tab-icon .icon-fill {
        opacity: 1;
      }

      body.modern-ui .tab-btn.active .tab-icon .icon-outline {
        opacity: 0;
      }

      body.modern-ui .tab-label {
        font-size: 0.62rem;
        white-space: nowrap;
      }

      body.modern-ui .tab-btn:hover {
        transform: translateY(-1px);
        background: rgba(34, 131, 170, 0.12);
      }

      body.modern-ui .tab-btn.active {
        color: #ffffff;
        background: linear-gradient(135deg, #1c93d0, #1379c4);
        box-shadow: 0 8px 18px rgba(19, 121, 196, 0.34);
      }

      body.modern-ui .celebration-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 95;
        overflow: hidden;
        opacity: 0;
        transition: opacity 180ms ease;
      }

      body.modern-ui .celebration-layer.active {
        opacity: 1;
      }

      body.modern-ui .celebration-canvas {
        position: fixed !important;
        inset: 0;
        width: 100vw !important;
        height: 100dvh !important;
        pointer-events: none;
      }

      body.modern-ui .burst {
        position: absolute;
        left: 50%;
        top: 32%;
        width: 110px;
        height: 110px;
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
        animation: burstPop 700ms ease forwards;
      }

      body.modern-ui .burst svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      body.modern-ui .burst-ring {
        fill: none;
        stroke: rgba(25, 165, 123, 0.28);
        stroke-width: 5;
      }

      body.modern-ui .burst-check {
        fill: none;
        stroke: #1aa673;
        stroke-width: 7;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      body.modern-ui .burst-ray {
        fill: #f5b25b;
      }

      @keyframes burstPop {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.7);
        }
        45% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.04);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -52%) scale(1.14);
        }
      }

      @keyframes waveDrift {
        from {
          transform: translateX(-8%);
        }
        to {
          transform: translateX(-2%);
        }
      }

      @keyframes waveBackPulse {
        from {
          transform: translateY(2px);
          opacity: 0.78;
        }
        to {
          transform: translateY(-2px);
          opacity: 1;
        }
      }

      @keyframes waveFrontPulse {
        from {
          transform: translateY(3px);
          opacity: 0.8;
        }
        to {
          transform: translateY(-3px);
          opacity: 1;
        }
      }

      @keyframes meshFloat {
        from {
          transform: translate3d(0, 0, 0);
        }
        to {
          transform: translate3d(0, -22px, 0);
        }
      }

      @keyframes riseIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes popIn {
        from {
          opacity: 0;
          transform: translateY(8px) scale(0.985);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes tabSlideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes panelFloatIn {
        from {
          opacity: 0;
          transform: translateY(12px) scale(0.995);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes weekDotIn {
        from {
          opacity: 0;
          transform: translateY(4px) scale(0.96);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes valuePulse {
        0% {
          opacity: 0.75;
          transform: translateY(2px) scale(0.98);
        }
        60% {
          opacity: 1;
          transform: translateY(-1px) scale(1.04);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @media (max-width: 920px) {
        body.modern-ui .app {
          max-width: 560px;
        }
      }

      @media (max-width: 700px) {
        body.modern-ui .app {
          padding: 0.9rem 0.62rem calc(5.9rem + min(env(safe-area-inset-bottom, 0px), 10px));
        }

        body.modern-ui .hero {
          grid-template-columns: minmax(0, 1fr) 96px;
          align-items: start;
        }

        body.modern-ui .hero-visual {
          justify-self: end;
          align-self: start;
          width: 96px;
          margin-top: 0.06rem;
        }

        body.modern-ui .summary {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        body.modern-ui .sum-card {
          padding: 0.6rem 0.5rem 0.66rem;
        }

        body.modern-ui .sum-ring {
          width: 92px;
          height: 92px;
        }

        body.modern-ui .progress-ring {
          width: 92px;
          height: 92px;
        }

        body.modern-ui .sum-unit {
          font-size: 0.56rem;
        }

        body.modern-ui .section-wave {
          height: 42px;
          margin-top: 0.54rem;
        }

        body.modern-ui header,
        body.modern-ui .panel,
        body.modern-ui .calendar-sheet-card {
          border-radius: 20px;
        }

        body.modern-ui .card {
          border-radius: 16px;
          padding: 0.82rem 0.72rem 0.8rem 0.86rem;
        }

        body.modern-ui .card-top {
          flex-direction: column;
          align-items: stretch;
          gap: 0.46rem;
        }

        body.modern-ui .card-tools {
          justify-content: flex-start;
        }

        body.modern-ui .card-actions {
          flex-direction: column;
        }

        body.modern-ui .calendar-report {
          padding-inline: 0.74rem;
        }

        body.modern-ui .calendar-report-grid {
          gap: 0.34rem;
        }

        body.modern-ui .report-summary-grid {
          gap: 0.34rem;
        }

        body.modern-ui .report-kpi {
          padding: 0.5rem 0.54rem;
        }

        body.modern-ui .bottom {
          width: calc(100% - 0.58rem);
          bottom: 0.2rem;
          border-radius: 16px;
          padding:
            0.2rem
            max(0.36rem, env(safe-area-inset-right))
            calc(0.2rem + min(env(safe-area-inset-bottom, 0px), 7px))
            max(0.36rem, env(safe-area-inset-left));
        }

        body.modern-ui .tab-btn {
          font-size: 0.62rem;
          min-height: 38px;
          padding: 0.2rem 0.06rem;
        }

        body.modern-ui .tab-label {
          font-size: 0.56rem;
        }

        body.modern-ui .two {
          grid-template-columns: 1fr;
        }

        body.modern-ui .card-stats {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 0.42rem;
        }
      }

      @media (max-width: 420px) {
        body.modern-ui .app {
          padding: 0.82rem 0.56rem calc(5.7rem + min(env(safe-area-inset-bottom, 0px), 10px));
        }

        body.modern-ui .hero {
          grid-template-columns: minmax(0, 1fr) 84px;
          gap: 0.5rem;
        }

        body.modern-ui .hero-visual {
          width: 84px;
        }

        body.modern-ui .sum-ring {
          width: 86px;
          height: 86px;
        }

        body.modern-ui .progress-ring {
          width: 86px;
          height: 86px;
        }

        body.modern-ui .panel {
          padding: 0.86rem 0.74rem;
        }

        body.modern-ui .card {
          padding: 0.72rem 0.58rem 0.72rem 0.74rem;
        }

        body.modern-ui .section-wave {
          height: 38px;
          margin-top: 0.48rem;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        body.modern-ui *,
        body.modern-ui *::before,
        body.modern-ui *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
      }
    </style>
  </head>
  <body class="modern-ui">
    <main class="app">
      <div class="bg-graphics" aria-hidden="true">
        <svg class="bg-blob bg-blob-a" viewBox="0 0 300 220">
          <path d="M264 131c-12 45-54 77-98 86-44 8-91-8-123-40-32-33-49-82-37-128 12-47 52-91 99-97 47-6 101 25 132 66 31 40 39 86 27 113z"></path>
        </svg>
        <svg class="bg-blob bg-blob-b" viewBox="0 0 280 200">
          <path d="M238 114c-14 40-58 63-101 69-43 7-87-2-113-31-27-28-37-76-19-113 18-37 64-62 106-70 42-7 80 4 103 29 24 25 37 76 24 116z"></path>
        </svg>
      </div>

      <header class="hero">
        <div class="hero-copy">
          <p class="welcome-label">Welcome</p>
          <p id="welcomeName" class="welcome-name">Streak Champion</p>
          <p id="todayLabel" class="meta"></p>
        </div>
        <div class="hero-visual" aria-hidden="true">
          <svg viewBox="0 0 240 180" class="hero-svg">
            <defs>
              <linearGradient id="heroFlame" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#ffb46c"></stop>
                <stop offset="100%" stop-color="#ff6f3f"></stop>
              </linearGradient>
              <linearGradient id="heroCal" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#5bc8ff"></stop>
                <stop offset="100%" stop-color="#2d86d8"></stop>
              </linearGradient>
            </defs>
            <rect x="80" y="36" width="120" height="104" rx="18" fill="url(#heroCal)" opacity="0.92"></rect>
            <rect x="92" y="56" width="96" height="72" rx="12" fill="#ffffff" opacity="0.95"></rect>
            <rect x="108" y="24" width="14" height="22" rx="7" fill="#c6e8ff"></rect>
            <rect x="158" y="24" width="14" height="22" rx="7" fill="#c6e8ff"></rect>
            <path d="M108 84l11 11 18-21" fill="none" stroke="#23b06f" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M148 84l11 11 18-21" fill="none" stroke="#23b06f" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M49 136c0-24 19-41 37-41s37 17 37 41c0 20-17 34-37 34s-37-14-37-34z" fill="url(#heroFlame)"></path>
            <path d="M68 121c0-12 8-24 18-32 10 8 18 20 18 32 0 10-8 17-18 17s-18-7-18-17z" fill="#ffd89e"></path>
            <circle cx="198" cy="36" r="15" fill="#17b58f"></circle>
            <path d="M191 36l5 5 10-11" fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
      </header>

      <p id="globalStatus" class="status" aria-live="polite"></p>
      <section id="installBanner" class="install-banner" aria-live="polite" hidden>
        <div class="install-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" role="presentation">
            <path fill="currentColor" d="M12 3a1 1 0 0 1 1 1v8.56l2.3-2.3a1 1 0 1 1 1.4 1.42l-4 3.97a1 1 0 0 1-1.4 0l-4-3.97a1 1 0 0 1 1.4-1.42l2.3 2.3V4a1 1 0 0 1 1-1Zm-7 14a1 1 0 0 1 1 1v1h12v-1a1 1 0 1 1 2 0v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1Z"></path>
          </svg>
        </div>
        <div class="install-copy">
          <p class="install-title">Install Streak Up App</p>
          <p id="installQuickState" class="install-status">Checking install availability...</p>
        </div>
        <button id="installAppQuickBtn" class="btn install-cta-btn" type="button">Install App</button>
      </section>

      <section id="sectionDashboard" class="tab-section active">
        <div class="summary">
          <article class="sum-card" data-metric="active">
            <div class="sum-head">
              <div class="sum-label">Active Streaks</div>
              <div id="activeHint" class="sum-hint">Live</div>
            </div>
            <div class="sum-ring">
              <svg class="progress-ring" viewBox="0 0 120 120" aria-hidden="true">
                <circle class="ring-track" cx="60" cy="60" r="45"></circle>
                <circle id="activeRing" class="ring-fill ring-active" cx="60" cy="60" r="45"></circle>
              </svg>
              <div class="sum-center">
                <div id="activeCount" class="sum-value">0</div>
                <div class="sum-unit">streaks</div>
              </div>
            </div>
          </article>

          <article class="sum-card" data-metric="done">
            <div class="sum-head">
              <div class="sum-label">Done Today</div>
              <div id="doneHint" class="sum-hint">Daily</div>
            </div>
            <div class="sum-ring">
              <svg class="progress-ring" viewBox="0 0 120 120" aria-hidden="true">
                <circle class="ring-track" cx="60" cy="60" r="45"></circle>
                <circle id="doneRing" class="ring-fill ring-done" cx="60" cy="60" r="45"></circle>
              </svg>
              <div class="sum-center">
                <div id="doneTodayCount" class="sum-value">0</div>
                <div class="sum-unit">done</div>
              </div>
            </div>
          </article>

          <article class="sum-card" data-metric="planned">
            <div class="sum-head">
              <div class="sum-label">Planned Days</div>
              <div id="plannedHint" class="sum-hint">Goal</div>
            </div>
            <div class="sum-ring">
              <svg class="progress-ring" viewBox="0 0 120 120" aria-hidden="true">
                <circle class="ring-track" cx="60" cy="60" r="45"></circle>
                <circle id="bestRing" class="ring-fill ring-planned" cx="60" cy="60" r="45"></circle>
              </svg>
              <div class="sum-center">
                <div id="bestCount" class="sum-value">0</div>
                <div class="sum-unit">days</div>
              </div>
            </div>
          </article>
        </div>

        <div class="section-wave" aria-hidden="true">
          <svg class="wave-svg" viewBox="0 0 1400 160" preserveAspectRatio="none">
            <path class="wave-back" d="M0 96c120 22 226 24 345 5 108-17 215-50 338-50 132 0 237 36 348 49 116 13 240 2 369-23V160H0z"></path>
            <path class="wave-front" d="M0 112c95 28 209 38 326 20 115-18 224-60 352-60 121 0 219 37 330 54 130 20 267 12 392-17V160H0z"></path>
          </svg>
        </div>

        <article class="panel">
          <h2>Streak Cards</h2>
          <p>Clean daily view for progress, schedule, and quick marking.</p>
          <div id="streakList" class="streak-list" aria-live="polite"></div>
        </article>

      </section>

      <section id="sectionAdd" class="tab-section">
        <article class="panel">
          <h2>Create New Streak</h2>
          <p>Choose start date, optional target days, time, and reminder/alarm option.</p>

          <form id="streakForm" class="form" novalidate>
            <div class="field">
              <label class="label" for="streakName">Streak Name</label>
              <input id="streakName" class="input" type="text" placeholder="Example: 20 min reading" maxlength="48" required />
            </div>

            <div class="two">
              <div class="field">
                <label class="label" for="targetDays">Target Days (Optional)</label>
                <input id="targetDays" class="input" type="number" min="1" max="3650" placeholder="Leave blank for open-ended streak" />
              </div>
              <div class="field">
                <label class="label" for="startDate">Start Date</label>
                <input id="startDate" class="input" type="date" required />
              </div>
            </div>

            <div class="toggle">
              <span>Enable streak reminder/alarm</span>
              <label class="switch"><input id="reminderEnabled" type="checkbox" /><span class="slider"></span></label>
            </div>

            <div id="reminderTimeField" class="field hidden">
              <label class="label" for="reminderTime">Reminder Time</label>
              <input id="reminderTime" class="time" type="time" />
            </div>

            <button class="btn btn-main" type="submit">+ Create Streak</button>
            <p id="addStatus" class="status" aria-live="polite"></p>
          </form>
        </article>
      </section>

      <section id="sectionReport" class="tab-section">
        <article class="panel">
          <h2>Total Report</h2>
          <p>Overall streak analytics across active, archived, and completed streaks.</p>
          <div id="overallReportGrid" class="report-summary-grid" aria-live="polite"></div>
        </article>

        <article class="panel">
          <h2>Particular Streak Report</h2>
          <p>Choose streak from filter and see detailed streak-wise report.</p>
          <div class="report-filter-wrap">
            <label class="label" for="reportStreakFilter">Filter Streak</label>
            <select id="reportStreakFilter" class="input report-filter-select"></select>
          </div>
          <div id="reportDetail" class="report-detail" aria-live="polite"></div>
        </article>
      </section>

      <section id="sectionProfile" class="tab-section">
        <article class="panel">
          <h2>Profile Details</h2>
          <div class="profile-row"><div class="profile-key">Name</div><div id="profileName" class="profile-value">-</div></div>
          <div class="profile-row"><div class="profile-key">Email</div><div id="profileEmail" class="profile-value">-</div></div>
          <div class="profile-row"><div class="profile-key">Active Streaks</div><div id="profileActive" class="profile-value">0</div></div>
        </article>

        <article class="panel">
          <h2>Settings</h2>
          <div class="toggle" style="margin-top: 0.62rem;">
            <span>Enable in-app reminders</span>
            <label class="switch"><input id="appReminderToggle" type="checkbox" /><span class="slider"></span></label>
          </div>

          <div class="reminder-settings-grid">
            <p class="reminder-settings-title">Advanced Reminder Logic</p>

            <div class="toggle">
              <span>Follow-up nudge (pending only)</span>
              <label class="switch"><input id="followupToggle" type="checkbox" /><span class="slider"></span></label>
            </div>
            <div class="field">
              <label class="label" for="followupDelayMinutes">Follow-up Delay (minutes)</label>
              <input id="followupDelayMinutes" class="input" type="number" min="5" max="360" step="5" />
            </div>

            <div class="toggle">
              <span>Last chance alert before day ends</span>
              <label class="switch"><input id="lastChanceToggle" type="checkbox" /><span class="slider"></span></label>
            </div>
            <div class="field">
              <label class="label" for="lastChanceTime">Daily Cutoff Time</label>
              <input id="lastChanceTime" class="time" type="time" />
            </div>

            <div class="toggle">
              <span>Streak risk alert for high streaks</span>
              <label class="switch"><input id="riskAlertToggle" type="checkbox" /><span class="slider"></span></label>
            </div>
            <div class="two">
              <div class="field">
                <label class="label" for="riskThresholdDays">Risk Threshold (days)</label>
                <input id="riskThresholdDays" class="input" type="number" min="1" max="3650" />
              </div>
              <div class="field">
                <label class="label" for="riskLeadMinutes">Risk Lead (minutes)</label>
                <input id="riskLeadMinutes" class="input" type="number" min="5" max="360" step="5" />
              </div>
            </div>

            <div class="toggle">
              <span>Weekly planning reminder (Sunday)</span>
              <label class="switch"><input id="weeklyPlanningToggle" type="checkbox" /><span class="slider"></span></label>
            </div>
            <div class="field">
              <label class="label" for="weeklyPlanningTime">Sunday Reminder Time</label>
              <input id="weeklyPlanningTime" class="time" type="time" />
            </div>

            <div class="toggle">
              <span>Quiet hours</span>
              <label class="switch"><input id="quietHoursToggle" type="checkbox" /><span class="slider"></span></label>
            </div>
            <div class="two">
              <div class="field">
                <label class="label" for="quietHoursStart">Quiet Start</label>
                <input id="quietHoursStart" class="time" type="time" />
              </div>
              <div class="field">
                <label class="label" for="quietHoursEnd">Quiet End</label>
                <input id="quietHoursEnd" class="time" type="time" />
              </div>
            </div>

            <div class="field">
              <label class="label" for="snoozeMinutesInput">Snooze Minutes</label>
              <input id="snoozeMinutesInput" class="input" type="number" min="5" max="720" step="5" />
            </div>

            <div class="reminder-actions">
              <button id="snoozeReminderBtn" class="btn btn-soft" type="button">Snooze</button>
              <button id="clearSnoozeBtn" class="btn btn-ghost" type="button">Clear Snooze</button>
            </div>

            <button id="saveReminderSettingsBtn" class="btn btn-soft" type="button" style="width: 100%;">Save Reminder Logic</button>
            <p id="reminderControlStatus" class="status reminder-control-status" aria-live="polite"></p>
            <p class="reminder-note">Follow-up, last chance, and risk alerts are sent only when that streak is still pending.</p>
          </div>

          <p id="notificationState" class="status" style="margin-top: 0.62rem;">Permission: unknown</p>
          <button id="allowNotificationBtn" class="btn btn-ghost" type="button" style="width: 100%;">Allow Notifications</button>
          <button id="testNotificationBtn" class="btn btn-soft" type="button" style="width: 100%; margin-top: 0.55rem;">Send Test Notification</button>
          <button id="profileLogoutBtn" class="btn btn-main" type="button" style="width: 100%; margin-top: 0.55rem;">Logout</button>
          <p id="profileStatus" class="status" aria-live="polite"></p>
        </article>

        <article class="panel">
          <h2>Archived Streaks</h2>
          <p>Review archived streaks and restore or delete when needed.</p>
          <div id="archiveList" class="streak-list" aria-live="polite"></div>
        </article>

        <article class="panel">
          <h2>Completed Streaks</h2>
          <p>Streaks that have reached planned target days.</p>
          <div id="completedList" class="streak-list" aria-live="polite"></div>
        </article>
      </section>
    </main>

    <div id="calendarBackdrop" class="calendar-backdrop" hidden></div>
    <article id="calendarPanel" class="calendar-sheet" aria-hidden="true">
      <div class="calendar-sheet-card">
        <div class="calendar-handle"></div>

        <div class="calendar-head">
          <button id="prevMonthBtn" class="month-nav-btn" type="button" aria-label="Previous month">&#8249;</button>
          <div class="month-wrap">
            <p id="selectedLabel" class="selected-label">Select a streak</p>
            <div id="monthLabel" class="month"></div>
          </div>
          <button id="nextMonthBtn" class="month-nav-btn" type="button" aria-label="Next month">&#8250;</button>
        </div>

        <div class="calendar-top-actions">
          <button id="todayMonthBtn" class="today-pill" type="button">Today</button>
          <button id="closeCalendarBtn" class="today-pill close-pill" type="button">Close</button>
        </div>
        <p class="calendar-scroll-hint">Swipe up/down to view full report.</p>

        <div class="weekdays">
          <div class="weekday">S</div><div class="weekday">M</div><div class="weekday">T</div><div class="weekday">W</div><div class="weekday">T</div><div class="weekday">F</div><div class="weekday">S</div>
        </div>
        <div id="calendarGrid" class="grid"></div>

        <div class="calendar-sheet-stats">
          <div class="calendar-sheet-stat">
            <p class="calendar-sheet-label">&#128293; Current Streak</p>
            <p id="calendarCurrentValue" class="calendar-sheet-value">0 Days</p>
          </div>
          <div class="calendar-sheet-divider"></div>
          <div class="calendar-sheet-stat">
            <p class="calendar-sheet-label">&#128197; Streak Duration</p>
            <p id="calendarDurationValue" class="calendar-sheet-value">0 Days</p>
          </div>
        </div>

        <section id="calendarReport" class="calendar-report" aria-live="polite">
          <div class="calendar-report-empty">Select a streak to view full report.</div>
        </section>
      </div>
    </article>

    <div id="shareBackdrop" class="share-backdrop" hidden></div>
    <article id="shareSheet" class="share-sheet" aria-hidden="true">
      <div class="share-sheet-card">
        <div class="share-handle"></div>
        <p id="shareTitle" class="share-title">Share Streak</p>
        <p id="shareSubtitle" class="share-subtitle">Share as image card or text</p>
        <div class="share-grid">
          <button type="button" class="share-btn" data-share-action="whatsapp">WhatsApp</button>
          <button type="button" class="share-btn" data-share-action="facebook">Facebook</button>
          <button type="button" class="share-btn" data-share-action="instagram">Instagram</button>
          <button type="button" class="share-btn" data-share-action="telegram">Telegram</button>
          <button type="button" class="share-btn" data-share-action="copy">Copy Text</button>
          <button type="button" class="share-btn" data-share-action="download">Download Card</button>
        </div>
        <button id="closeShareBtn" class="share-close" type="button">Close</button>
      </div>
    </article>

    <nav class="bottom" aria-label="Bottom tabs">
      <div class="bottom-grid">
        <button id="tabDashboard" class="tab-btn active" data-tab="dashboard" type="button">
          <span class="tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path class="icon-outline" d="M4 11.2L12 4l8 7.2V20H4z"></path>
              <path class="icon-fill" d="M12 3l9 8v10H3V11z"></path>
            </svg>
          </span>
          <span class="tab-label">Dashboard</span>
        </button>
        <button id="tabAdd" class="tab-btn" data-tab="add" type="button">
          <span class="tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path class="icon-outline" d="M12 5v14M5 12h14"></path>
              <path class="icon-fill" d="M12 3a9 9 0 1 1 0 18 9 9 0 0 1 0-18m-1 4v4H7v2h4v4h2v-4h4v-2h-4V7z"></path>
            </svg>
          </span>
          <span class="tab-label">Add</span>
        </button>
        <button id="tabReport" class="tab-btn" data-tab="report" type="button">
          <span class="tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path class="icon-outline" d="M4 19V8M10 19V5M16 19v-7M22 19H2"></path>
              <path class="icon-fill" d="M4 20h2V8H4zm6 0h2V5h-2zm6 0h2v-7h-2zM2 21h20v-2H2z"></path>
            </svg>
          </span>
          <span class="tab-label">Report</span>
        </button>
        <button id="tabProfile" class="tab-btn" data-tab="profile" type="button">
          <span class="tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path class="icon-outline" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm-7 8a7 7 0 0 1 14 0"></path>
              <path class="icon-fill" d="M12 3a5 5 0 1 1 0 10 5 5 0 0 1 0-10m-7.5 18a7.5 7.5 0 0 1 15 0z"></path>
            </svg>
          </span>
          <span class="tab-label">Profile</span>
        </button>
      </div>
    </nav>
    <div id="celebrationLayer" class="celebration-layer" aria-hidden="true"></div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.4/dist/confetti.browser.min.js"></script>
    <script>
      const API_ORIGIN = (() => {
        let override = "";
        try {
          override = String(
            localStorage.getItem("streak_api_origin") || window.__STREAK_API_ORIGIN || ""
          ).trim();
        } catch {
          override = String(window.__STREAK_API_ORIGIN || "").trim();
        }

        if (override) {
          return override.replace(/\/+$/, "");
        }

        const host = window.location.hostname || "localhost";
        const isLocalHost =
          host === "localhost" ||
          host === "127.0.0.1" ||
          /^10\./.test(host) ||
          /^192\.168\./.test(host) ||
          /^172\.(1[6-9]|2\d|3[0-1])\./.test(host);
        if (isLocalHost) {
          return `http://${host}:5000`;
        }
        return window.location.origin;
      })();
      const STREAKS_API = `${API_ORIGIN}/api/habits`;
      const STREAK_ARCHIVE_API = (id) => `${STREAKS_API}/${id}/archive`;
      const STREAK_UNARCHIVE_API = (id) => `${STREAKS_API}/${id}/unarchive`;
      const STREAK_DELETE_API = (id) => `${STREAKS_API}/${id}`;
      const AUTH_ME_API = `${API_ORIGIN}/api/auth/me`;
      const AUTH_LOGOUT_API = `${API_ORIGIN}/api/auth/logout`;
      const REMINDER_SETTINGS_API = `${API_ORIGIN}/api/reminders/settings`;
      const REMINDER_SNOOZE_API = `${API_ORIGIN}/api/reminders/snooze`;
      const REMINDER_TRIGGER_API = `${API_ORIGIN}/api/reminders/trigger-now`;
      const APP_REMINDER_KEY = "streak_app_reminders_enabled";
      const APP_REMINDER_SETTINGS_KEY = "streak_app_reminder_settings_v2";
      const APP_REMINDER_SNOOZE_UNTIL_KEY = "streak_app_reminder_snooze_until";
      const REMINDER_EVENT_DEDUP_MS = 45000;
      const APP_NOTIFICATION_ICON = "./assets/icons/icon-192.png";
      const APP_NOTIFICATION_BADGE = "./assets/icons/favicon-32.png";
      const APP_NOTIFICATION_IMAGE = "./assets/icons/icon-512.png";
      const DEFAULT_REMINDER_SETTINGS = Object.freeze({
        followUpEnabled: true,
        followUpDelayMinutes: 75,
        lastChanceEnabled: true,
        lastChanceTime: "22:30",
        riskAlertEnabled: true,
        riskThresholdDays: 5,
        riskLeadMinutes: 45,
        weeklyPlanningEnabled: true,
        weeklyPlanningTime: "18:00",
        quietHoursEnabled: false,
        quietHoursStart: "23:00",
        quietHoursEnd: "07:00",
        snoozeMinutes: 30,
      });
      const STREAK_NAME_MAX_LENGTH = 48;
      const STREAK_COLOR_POOL = [
        "#FF5733",
        "#33FF57",
        "#3357FF",
        "#F1C40F",
        "#8E44AD",
        "#E74C3C",
        "#2ECC71",
        "#3498DB",
        "#1ABC9C",
        "#9B59B6",
        "#34495E",
        "#16A085",
        "#27AE60",
        "#2980B9",
        "#D35400",
        "#C0392B",
        "#7F8C8D",
        "#BDC3C7",
        "#F39C12",
        "#E67E22",
        "#ECF0F1",
        "#95A5A6",
        "#FF6F61",
        "#6B5B95",
        "#88B04B",
        "#F7CAC9",
        "#92A8D1",
        "#955251",
        "#B565A7",
        "#009B77",
        "#DD4124",
        "#45B8AC",
        "#D65076",
        "#5B5EA6",
        "#9B2335",
        "#DFCFBE",
        "#55B4B0",
        "#E15D44",
        "#7FCDCD",
        "#BC243C",
        "#C3447A",
        "#98B4D4",
        "#FFB347",
        "#B39EB5",
        "#03C03C",
        "#966FD6",
        "#FF6961",
        "#AEC6CF",
        "#FDFD96",
        "#77DD77",
      ];

      const ICON_SVGS = Object.freeze({
        streak:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3c3.3 2.2 5.5 5.2 5.5 8.5A5.5 5.5 0 0 1 12 17a5.5 5.5 0 0 1-5.5-5.5C6.5 8.2 8.7 5.2 12 3z" fill="currentColor"></path><path d="M12 8.3c1.6 1.1 2.7 2.5 2.7 4a2.7 2.7 0 1 1-5.4 0c0-1.5 1.1-2.9 2.7-4z" fill="#ffffff" opacity="0.7"></path></svg>',
        calendar:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 3v3M17 3v3M4 8h16M5.5 6h13A1.5 1.5 0 0 1 20 7.5v11A1.5 1.5 0 0 1 18.5 20h-13A1.5 1.5 0 0 1 4 18.5v-11A1.5 1.5 0 0 1 5.5 6z" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"></path></svg>',
        archive:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 6h16v4H4zM6 10h12v10H6zM10 14h4" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"></path></svg>',
        restore:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8.5 10.5H4V6M4 10.5A8 8 0 1 1 10 19.8" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"></path></svg>',
        delete:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4.5 7h15M9 7V5.3c0-.7.6-1.3 1.3-1.3h3.4c.7 0 1.3.6 1.3 1.3V7M8 7l.8 11.2c.1 1 .9 1.8 2 1.8h2.4c1.1 0 1.9-.8 2-1.8L16 7" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"></path></svg>',
        archived:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 7h18v5H3zM5 12h14v8H5zM9 15h6" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"></path></svg>',
        completed:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l2.8 5.7 6.2.9-4.5 4.4 1.1 6.2L12 17.2 6.4 20.2l1.1-6.2L3 9.6l6.2-.9z" fill="currentColor"></path></svg>',
        badge:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l2.7 5.4 6 .9-4.3 4.2 1 5.9L12 16.7 6.6 19.4l1-5.9-4.3-4.2 6-.9z" fill="currentColor"></path></svg>',
        share:
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15 6l4-3m0 0v5m0-5h-5M10 14l9-9M5 12a3 3 0 1 0 0 6 3 3 0 0 0 0-6zm14 6a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"></path></svg>',
      });

      const sectionDashboard = document.getElementById("sectionDashboard");
      const sectionAdd = document.getElementById("sectionAdd");
      const sectionReport = document.getElementById("sectionReport");
      const sectionProfile = document.getElementById("sectionProfile");
      const tabDashboard = document.getElementById("tabDashboard");
      const tabAdd = document.getElementById("tabAdd");
      const tabReport = document.getElementById("tabReport");
      const tabProfile = document.getElementById("tabProfile");

      const todayLabel = document.getElementById("todayLabel");
      const welcomeName = document.getElementById("welcomeName");
      const globalStatus = document.getElementById("globalStatus");
      const addStatus = document.getElementById("addStatus");
      const profileStatus = document.getElementById("profileStatus");

      const activeCount = document.getElementById("activeCount");
      const doneTodayCount = document.getElementById("doneTodayCount");
      const bestCount = document.getElementById("bestCount");
      const activeRing = document.getElementById("activeRing");
      const doneRing = document.getElementById("doneRing");
      const bestRing = document.getElementById("bestRing");
      const activeHint = document.getElementById("activeHint");
      const doneHint = document.getElementById("doneHint");
      const plannedHint = document.getElementById("plannedHint");
      const streakList = document.getElementById("streakList");
      const archiveList = document.getElementById("archiveList");
      const completedList = document.getElementById("completedList");
      const celebrationLayer = document.getElementById("celebrationLayer");

      const monthLabel = document.getElementById("monthLabel");
      const selectedLabel = document.getElementById("selectedLabel");
      const calendarGrid = document.getElementById("calendarGrid");
      const calendarPanel = document.getElementById("calendarPanel");
      const calendarBackdrop = document.getElementById("calendarBackdrop");
      const prevMonthBtn = document.getElementById("prevMonthBtn");
      const nextMonthBtn = document.getElementById("nextMonthBtn");
      const todayMonthBtn = document.getElementById("todayMonthBtn");
      const closeCalendarBtn = document.getElementById("closeCalendarBtn");
      const calendarCurrentValue = document.getElementById("calendarCurrentValue");
      const calendarDurationValue = document.getElementById("calendarDurationValue");
      const calendarReport = document.getElementById("calendarReport");
      const overallReportGrid = document.getElementById("overallReportGrid");
      const reportStreakFilter = document.getElementById("reportStreakFilter");
      const reportDetail = document.getElementById("reportDetail");
      const shareBackdrop = document.getElementById("shareBackdrop");
      const shareSheet = document.getElementById("shareSheet");
      const closeShareBtn = document.getElementById("closeShareBtn");
      const shareTitle = document.getElementById("shareTitle");
      const shareSubtitle = document.getElementById("shareSubtitle");
      const shareStatus = document.getElementById("shareStatus");

      const streakForm = document.getElementById("streakForm");
      const streakNameInput = document.getElementById("streakName");
      const targetDaysInput = document.getElementById("targetDays");
      const startDateInput = document.getElementById("startDate");
      const reminderEnabledInput = document.getElementById("reminderEnabled");
      const reminderTimeField = document.getElementById("reminderTimeField");
      const reminderTimeInput = document.getElementById("reminderTime");

      const profileName = document.getElementById("profileName");
      const profileEmail = document.getElementById("profileEmail");
      const profileActive = document.getElementById("profileActive");
      const appReminderToggle = document.getElementById("appReminderToggle");
      const followupToggle = document.getElementById("followupToggle");
      const followupDelayMinutesInput = document.getElementById("followupDelayMinutes");
      const lastChanceToggle = document.getElementById("lastChanceToggle");
      const lastChanceTimeInput = document.getElementById("lastChanceTime");
      const riskAlertToggle = document.getElementById("riskAlertToggle");
      const riskThresholdDaysInput = document.getElementById("riskThresholdDays");
      const riskLeadMinutesInput = document.getElementById("riskLeadMinutes");
      const weeklyPlanningToggle = document.getElementById("weeklyPlanningToggle");
      const weeklyPlanningTimeInput = document.getElementById("weeklyPlanningTime");
      const quietHoursToggle = document.getElementById("quietHoursToggle");
      const quietHoursStartInput = document.getElementById("quietHoursStart");
      const quietHoursEndInput = document.getElementById("quietHoursEnd");
      const snoozeMinutesInput = document.getElementById("snoozeMinutesInput");
      const snoozeReminderBtn = document.getElementById("snoozeReminderBtn");
      const clearSnoozeBtn = document.getElementById("clearSnoozeBtn");
      const saveReminderSettingsBtn = document.getElementById("saveReminderSettingsBtn");
      const reminderControlStatus = document.getElementById("reminderControlStatus");
      const notificationState = document.getElementById("notificationState");
      const allowNotificationBtn = document.getElementById("allowNotificationBtn");
      const testNotificationBtn = document.getElementById("testNotificationBtn");
      const installBanner = document.getElementById("installBanner");
      const installAppQuickBtn = document.getElementById("installAppQuickBtn");
      const installQuickState = document.getElementById("installQuickState");
      const profileLogoutBtn = document.getElementById("profileLogoutBtn");

      let streaks = [];
      const streakThemeIndexById = new Map();
      let selectedStreakId = null;
      let reportSelectedStreakId = null;
      let currentUser = null;
      let calendarMonthCursor = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      const reminderTimers = new Map();
      const recentReminderEvents = new Map();
      let lockedBodyScrollY = 0;
      let bodyScrollLockDepth = 0;
      let shareStreakId = null;
      let shareImageDataUrl = "";
      let celebrationConfetti = null;
      let celebrationFadeTimer = null;
      let deferredInstallPromptEvent = null;
      const installMarkerStorageKey = "streakup_install_marker_v1";
      let installMarkedDone = false;

      function getToken() {
        return localStorage.getItem("streak_token") || "";
      }

      function clearSession() {
        localStorage.removeItem("streak_token");
        localStorage.removeItem("streak_user");
      }

      function redirectToLogin() {
        window.location.href = "./login.html";
      }

      function setStatus(el, message, type = "") {
        el.textContent = message;
        el.className = `status ${type}`.trim();
      }

      function setGlobalStatus(message, type = "") {
        setStatus(globalStatus, message, type);
      }

      function setAddStatus(message, type = "") {
        setStatus(addStatus, message, type);
      }

      function setProfileStatus(message, type = "") {
        setStatus(profileStatus, message, type);
      }

      function setReminderControlStatus(message, type = "") {
        if (!reminderControlStatus) {
          return;
        }
        setStatus(reminderControlStatus, message, type);
      }

      function setInstallStatus(message, type = "") {
        if (!installQuickState) {
          return;
        }
        installQuickState.textContent = String(message || "").trim();
        installQuickState.className = `install-status ${type}`.trim();
      }

      function setInstallVisibility(visible) {
        if (!installBanner) {
          return;
        }
        installBanner.hidden = !visible;
      }

      function getInstallButtons() {
        return [installAppQuickBtn].filter((button) => Boolean(button));
      }

      function readInstallMarker() {
        try {
          return localStorage.getItem(installMarkerStorageKey) === "1";
        } catch {
          return false;
        }
      }

      function writeInstallMarker(installed) {
        try {
          if (installed) {
            localStorage.setItem(installMarkerStorageKey, "1");
          } else {
            localStorage.removeItem(installMarkerStorageKey);
          }
        } catch {
          // Ignore storage failures and continue with runtime checks.
        }
      }

      function isRunningStandalone() {
        try {
          return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
        } catch {
          return false;
        }
      }

      function isIosDevice() {
        const ua = String(window.navigator.userAgent || "").toLowerCase();
        const classicIos = /iphone|ipad|ipod/.test(ua);
        const ipadOsDesktopUa = window.navigator.platform === "MacIntel" && Number(window.navigator.maxTouchPoints || 0) > 1;
        return classicIos || ipadOsDesktopUa;
      }

      function updateInstallUiState() {
        const installButtons = getInstallButtons();
        if (!installBanner || !installButtons.length) {
          return;
        }

        const runningStandalone = isRunningStandalone();
        if (runningStandalone) {
          installMarkedDone = true;
          writeInstallMarker(true);
        }

        if (runningStandalone || installMarkedDone) {
          setInstallVisibility(false);
          return;
        }

        setInstallVisibility(true);

        if (deferredInstallPromptEvent) {
          installButtons.forEach((button) => {
            button.disabled = false;
            button.textContent = "Install App";
          });
          setInstallStatus("Install is ready. Tap Install App.", "success");
          return;
        }

        if (isIosDevice()) {
          installButtons.forEach((button) => {
            button.disabled = false;
            button.textContent = "Install App";
          });
          setInstallStatus("iPhone/iPad: use Share > Add to Home Screen.", "");
          return;
        }

        installButtons.forEach((button) => {
          button.disabled = true;
          button.textContent = "Install App";
        });
        setInstallStatus("Install prompt not ready yet. Use app for a while and retry.", "");
      }

      function lockBodyScroll() {
        if (bodyScrollLockDepth > 0) {
          bodyScrollLockDepth += 1;
          return;
        }

        lockedBodyScrollY = window.scrollY || window.pageYOffset || 0;
        document.body.style.position = "fixed";
        document.body.style.top = `-${lockedBodyScrollY}px`;
        document.body.style.left = "0";
        document.body.style.right = "0";
        document.body.style.width = "100%";
        bodyScrollLockDepth = 1;
      }

      function unlockBodyScroll() {
        if (bodyScrollLockDepth < 1) {
          return;
        }
        bodyScrollLockDepth -= 1;
        if (bodyScrollLockDepth > 0) {
          return;
        }

        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.left = "";
        document.body.style.right = "";
        document.body.style.width = "";
        window.scrollTo(0, Math.max(0, lockedBodyScrollY));
      }

      function setShareStatus(message, type = "") {
        if (!shareStatus) {
          return;
        }
        shareStatus.textContent = String(message || "").trim();
        shareStatus.className = `share-status ${type}`.trim();
      }

      function getShareTargetStreak() {
        if (!shareStreakId) {
          return null;
        }
        return streaks.find((streak) => getStreakId(streak) === String(shareStreakId)) || null;
      }

      function getShareMessageText(streak) {
        const reportData = getStreakReportData(streak);
        if (!reportData) {
          return "Tracking my streak progress.";
        }

        const targetText = reportData.hasTarget
          ? `${formatDayCountLabel(reportData.doneInPlan)} / ${formatDayCountLabel(reportData.targetDays)}`
          : `${formatDayCountLabel(reportData.doneInPlan)} / Open-ended`;

        return [
          `My streak: ${streak.name || "Untitled"}`,
          `Current: ${formatDayCountLabel(reportData.currentStreak)}`,
          `Longest: ${formatDayCountLabel(reportData.longestStreak)}`,
          `Done days: ${formatDayCountLabel(reportData.totalDoneDays)}`,
          `Plan: ${targetText}`,
          `Month success: ${reportData.monthReport.successPercent}%`,
        ].join("\n");
      }

      function drawRoundedRectPath(ctx, x, y, width, height, radius) {
        const r = Math.max(0, Math.min(radius, Math.min(width, height) / 2));
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + width, y, x + width, y + height, r);
        ctx.arcTo(x + width, y + height, x, y + height, r);
        ctx.arcTo(x, y + height, x, y, r);
        ctx.arcTo(x, y, x + width, y, r);
        ctx.closePath();
      }

      function fillRoundedRect(ctx, x, y, width, height, radius, fillStyle, strokeStyle = "", lineWidth = 0) {
        drawRoundedRectPath(ctx, x, y, width, height, radius);
        if (fillStyle) {
          ctx.fillStyle = fillStyle;
          ctx.fill();
        }
        if (strokeStyle && lineWidth > 0) {
          ctx.strokeStyle = strokeStyle;
          ctx.lineWidth = lineWidth;
          ctx.stroke();
        }
      }

      function shortenText(value, maxLength = 34) {
        const text = String(value || "").trim();
        if (!text) {
          return "Untitled";
        }
        if (text.length <= maxLength) {
          return text;
        }
        return `${text.slice(0, Math.max(1, maxLength - 3))}...`;
      }

      function getFittedFontSize(ctx, text, weight, family, maxWidth, startSize, minSize = 16) {
        const content = String(text || "");
        const safeMaxWidth = Math.max(1, Number(maxWidth) || 1);
        let size = Math.max(Number(startSize) || 16, Number(minSize) || 16);
        while (size > minSize) {
          ctx.font = `${weight} ${size}px ${family}`;
          if (ctx.measureText(content).width <= safeMaxWidth) {
            return size;
          }
          size -= 1;
        }
        return Math.max(1, minSize);
      }

      function drawShareConfetti(ctx, width, seed = 0) {
        const colors = ["#20c07c", "#1f8fe5", "#f59a3f", "#ff6f91", "#7f7cff", "#f2c94c"];
        for (let i = 0; i < 46; i += 1) {
          const angle = ((i * 137.5) + (seed * 19)) * (Math.PI / 180);
          const radius = 220 + ((i * 37) % 320);
          const x = (width / 2) + (Math.cos(angle) * radius);
          const y = 100 + ((Math.sin(angle) * radius) * 0.32);
          if (y < 36 || y > 440) {
            continue;
          }

          ctx.save();
          ctx.translate(x, y);
          ctx.rotate((i * 33 + seed * 7) * (Math.PI / 180));
          ctx.fillStyle = colors[i % colors.length];
          ctx.globalAlpha = 0.24;
          fillRoundedRect(ctx, -8, -3, 16, 6, 3, ctx.fillStyle);
          ctx.restore();
        }
      }

      function drawCelebrationVector(ctx, x, y, scale = 1) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);

        ctx.fillStyle = "rgba(18, 68, 118, 0.12)";
        ctx.beginPath();
        ctx.ellipse(152, 224, 138, 26, 0, 0, Math.PI * 2);
        ctx.fill();

        const calendarGradient = ctx.createLinearGradient(64, 20, 284, 198);
        calendarGradient.addColorStop(0, "#6ed8ff");
        calendarGradient.addColorStop(1, "#2f89e0");
        fillRoundedRect(ctx, 64, 24, 220, 174, 34, calendarGradient);

        fillRoundedRect(ctx, 84, 54, 180, 124, 24, "rgba(255,255,255,0.96)");
        fillRoundedRect(ctx, 102, 8, 22, 30, 11, "#cbe8ff");
        fillRoundedRect(ctx, 182, 8, 22, 30, 11, "#cbe8ff");

        ctx.strokeStyle = "#21af74";
        ctx.lineWidth = 10;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.beginPath();
        ctx.moveTo(106, 110);
        ctx.lineTo(124, 128);
        ctx.lineTo(154, 92);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(164, 110);
        ctx.lineTo(182, 128);
        ctx.lineTo(212, 92);
        ctx.stroke();

        const flameGradient = ctx.createLinearGradient(14, 122, 98, 232);
        flameGradient.addColorStop(0, "#ffbf7a");
        flameGradient.addColorStop(1, "#ff6f45");
        ctx.fillStyle = flameGradient;
        ctx.beginPath();
        ctx.moveTo(16, 192);
        ctx.bezierCurveTo(16, 152, 46, 128, 72, 128);
        ctx.bezierCurveTo(98, 128, 128, 152, 128, 192);
        ctx.bezierCurveTo(128, 224, 101, 246, 72, 246);
        ctx.bezierCurveTo(43, 246, 16, 224, 16, 192);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = "#ffd79b";
        ctx.beginPath();
        ctx.moveTo(44, 184);
        ctx.bezierCurveTo(44, 164, 57, 142, 72, 130);
        ctx.bezierCurveTo(86, 142, 100, 164, 100, 184);
        ctx.bezierCurveTo(100, 201, 88, 214, 72, 214);
        ctx.bezierCurveTo(56, 214, 44, 201, 44, 184);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = "#17b88b";
        ctx.beginPath();
        ctx.arc(264, 28, 18, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(256, 28);
        ctx.lineTo(262, 34);
        ctx.lineTo(273, 22);
        ctx.stroke();

        const confetti = ["#ff9f43", "#21c58b", "#4c96ff", "#f86f9d"];
        for (let i = 0; i < 14; i += 1) {
          const angle = (i * 360 / 14) * (Math.PI / 180);
          const cx = 150 + Math.cos(angle) * 150;
          const cy = 110 + Math.sin(angle) * 98;
          ctx.fillStyle = confetti[i % confetti.length];
          ctx.globalAlpha = 0.38;
          fillRoundedRect(ctx, cx, cy, 9, 9, 3, ctx.fillStyle);
        }

        ctx.restore();
      }

      function drawShareMetricCard(ctx, { x, y, width, height, label, value, accentFrom, accentTo }) {
        const cardGradient = ctx.createLinearGradient(x, y, x + width, y + height);
        cardGradient.addColorStop(0, "rgba(255,255,255,0.98)");
        cardGradient.addColorStop(1, "rgba(246,252,255,0.95)");
        fillRoundedRect(ctx, x, y, width, height, 28, cardGradient, "rgba(150, 188, 215, 0.38)", 2);

        const chipGradient = ctx.createLinearGradient(x + 20, y + 16, x + 180, y + 56);
        chipGradient.addColorStop(0, accentFrom);
        chipGradient.addColorStop(1, accentTo);
        fillRoundedRect(ctx, x + 20, y + 16, 168, 34, 17, chipGradient);

        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.font = "700 17px Sora, sans-serif";
        ctx.fillText(label.toUpperCase(), x + 34, y + 39);

        ctx.fillStyle = "#103b5f";
        ctx.font = "800 44px Sora, sans-serif";
        ctx.fillText(value, x + 24, y + 112);
      }

      function makeShareCardDataUrl(streak) {
        const reportData = getStreakReportData(streak);
        if (!reportData) {
          return "";
        }

        const canvas = document.createElement("canvas");
        canvas.width = 1080;
        canvas.height = 1080;
        const ctx = canvas.getContext("2d");
        if (!ctx) {
          return "";
        }

        const streakSeed = String(getStreakId(streak) || streak?.name || "seed")
          .split("")
          .reduce((acc, char) => acc + char.charCodeAt(0), 0);

        const gradient = ctx.createLinearGradient(0, 0, 1080, 1080);
        gradient.addColorStop(0, "#daf3ff");
        gradient.addColorStop(0.45, "#ebfff4");
        gradient.addColorStop(1, "#fff1df");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 1080, 1080);

        ctx.fillStyle = "rgba(68, 127, 175, 0.14)";
        ctx.beginPath();
        ctx.ellipse(160, 100, 240, 170, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "rgba(255, 171, 94, 0.14)";
        ctx.beginPath();
        ctx.ellipse(950, 960, 260, 180, 0, 0, Math.PI * 2);
        ctx.fill();

        drawShareConfetti(ctx, canvas.width, streakSeed);

        ctx.save();
        ctx.shadowColor = "rgba(27, 84, 120, 0.18)";
        ctx.shadowBlur = 28;
        ctx.shadowOffsetY = 12;
        fillRoundedRect(ctx, 50, 52, 980, 972, 56, "rgba(255,255,255,0.90)");
        ctx.restore();
        fillRoundedRect(ctx, 50, 52, 980, 972, 56, null, "rgba(111, 154, 186, 0.26)", 3);

        const badgeGradient = ctx.createLinearGradient(96, 92, 430, 140);
        badgeGradient.addColorStop(0, "#1fa36e");
        badgeGradient.addColorStop(1, "#1686d4");
        fillRoundedRect(ctx, 96, 92, 330, 46, 23, badgeGradient);
        ctx.fillStyle = "#ffffff";
        ctx.font = "700 22px Sora, sans-serif";
        ctx.fillText("STREAK CELEBRATION", 118, 122);

        ctx.fillStyle = "#174d72";
        ctx.font = "700 34px Sora, sans-serif";
        ctx.fillText("Streak Progress Card", 96, 196);

        const maxName = shortenText(streak.name || "Untitled", 24);
        const streakNameFontSize = getFittedFontSize(
          ctx,
          maxName,
          800,
          "Sora, sans-serif",
          560,
          64,
          44
        );
        ctx.fillStyle = "#0f2f47";
        ctx.font = `800 ${streakNameFontSize}px Sora, sans-serif`;
        ctx.fillText(maxName, 96, 266, 560);

        const ownerName = shortenText(getDisplayName(), 26);
        const ownerText = `By ${ownerName}`;
        const ownerFontSize = getFittedFontSize(
          ctx,
          ownerText,
          800,
          "Sora, sans-serif",
          560,
          38,
          26
        );
        ctx.fillStyle = "#2c5f83";
        ctx.font = `800 ${ownerFontSize}px Sora, sans-serif`;
        ctx.fillText(ownerText, 96, 318, 560);

        ctx.fillStyle = "#4c6d87";
        ctx.font = "600 22px Sora, sans-serif";
        ctx.fillText(`Generated ${formatTopDate(new Date())}`, 96, 352, 560);

        drawCelebrationVector(ctx, 674, 96, 1.02);

        const cards = [
          {
            label: "Current Streak",
            value: formatDayCountLabel(reportData.currentStreak),
            x: 96,
            y: 362,
            accentFrom: "#2bb673",
            accentTo: "#1f9d8e",
          },
          {
            label: "Longest Streak",
            value: formatDayCountLabel(reportData.longestStreak),
            x: 520,
            y: 362,
            accentFrom: "#3487e6",
            accentTo: "#2f6fdb",
          },
          {
            label: "Total Done Days",
            value: formatDayCountLabel(reportData.totalDoneDays),
            x: 96,
            y: 552,
            accentFrom: "#ff9f43",
            accentTo: "#f2784b",
          },
          {
            label: "Month Success",
            value: `${reportData.monthReport.successPercent}%`,
            x: 520,
            y: 552,
            accentFrom: "#8d6be8",
            accentTo: "#4f8bff",
          },
        ];

        cards.forEach((item) => {
          drawShareMetricCard(ctx, {
            x: item.x,
            y: item.y,
            width: 392,
            height: 166,
            label: item.label,
            value: item.value,
            accentFrom: item.accentFrom,
            accentTo: item.accentTo,
          });
        });

        const planGradient = ctx.createLinearGradient(96, 678, 838, 908);
        planGradient.addColorStop(0, "rgba(255,255,255,0.99)");
        planGradient.addColorStop(1, "rgba(244,250,255,0.95)");
        fillRoundedRect(ctx, 96, 742, 744, 184, 30, planGradient, "rgba(146, 184, 210, 0.42)", 2);

        ctx.fillStyle = "#5f7890";
        ctx.font = "700 22px Sora, sans-serif";
        ctx.fillText("PLAN PROGRESS", 124, 786);

        const planText = reportData.hasTarget
          ? `${formatDayCountLabel(reportData.doneInPlan)} of ${formatDayCountLabel(reportData.targetDays)} completed`
          : `Open-ended plan, completed ${formatDayCountLabel(reportData.doneInPlan)}`;

        ctx.fillStyle = "#17405e";
        ctx.font = "700 33px Sora, sans-serif";
        ctx.fillText(planText, 124, 835, 700);

        const progressRatio = reportData.hasTarget
          ? Math.max(0, Math.min(1, reportData.progressPercent / 100))
          : Math.max(0, Math.min(1, reportData.monthReport.successPercent / 100));
        fillRoundedRect(ctx, 124, 855, 686, 18, 9, "#dce8f3");
        const progressWidth = Math.max(0, Math.round(686 * progressRatio));
        if (progressWidth > 0) {
          const progressGradient = ctx.createLinearGradient(124, 855, 124 + progressWidth, 873);
          progressGradient.addColorStop(0, "#1fb877");
          progressGradient.addColorStop(1, "#26a1d9");
          fillRoundedRect(ctx, 124, 855, progressWidth, 18, 9, progressGradient);
        }

        ctx.fillStyle = "#4d6781";
        ctx.font = "600 24px Sora, sans-serif";
        ctx.fillText(
          `Today: ${reportData.todayStatus}  |  Last done: ${reportData.lastDoneDate ? formatReadableDate(reportData.lastDoneDate) : "No logs yet"}`,
          124,
          902
        );

        const monthCardX = 848;
        const monthCardY = 742;
        const monthCardW = 186;
        const monthCardH = 184;
        fillRoundedRect(ctx, monthCardX, monthCardY, monthCardW, monthCardH, 30, "#ecf8f1", "rgba(128, 186, 150, 0.42)", 2);
        const monthPercent = Math.max(0, Math.min(100, Number(reportData.monthReport.successPercent) || 0));
        const monthRatio = monthPercent / 100;
        const ringCenterX = monthCardX + (monthCardW / 2);
        const ringCenterY = 805;
        const ringRadius = 47;
        const ringStrokeWidth = 13;
        const ringStart = -Math.PI / 2;
        const ringEnd = ringStart + (Math.PI * 2 * monthRatio);

        ctx.beginPath();
        ctx.arc(ringCenterX, ringCenterY, ringRadius, 0, Math.PI * 2);
        ctx.strokeStyle = "#cfe4d8";
        ctx.lineWidth = ringStrokeWidth;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(ringCenterX, ringCenterY, ringRadius, ringStart, ringEnd, false);
        ctx.strokeStyle = "#1ea86e";
        ctx.lineWidth = ringStrokeWidth;
        ctx.lineCap = "round";
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(ringCenterX, ringCenterY, ringRadius - (ringStrokeWidth / 2) - 2, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fill();

        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "#1a9568";
        const monthText = `${monthPercent}%`;
        const maxTextWidth = (ringRadius * 2) - (ringStrokeWidth * 2) - 8;
        const monthFontSize = getFittedFontSize(
          ctx,
          monthText,
          900,
          "Sora, sans-serif",
          maxTextWidth,
          42,
          24
        );
        ctx.font = `900 ${monthFontSize}px Sora, sans-serif`;
        ctx.fillText(monthText, ringCenterX, ringCenterY + 1);
        ctx.font = "700 22px Sora, sans-serif";
        ctx.fillStyle = "#3d6f61";
        ctx.fillText("MONTH", ringCenterX, monthCardY + 146);
        ctx.font = "700 17px Sora, sans-serif";
        ctx.fillText("SUCCESS", ringCenterX, monthCardY + 170);
        ctx.restore();

        const waveGradient = ctx.createLinearGradient(96, 930, 1030, 980);
        waveGradient.addColorStop(0, "rgba(71, 180, 138, 0.24)");
        waveGradient.addColorStop(1, "rgba(57, 148, 219, 0.22)");
        ctx.beginPath();
        ctx.moveTo(96, 954);
        ctx.bezierCurveTo(220, 928, 350, 982, 474, 956);
        ctx.bezierCurveTo(612, 928, 712, 986, 846, 955);
        ctx.bezierCurveTo(928, 936, 988, 958, 1030, 952);
        ctx.lineTo(1030, 984);
        ctx.lineTo(96, 984);
        ctx.closePath();
        ctx.fillStyle = waveGradient;
        ctx.fill();

        ctx.fillStyle = "#5d7a93";
        ctx.font = "700 22px Sora, sans-serif";
        ctx.fillText("Shared from Streak Up", 96, 972);
        ctx.fillStyle = "#7a8fa3";
        ctx.font = "700 18px Sora, sans-serif";
        ctx.fillText("Powered by Aavnik", 96, 1000);

        return canvas.toDataURL("image/png");
      }

      function dataUrlToFile(dataUrl, fileName) {
        const parts = String(dataUrl || "").split(",");
        if (parts.length !== 2) {
          return null;
        }
        const mimeMatch = /^data:(.*?);base64$/.exec(parts[0]);
        if (!mimeMatch) {
          return null;
        }
        const mime = mimeMatch[1] || "image/png";
        const binary = atob(parts[1]);
        const buffer = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
          buffer[i] = binary.charCodeAt(i);
        }
        if (typeof File === "function") {
          return new File([buffer], fileName, { type: mime });
        }
        return null;
      }

      function getSafeShareFileName(streak) {
        const raw = String(streak?.name || "streak").toLowerCase();
        const safe = raw.replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "").slice(0, 40) || "streak";
        return `${safe}-share-card.png`;
      }

      function openShareSheet(streakId) {
        const streak = streaks.find((item) => getStreakId(item) === String(streakId));
        if (!streak || !shareSheet) {
          return;
        }

        shareStreakId = String(streakId);
        shareImageDataUrl = "";
        const reportData = getStreakReportData(streak);
        if (shareTitle) {
          shareTitle.textContent = `Share: ${streak.name || "Untitled"}`;
        }
        if (shareSubtitle && reportData) {
          shareSubtitle.textContent = `${formatDayCountLabel(reportData.currentStreak)} current, ${formatDayCountLabel(reportData.longestStreak)} longest`;
        }
        setShareStatus("Choose a platform to share.");

        lockBodyScroll();
        shareSheet.classList.add("open");
        shareSheet.setAttribute("aria-hidden", "false");
        if (shareBackdrop) {
          shareBackdrop.hidden = false;
          requestAnimationFrame(() => {
            shareBackdrop.classList.add("show");
          });
        }
      }

      function closeShareSheet() {
        if (!shareSheet || !shareSheet.classList.contains("open")) {
          return;
        }

        shareSheet.classList.remove("open");
        shareSheet.setAttribute("aria-hidden", "true");
        if (shareBackdrop) {
          shareBackdrop.classList.remove("show");
          window.setTimeout(() => {
            if (!shareBackdrop.classList.contains("show")) {
              shareBackdrop.hidden = true;
            }
            unlockBodyScroll();
          }, 220);
        } else {
          unlockBodyScroll();
        }
      }

      async function getShareImageDataUrl(streak) {
        if (shareImageDataUrl) {
          return shareImageDataUrl;
        }
        shareImageDataUrl = makeShareCardDataUrl(streak);
        return shareImageDataUrl;
      }

      async function shareWithNativeApps(streak, messageText) {
        if (!navigator.share) {
          setShareStatus("Native share not supported in this browser.", "error");
          return;
        }

        try {
          const payload = {
            title: `${streak.name || "Streak"} Progress`,
            text: `${messageText}\n\n${window.location.href}`,
          };

          const dataUrl = await getShareImageDataUrl(streak);
          const file = dataUrl ? dataUrlToFile(dataUrl, getSafeShareFileName(streak)) : null;
          if (file && navigator.canShare && navigator.canShare({ files: [file] })) {
            payload.files = [file];
          }

          await navigator.share(payload);
          setShareStatus("Shared successfully.", "success");
        } catch (error) {
          if (error && error.name === "AbortError") {
            setShareStatus("Share cancelled.");
            return;
          }
          setShareStatus("Could not share right now.", "error");
        }
      }

      async function shareImageWithNativeSheet(streak, messageText) {
        if (!navigator.share) {
          return { ok: false, reason: "unsupported" };
        }

        const dataUrl = await getShareImageDataUrl(streak);
        const file = dataUrl ? dataUrlToFile(dataUrl, getSafeShareFileName(streak)) : null;
        if (!file) {
          return { ok: false, reason: "image_unavailable" };
        }

        if (!(navigator.canShare && navigator.canShare({ files: [file] }))) {
          return { ok: false, reason: "file_share_unsupported" };
        }

        try {
          await navigator.share({
            title: `${streak.name || "Streak"} Progress`,
            text: `${messageText}\n\n${window.location.href}`,
            files: [file],
          });
          return { ok: true };
        } catch (error) {
          if (error && error.name === "AbortError") {
            return { ok: false, reason: "cancelled" };
          }
          return { ok: false, reason: "failed" };
        }
      }

      async function copyShareText(text) {
        try {
          await navigator.clipboard.writeText(text);
          setShareStatus("Share text copied.", "success");
        } catch {
          const area = document.createElement("textarea");
          area.value = text;
          area.setAttribute("readonly", "true");
          area.style.position = "fixed";
          area.style.left = "-9999px";
          document.body.appendChild(area);
          area.select();
          document.execCommand("copy");
          area.remove();
          setShareStatus("Share text copied.", "success");
        }
      }

      async function downloadShareCard(streak) {
        const dataUrl = await getShareImageDataUrl(streak);
        if (!dataUrl) {
          setShareStatus("Could not generate share card image.", "error");
          return;
        }
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = getSafeShareFileName(streak);
        document.body.appendChild(link);
        link.click();
        link.remove();
        setShareStatus("Card image downloaded.", "success");
      }

      function openShareUrl(url) {
        window.open(url, "_blank", "noopener,noreferrer");
      }

      async function handleShareAction(action) {
        const streak = getShareTargetStreak();
        if (!streak) {
          setShareStatus("No streak selected for sharing.", "error");
          return;
        }

        const messageText = getShareMessageText(streak);
        const fullText = `${messageText}\n\n${window.location.href}`;

        if (action === "native") {
          await shareWithNativeApps(streak, messageText);
          return;
        }
        if (action === "copy") {
          await copyShareText(fullText);
          return;
        }
        if (action === "download") {
          await downloadShareCard(streak);
          return;
        }
        if (action === "whatsapp") {
          const imageShare = await shareImageWithNativeSheet(streak, messageText);
          if (imageShare.ok) {
            setShareStatus("Share sheet opened with image. WhatsApp select karein.", "success");
            return;
          }
          if (imageShare.reason === "cancelled") {
            setShareStatus("Share cancelled.");
            return;
          }

          await downloadShareCard(streak);
          openShareUrl(`https://wa.me/?text=${encodeURIComponent(fullText)}`);
          setShareStatus("Image downloaded. WhatsApp me image attach karke send karein.", "success");
          return;
        }
        if (action === "facebook") {
          openShareUrl(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(messageText)}`);
          setShareStatus("Opening Facebook...");
          return;
        }
        if (action === "telegram") {
          openShareUrl(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(messageText)}`);
          setShareStatus("Opening Telegram...");
          return;
        }
        if (action === "instagram") {
          await downloadShareCard(streak);
          openShareUrl("https://www.instagram.com/");
          setShareStatus("Card downloaded. Upload it on Instagram app.", "success");
        }
      }

      function animateCounterValue(element, targetValue) {
        if (!element) {
          return;
        }

        const target = Math.max(0, Number(targetValue) || 0);
        element.textContent = String(target);
        element.dataset.countValue = String(target);
      }

      function applyCardStagger(cardElement, index = 0) {
        if (!cardElement) {
          return;
        }
        const safeIndex = Number.isInteger(index) ? Math.max(0, index) : 0;
        const delay = Math.min(8, safeIndex) * 55;
        cardElement.style.setProperty("--stagger-delay", `${delay}ms`);
      }

      function createIconNode(iconName, className = "btn-icon") {
        const node = document.createElement("span");
        node.className = className;
        node.innerHTML = ICON_SVGS[iconName] || ICON_SVGS.streak;
        return node;
      }

      function setRingProgress(circle, ratio) {
        if (!circle) {
          return;
        }
        const r = Number(circle.getAttribute("r")) || 45;
        const circumference = 2 * Math.PI * r;
        circle.style.strokeDasharray = `${circumference.toFixed(3)}`;
        const safeRatio = Math.max(0, Math.min(1, Number(ratio) || 0));
        const offset = circumference * (1 - safeRatio);
        circle.style.strokeDashoffset = `${offset.toFixed(3)}`;
      }

      function createEmptyStateCard(type, message) {
        const wrapper = document.createElement("div");
        wrapper.className = "empty-state";

        const titleMap = {
          active: "No Active Streaks",
          archive: "Archive Is Empty",
          completed: "No Completed Streaks",
        };
        const artMap = {
          active: `
            <svg viewBox="0 0 120 88" aria-hidden="true">
              <rect x="11" y="42" width="98" height="34" rx="14" fill="#e9f4ff"></rect>
              <path d="M41 62c0-14 11-24 21-24s21 10 21 24c0 12-9 20-21 20s-21-8-21-20z" fill="#ff9955"></path>
              <path d="M51 53c0-7 5-13 11-17 6 4 11 10 11 17 0 5-5 9-11 9s-11-4-11-9z" fill="#ffd9aa"></path>
              <circle cx="27" cy="31" r="6" fill="#97caf4"></circle>
              <path d="M24 31h6M27 28v6" stroke="#ffffff" stroke-width="2" stroke-linecap="round"></path>
            </svg>`,
          archive: `
            <svg viewBox="0 0 120 88" aria-hidden="true">
              <rect x="16" y="24" width="88" height="20" rx="6" fill="#d7e9ff"></rect>
              <rect x="21" y="42" width="78" height="34" rx="9" fill="#ecf5ff"></rect>
              <rect x="50" y="54" width="20" height="4" rx="2" fill="#9cb8d6"></rect>
              <circle cx="90" cy="22" r="7" fill="#87d5b2"></circle>
              <path d="M86.5 22l2.2 2.3 4-4.6" stroke="#ffffff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>`,
          completed: `
            <svg viewBox="0 0 120 88" aria-hidden="true">
              <rect x="14" y="44" width="92" height="30" rx="12" fill="#fff2dc"></rect>
              <path d="M60 17l8 16 18 3-13 13 3 18-16-8-16 8 3-18-13-13 18-3z" fill="#ffbc55"></path>
              <circle cx="94" cy="26" r="6" fill="#8fd7ff"></circle>
              <path d="M91 26h6M94 23v6" stroke="#ffffff" stroke-width="2" stroke-linecap="round"></path>
            </svg>`,
        };

        const iconWrap = document.createElement("div");
        iconWrap.className = "empty-art";
        iconWrap.innerHTML = artMap[type] || artMap.active;

        const title = document.createElement("div");
        title.className = "empty-title";
        title.textContent = titleMap[type] || "Nothing Here Yet";

        const copy = document.createElement("div");
        copy.className = "empty-copy";
        copy.textContent = message;

        wrapper.appendChild(iconWrap);
        wrapper.appendChild(title);
        wrapper.appendChild(copy);
        return wrapper;
      }

      function createWeekHeatmap(streak) {
        const weekData = getWeekProgressForStreak(streak);
        const heatmap = document.createElement("div");
        heatmap.className = "week-heatmap";
        const track = document.createElement("div");
        track.className = "week-track";

        const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const statusText = {
          done: "Done",
          today: "Pending today",
          missed: "Missed",
          future: "Upcoming",
          inactive: "Outside plan",
        };

        weekData.forEach((weekDay, index) => {
          const statusClasses = new Set([weekDay.status]);
          if (weekDay.isToday) {
            statusClasses.add("today");
          }
          const className = Array.from(statusClasses).join(" ");
          const statusLabel = weekDay.isToday && weekDay.status === "done"
            ? "Done today"
            : (statusText[weekDay.status] || "Pending");

          const item = document.createElement("div");
          item.className = `week-item ${className}`.trim();

          const block = document.createElement("div");
          block.className = `week-block ${className}`.trim();
          block.style.setProperty("--week-index", String(index));
          block.setAttribute("aria-label", `${dayNames[index]}: ${statusLabel}`);
          block.title = `${dayNames[index]}: ${statusLabel}`;

          if (weekDay.status === "done") {
            const check = document.createElement("span");
            check.className = "week-check";
            check.setAttribute("aria-hidden", "true");
            check.innerHTML = '<svg viewBox="0 0 16 16"><path d="M3.1 8.4l3 3.2 6.8-7.2"></path></svg>';
            block.appendChild(check);
          } else if (weekDay.isToday) {
            const dot = document.createElement("span");
            dot.className = "week-today-dot";
            dot.setAttribute("aria-hidden", "true");
            block.appendChild(dot);
          }

          const label = document.createElement("span");
          label.className = "week-label";
          label.textContent = weekDay.label;

          item.appendChild(block);
          item.appendChild(label);
          track.appendChild(item);
        });

        heatmap.appendChild(track);
        return heatmap;
      }

      function getCelebrationConfetti() {
        if (!celebrationLayer || typeof window.confetti !== "function") {
          return null;
        }

        if (celebrationConfetti) {
          return celebrationConfetti;
        }

        let canvas = celebrationLayer.querySelector(".celebration-canvas");
        if (!canvas) {
          canvas = document.createElement("canvas");
          canvas.className = "celebration-canvas";
          celebrationLayer.appendChild(canvas);
        }

        celebrationConfetti = window.confetti.create(canvas, {
          resize: true,
          useWorker: true,
        });
        return celebrationConfetti;
      }

      function playCelebrationBurst(xPercent = 50, yPercent = 32, size = 110) {
        if (!celebrationLayer) {
          return;
        }

        const safeX = Math.max(12, Math.min(88, Number(xPercent) || 50));
        const safeY = Math.max(14, Math.min(86, Number(yPercent) || 32));
        const safeSize = Math.max(76, Math.min(170, Number(size) || 110));

        const burst = document.createElement("div");
        burst.className = "burst";
        burst.style.left = `${safeX}%`;
        burst.style.top = `${safeY}%`;
        burst.style.width = `${safeSize}px`;
        burst.style.height = `${safeSize}px`;
        burst.innerHTML = `
          <svg viewBox="0 0 120 120" aria-hidden="true">
            <circle class="burst-ring" cx="60" cy="60" r="34"></circle>
            <path class="burst-check" d="M45 61l11 11 20-23"></path>
            <rect class="burst-ray" x="57" y="10" width="6" height="16" rx="3"></rect>
            <rect class="burst-ray" x="57" y="94" width="6" height="16" rx="3"></rect>
            <rect class="burst-ray" x="94" y="57" width="16" height="6" rx="3"></rect>
            <rect class="burst-ray" x="10" y="57" width="16" height="6" rx="3"></rect>
            <rect class="burst-ray" x="84" y="23" width="6" height="14" rx="3" transform="rotate(35 87 30)"></rect>
            <rect class="burst-ray" x="30" y="83" width="6" height="14" rx="3" transform="rotate(35 33 90)"></rect>
            <rect class="burst-ray" x="83" y="82" width="6" height="14" rx="3" transform="rotate(-35 86 89)"></rect>
            <rect class="burst-ray" x="31" y="23" width="6" height="14" rx="3" transform="rotate(-35 34 30)"></rect>
          </svg>
        `;
        celebrationLayer.appendChild(burst);
        window.setTimeout(() => {
          burst.remove();
        }, 760);
      }

      function isArchivedStreak(streak) {
        return Boolean(streak?.archived);
      }

      function isCompletedStreak(streak) {
        const targetDays = Number(streak?.targetDays || 0);
        if (!Number.isInteger(targetDays) || targetDays < 1) {
          return false;
        }
        return getDoneDaysInPlan(streak) >= targetDays;
      }

      function getActiveStreaks() {
        return streaks.filter((streak) => !isArchivedStreak(streak) && !isCompletedStreak(streak));
      }

      function getArchivedStreaks() {
        return streaks.filter((streak) => isArchivedStreak(streak));
      }

      function getCompletedStreaks() {
        return streaks.filter((streak) => !isArchivedStreak(streak) && isCompletedStreak(streak));
      }

      function parseHexColor(hex) {
        const normalized = String(hex || "").trim().replace("#", "");
        if (!/^[0-9a-fA-F]{6}$/.test(normalized)) {
          return { r: 0, g: 0, b: 0 };
        }

        const value = Number.parseInt(normalized, 16);
        return {
          r: (value >> 16) & 255,
          g: (value >> 8) & 255,
          b: value & 255,
        };
      }

      function toRgba(hex, alpha = 1) {
        const { r, g, b } = parseHexColor(hex);
        const safeAlpha = Math.max(0, Math.min(1, Number(alpha) || 0));
        return `rgba(${r}, ${g}, ${b}, ${safeAlpha.toFixed(3)})`;
      }

      function mixHexColors(hexA, hexB, amount = 0.5) {
        const a = parseHexColor(hexA);
        const b = parseHexColor(hexB);
        const t = Math.max(0, Math.min(1, Number(amount) || 0));

        const r = Math.round(a.r + (b.r - a.r) * t);
        const g = Math.round(a.g + (b.g - a.g) * t);
        const bValue = Math.round(a.b + (b.b - a.b) * t);
        const toHex = (value) => value.toString(16).padStart(2, "0").toUpperCase();

        return `#${toHex(r)}${toHex(g)}${toHex(bValue)}`;
      }

      function refreshStreakThemeIndexes() {
        streakThemeIndexById.clear();

        const ids = Array.from(
          new Set(
            streaks
              .map((streak) => getStreakId(streak))
              .filter((id) => Boolean(id))
          )
        );

        ids.sort((a, b) => a.localeCompare(b));
        ids.forEach((id, index) => {
          streakThemeIndexById.set(id, index);
        });
      }

      function getCardThemeByStreak(streak) {
        const streakId = getStreakId(streak);
        const fallbackSeed = `${String(streak?.name || "").trim()}|${String(streak?.startDate || "").trim()}|${String(streak?.createdAt || "").trim()}`;
        const seed = streakId || fallbackSeed || "streak";

        let hash = 0;
        for (let i = 0; i < seed.length; i += 1) {
          hash = ((hash << 5) - hash + seed.charCodeAt(i)) | 0;
        }

        const colorIndex = streakThemeIndexById.get(streakId);
        const baseIndex = Number.isInteger(colorIndex) ? colorIndex : Math.abs(hash);
        const poolSize = STREAK_COLOR_POOL.length || 1;

        // Use user's 50-color palette in a shuffled-looking permutation.
        const primaryIndex = (baseIndex * 37 + 11) % poolSize;
        const secondaryIndex = (primaryIndex + 17) % poolSize;
        const primary = STREAK_COLOR_POOL[primaryIndex];
        const secondary = STREAK_COLOR_POOL[secondaryIndex];
        const iconColor = mixHexColors(primary, "#111111", 0.55);
        const iconInset = mixHexColors(primary, "#FFFFFF", 0.25);

        return {
          cardBg: `linear-gradient(180deg, ${toRgba(primary, 0.16)} 0%, ${toRgba(secondary, 0.11)} 100%)`,
          cardBorder: primary,
          cardShadow: `0 10px 22px ${toRgba(primary, 0.16)}`,
          iconBg: `linear-gradient(165deg, ${toRgba(primary, 0.20)} 0%, ${toRgba(secondary, 0.26)} 100%)`,
          iconColor,
          iconInset,
        };
      }

      function getDisplayName() {
        let user = currentUser;
        if (!user) {
          try {
            user = JSON.parse(localStorage.getItem("streak_user") || "{}");
          } catch {
            user = {};
          }
        }

        const byName = String(user?.name || "").trim();
        if (byName) {
          return byName;
        }

        const email = String(user?.email || "").trim();
        if (!email) {
          return "Streak Champion";
        }

        const localPart = email.split("@")[0] || "";
        return localPart || "Streak Champion";
      }

      function renderWelcome() {
        if (!welcomeName) {
          return;
        }
        welcomeName.textContent = getDisplayName();
      }

      function playCelebration(streakName = "") {
        if (celebrationLayer) {
          celebrationLayer.classList.add("active");
          if (celebrationFadeTimer) {
            window.clearTimeout(celebrationFadeTimer);
          }
          celebrationFadeTimer = window.setTimeout(() => {
            celebrationLayer.classList.remove("active");
            celebrationFadeTimer = null;
          }, 1600);
        }

        playCelebrationBurst(50, 28, 124);
        playCelebrationBurst(24, 40, 94);
        playCelebrationBurst(76, 40, 94);

        if (navigator.vibrate) {
          navigator.vibrate([35, 24, 46]);
        }

        const fireConfetti = getCelebrationConfetti();
        if (!fireConfetti) {
          return;
        }

        const colors = ["#22c55e", "#06b6d4", "#f59e0b", "#fb7185", "#10b981"];
        const defaults = {
          startVelocity: 24,
          spread: 110,
          ticks: 220,
          gravity: 0.84,
          scalar: 1.02,
          colors,
          disableForReducedMotion: true,
        };

        fireConfetti({
          ...defaults,
          particleCount: 96,
          angle: 62,
          origin: { x: 0.02, y: 0.86 },
        });
        fireConfetti({
          ...defaults,
          particleCount: 96,
          angle: 118,
          origin: { x: 0.98, y: 0.86 },
        });
        fireConfetti({
          ...defaults,
          particleCount: 80,
          angle: 90,
          spread: 130,
          origin: { x: 0.5, y: 0.2 },
        });
        window.setTimeout(() => {
          fireConfetti({
            ...defaults,
            particleCount: 68,
            startVelocity: 20,
            spread: 140,
            origin: { x: 0.5, y: 0.52 },
          });
        }, 170);
      }

      function getStreakId(streak) {
        return streak && streak.id !== undefined && streak.id !== null ? String(streak.id) : "";
      }

      function formatLocalDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function normalizeYmdInput(value) {
        const raw = String(value || "").trim();
        if (/^\d{4}-\d{2}-\d{2}T/.test(raw)) {
          return raw.slice(0, 10);
        }
        return raw;
      }

      function parseDateFromYmd(ymd) {
        const normalized = normalizeYmdInput(ymd);
        const match = /^(\d{4})-(\d{2})-(\d{2})$/.exec(normalized);
        if (!match) {
          return null;
        }
        const date = new Date(Number(match[1]), Number(match[2]) - 1, Number(match[3]));
        if (formatLocalDate(date) !== `${match[1]}-${match[2]}-${match[3]}`) {
          return null;
        }
        return date;
      }

      function normalizeLogDayValue(value) {
        const normalized = normalizeYmdInput(value);
        const parsed = parseDateFromYmd(normalized);
        return parsed ? formatLocalDate(parsed) : "";
      }

      function getNormalizedLogArray(streak) {
        const rawLogs = Array.isArray(streak?.logs) ? streak.logs : [];
        const normalized = rawLogs
          .map((day) => normalizeLogDayValue(day))
          .filter((day) => Boolean(day));
        return Array.from(new Set(normalized)).sort();
      }

      function getNormalizedLogSet(streak) {
        return new Set(getNormalizedLogArray(streak));
      }

      function getReportDateRange(streak) {
        const start = getStartDate(streak);
        const today = getTodayDateString();
        const planEnd = getEndDate(streak);
        const end = planEnd && planEnd < today ? planEnd : today;
        return { start, end, today, planEnd };
      }

      function getReportLogSet(streak) {
        const { start, end } = getReportDateRange(streak);
        const logs = getNormalizedLogArray(streak);
        const filtered = logs.filter((day) => day >= start && day <= end);
        return new Set(filtered);
      }

      function getTodayDateString() {
        return formatLocalDate(new Date());
      }

      function formatTopDate(date) {
        return new Intl.DateTimeFormat("en-US", {
          weekday: "long",
          month: "long",
          day: "numeric",
          year: "numeric",
        }).format(date);
      }

      function formatMonthLabel(date) {
        return new Intl.DateTimeFormat("en-US", {
          month: "long",
          year: "numeric",
        }).format(date);
      }

      function formatReadableDate(ymd) {
        const parsed = parseDateFromYmd(ymd);
        if (!parsed) {
          return ymd || "-";
        }
        return new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        }).format(parsed);
      }

      function isAppReminderEnabled() {
        return localStorage.getItem(APP_REMINDER_KEY) !== "0";
      }

      function setAppReminderEnabled(value) {
        localStorage.setItem(APP_REMINDER_KEY, value ? "1" : "0");
      }

      function clampInteger(value, min, max, fallback) {
        const parsed = Number(value);
        if (!Number.isFinite(parsed)) {
          return fallback;
        }
        const rounded = Math.round(parsed);
        if (rounded < min || rounded > max) {
          return fallback;
        }
        return rounded;
      }

      function parseTimeParts(value) {
        const raw = String(value || "").trim();
        const match = /^([01]\d|2[0-3]):([0-5]\d)$/.exec(raw);
        if (!match) {
          return null;
        }
        return {
          hour: Number(match[1]),
          minute: Number(match[2]),
        };
      }

      function sanitizeReminderSettings(value = {}) {
        const safe = value && typeof value === "object" ? value : {};

        const followUpEnabled = safe.followUpEnabled !== undefined
          ? Boolean(safe.followUpEnabled)
          : DEFAULT_REMINDER_SETTINGS.followUpEnabled;
        const followUpDelayMinutes = clampInteger(
          safe.followUpDelayMinutes,
          5,
          360,
          DEFAULT_REMINDER_SETTINGS.followUpDelayMinutes
        );

        const lastChanceEnabled = safe.lastChanceEnabled !== undefined
          ? Boolean(safe.lastChanceEnabled)
          : DEFAULT_REMINDER_SETTINGS.lastChanceEnabled;
        const lastChanceTime = parseTimeParts(safe.lastChanceTime)
          ? String(safe.lastChanceTime)
          : DEFAULT_REMINDER_SETTINGS.lastChanceTime;

        const riskAlertEnabled = safe.riskAlertEnabled !== undefined
          ? Boolean(safe.riskAlertEnabled)
          : DEFAULT_REMINDER_SETTINGS.riskAlertEnabled;
        const riskThresholdDays = clampInteger(
          safe.riskThresholdDays,
          1,
          3650,
          DEFAULT_REMINDER_SETTINGS.riskThresholdDays
        );
        const riskLeadMinutes = clampInteger(
          safe.riskLeadMinutes,
          5,
          360,
          DEFAULT_REMINDER_SETTINGS.riskLeadMinutes
        );

        const weeklyPlanningEnabled = safe.weeklyPlanningEnabled !== undefined
          ? Boolean(safe.weeklyPlanningEnabled)
          : DEFAULT_REMINDER_SETTINGS.weeklyPlanningEnabled;
        const weeklyPlanningTime = parseTimeParts(safe.weeklyPlanningTime)
          ? String(safe.weeklyPlanningTime)
          : DEFAULT_REMINDER_SETTINGS.weeklyPlanningTime;

        const quietHoursEnabled = safe.quietHoursEnabled !== undefined
          ? Boolean(safe.quietHoursEnabled)
          : DEFAULT_REMINDER_SETTINGS.quietHoursEnabled;
        const quietHoursStart = parseTimeParts(safe.quietHoursStart)
          ? String(safe.quietHoursStart)
          : DEFAULT_REMINDER_SETTINGS.quietHoursStart;
        const quietHoursEnd = parseTimeParts(safe.quietHoursEnd)
          ? String(safe.quietHoursEnd)
          : DEFAULT_REMINDER_SETTINGS.quietHoursEnd;

        const snoozeMinutes = clampInteger(
          safe.snoozeMinutes,
          5,
          720,
          DEFAULT_REMINDER_SETTINGS.snoozeMinutes
        );

        return {
          followUpEnabled,
          followUpDelayMinutes,
          lastChanceEnabled,
          lastChanceTime,
          riskAlertEnabled,
          riskThresholdDays,
          riskLeadMinutes,
          weeklyPlanningEnabled,
          weeklyPlanningTime,
          quietHoursEnabled,
          quietHoursStart,
          quietHoursEnd,
          snoozeMinutes,
        };
      }

      function getReminderSettings() {
        try {
          const raw = localStorage.getItem(APP_REMINDER_SETTINGS_KEY);
          if (!raw) {
            return sanitizeReminderSettings(DEFAULT_REMINDER_SETTINGS);
          }
          return sanitizeReminderSettings(JSON.parse(raw));
        } catch {
          return sanitizeReminderSettings(DEFAULT_REMINDER_SETTINGS);
        }
      }

      function setReminderSettings(value) {
        const sanitized = sanitizeReminderSettings(value);
        localStorage.setItem(APP_REMINDER_SETTINGS_KEY, JSON.stringify(sanitized));
        return sanitized;
      }

      function getSnoozeUntilTimestamp() {
        const parsed = Number(localStorage.getItem(APP_REMINDER_SNOOZE_UNTIL_KEY) || 0);
        if (!Number.isFinite(parsed) || parsed <= Date.now()) {
          localStorage.removeItem(APP_REMINDER_SNOOZE_UNTIL_KEY);
          return 0;
        }
        return parsed;
      }

      function setSnoozeUntilTimestamp(value) {
        const next = Number(value);
        if (!Number.isFinite(next) || next <= Date.now()) {
          localStorage.removeItem(APP_REMINDER_SNOOZE_UNTIL_KEY);
          return 0;
        }
        localStorage.setItem(APP_REMINDER_SNOOZE_UNTIL_KEY, String(Math.floor(next)));
        return Math.floor(next);
      }

      function clearReminderSnooze() {
        localStorage.removeItem(APP_REMINDER_SNOOZE_UNTIL_KEY);
      }

      function formatReminderDateTime(timestamp) {
        const date = new Date(Number(timestamp) || Date.now());
        return new Intl.DateTimeFormat("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
        }).format(date);
      }

      function getDateMinutes(date) {
        return date.getHours() * 60 + date.getMinutes();
      }

      function isAlwaysQuiet(settings) {
        const start = parseTimeParts(settings.quietHoursStart);
        const end = parseTimeParts(settings.quietHoursEnd);
        if (!start || !end) {
          return false;
        }
        return start.hour === end.hour && start.minute === end.minute;
      }

      function isInsideQuietHours(date, settings) {
        if (!settings.quietHoursEnabled) {
          return false;
        }

        const start = parseTimeParts(settings.quietHoursStart);
        const end = parseTimeParts(settings.quietHoursEnd);
        if (!start || !end) {
          return false;
        }

        if (start.hour === end.hour && start.minute === end.minute) {
          return true;
        }

        const current = getDateMinutes(date);
        const startMinutes = start.hour * 60 + start.minute;
        const endMinutes = end.hour * 60 + end.minute;
        if (startMinutes < endMinutes) {
          return current >= startMinutes && current < endMinutes;
        }
        return current >= startMinutes || current < endMinutes;
      }

      function getQuietHoursEndDate(date, settings) {
        const end = parseTimeParts(settings.quietHoursEnd);
        const start = parseTimeParts(settings.quietHoursStart);
        if (!start || !end) {
          return new Date(date);
        }

        const next = new Date(date);
        const current = getDateMinutes(date);
        const startMinutes = start.hour * 60 + start.minute;
        const endMinutes = end.hour * 60 + end.minute;

        if (startMinutes < endMinutes) {
          next.setHours(end.hour, end.minute, 0, 0);
          if (current >= endMinutes) {
            next.setDate(next.getDate() + 1);
          }
          return next;
        }

        if (current >= startMinutes) {
          next.setDate(next.getDate() + 1);
          next.setHours(end.hour, end.minute, 0, 0);
          return next;
        }

        next.setHours(end.hour, end.minute, 0, 0);
        return next;
      }

      function applyReminderRuntimeGates(targetDate, settings, options = {}) {
        const {
          allowQuietShift = true,
          preserveDate = false,
          sourceDateStr = "",
        } = options;

        let adjusted = new Date(targetDate);

        const snoozeUntil = getSnoozeUntilTimestamp();
        if (snoozeUntil && adjusted.getTime() < snoozeUntil) {
          adjusted = new Date(snoozeUntil);
        }

        if (settings.quietHoursEnabled) {
          if (isAlwaysQuiet(settings)) {
            return null;
          }

          if (allowQuietShift) {
            let guard = 0;
            while (isInsideQuietHours(adjusted, settings) && guard < 4) {
              adjusted = getQuietHoursEndDate(adjusted, settings);
              guard += 1;
            }
            if (isInsideQuietHours(adjusted, settings)) {
              return null;
            }
          } else if (isInsideQuietHours(adjusted, settings)) {
            return null;
          }
        }

        if (preserveDate && sourceDateStr && formatLocalDate(adjusted) !== sourceDateStr) {
          return null;
        }

        return adjusted;
      }

      function isStreakDateInPlan(streak, dateStr) {
        const startDate = getStartDate(streak);
        const endDate = getEndDate(streak);
        if (dateStr < startDate) {
          return false;
        }
        if (endDate && dateStr > endDate) {
          return false;
        }
        return true;
      }

      function getDateAtTime(date, timeValue) {
        const parts = parseTimeParts(timeValue);
        if (!parts) {
          return null;
        }
        return new Date(date.getFullYear(), date.getMonth(), date.getDate(), parts.hour, parts.minute, 0, 0);
      }

      function getFollowUpDateAt(date, reminderTime, delayMinutes) {
        const base = getDateAtTime(date, reminderTime);
        if (!base) {
          return null;
        }
        const sourceDateStr = formatLocalDate(date);
        base.setMinutes(base.getMinutes() + delayMinutes);
        if (formatLocalDate(base) !== sourceDateStr) {
          return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 55, 0, 0);
        }
        return base;
      }

      function getRiskAlertDateAt(date, cutoffTime, leadMinutes) {
        const cutoffDate = getDateAtTime(date, cutoffTime);
        if (!cutoffDate) {
          return null;
        }
        cutoffDate.setMinutes(cutoffDate.getMinutes() - leadMinutes);
        const sourceDateStr = formatLocalDate(date);
        if (formatLocalDate(cutoffDate) !== sourceDateStr) {
          return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 5, 0, 0);
        }
        return cutoffDate;
      }

      function findNextStreakEventTime(streak, buildDateForDay, now, settings, options = {}) {
        const todayStr = getTodayDateString();
        const todayDate = parseDateFromYmd(todayStr)
          || new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const logs = getNormalizedLogSet(streak);

        for (let offset = 0; offset <= 21; offset += 1) {
          const dayDate = new Date(todayDate);
          dayDate.setDate(todayDate.getDate() + offset);
          const dayStr = formatLocalDate(dayDate);

          if (!isStreakDateInPlan(streak, dayStr)) {
            continue;
          }
          if (logs.has(dayStr)) {
            continue;
          }

          const rawTarget = buildDateForDay(dayDate, dayStr);
          if (!rawTarget) {
            continue;
          }

          const adjustedTarget = applyReminderRuntimeGates(rawTarget, settings, {
            allowQuietShift: options.allowQuietShift !== false,
            preserveDate: options.preserveDate !== false,
            sourceDateStr: dayStr,
          });
          if (!adjustedTarget) {
            continue;
          }
          if (adjustedTarget.getTime() <= now.getTime()) {
            continue;
          }

          return { time: adjustedTarget, dayStr };
        }

        return null;
      }

      function pruneRecentReminderEvents() {
        const now = Date.now();
        recentReminderEvents.forEach((timestamp, key) => {
          if (now - timestamp > REMINDER_EVENT_DEDUP_MS) {
            recentReminderEvents.delete(key);
          }
        });
      }

      function wasReminderEventRecentlySent(eventKey) {
        pruneRecentReminderEvents();
        const last = recentReminderEvents.get(eventKey);
        return Number.isFinite(last) && Date.now() - last < REMINDER_EVENT_DEDUP_MS;
      }

      function markReminderEventSent(eventKey) {
        recentReminderEvents.set(eventKey, Date.now());
      }

      async function showRichNotification(title, body, options = {}) {
        if (!("Notification" in window) || Notification.permission !== "granted") {
          return false;
        }

        const config = options && typeof options === "object" ? options : {};
        const resolvedTitle = String(title || "Streak Up").trim() || "Streak Up";
        const resolvedBody = String(body || "").trim();
        const resolvedTag = String(config.tag || "streak-reminder").trim() || "streak-reminder";
        const resolvedUrl = String(config.url || "./dashboard.html").trim() || "./dashboard.html";

        const notificationOptions = {
          body: resolvedBody,
          icon: APP_NOTIFICATION_ICON,
          badge: APP_NOTIFICATION_BADGE,
          image: APP_NOTIFICATION_IMAGE,
          tag: resolvedTag,
          renotify: true,
          requireInteraction: Boolean(config.requireInteraction),
          timestamp: Date.now(),
          actions: [
            { action: "open_dashboard", title: "Open App" },
            { action: "view_streak", title: "View Streak" },
          ],
          data: {
            url: resolvedUrl,
            streakId: config.streakId ? String(config.streakId) : "",
            dayStr: config.dayStr ? String(config.dayStr) : "",
            eventType: config.eventType ? String(config.eventType) : "general",
          },
        };

        if (Array.isArray(config.vibratePattern) && config.vibratePattern.length) {
          notificationOptions.vibrate = config.vibratePattern;
        }

        if ("serviceWorker" in navigator) {
          try {
            const registration = await navigator.serviceWorker.ready;
            await registration.showNotification(resolvedTitle, notificationOptions);
            return true;
          } catch (error) {
            console.warn("Service worker notification failed:", error);
          }
        }

        try {
          new Notification(resolvedTitle, notificationOptions);
          return true;
        } catch {
          return false;
        }
      }

      function notifyReminder(title, body, vibratePattern = null, options = {}) {
        const mergedOptions = {
          ...(options && typeof options === "object" ? options : {}),
          vibratePattern: Array.isArray(vibratePattern) ? vibratePattern : undefined,
        };

        showRichNotification(title, body, mergedOptions)
          .then((shown) => {
            if (!shown) {
              setGlobalStatus(`${title}: ${body}`, "success");
            }
          })
          .catch(() => {
            setGlobalStatus(`${title}: ${body}`, "success");
          });
      }

      async function apiRequest(url, options = {}) {
        const token = getToken();
        if (!token) {
          redirectToLogin();
          throw new Error("No session found");
        }

        const response = await fetch(url, {
          ...options,
          headers: {
            ...(options.headers || {}),
            Authorization: `Bearer ${token}`,
          },
        });

        let data = {};
        try {
          data = await response.json();
        } catch {
          data = {};
        }

        if (response.status === 401) {
          clearSession();
          redirectToLogin();
          throw new Error("Session expired. Please login again.");
        }

        if (!response.ok) {
          throw new Error(data.error || data.message || "Request failed");
        }

        return data;
      }

      function getStartDate(streak) {
        const startDateRaw = String(streak?.startDate || "").trim();
        const parsedStartDate = parseDateFromYmd(startDateRaw);
        if (startDateRaw && parsedStartDate) {
          return formatLocalDate(parsedStartDate);
        }

        if (streak && streak.createdAt) {
          const created = new Date(streak.createdAt);
          if (!Number.isNaN(created.getTime())) {
            return formatLocalDate(created);
          }
        }

        return getTodayDateString();
      }

      function getEndDate(streak) {
        const targetDays = Number(streak?.targetDays || 0);
        if (!Number.isInteger(targetDays) || targetDays < 1) {
          return "";
        }

        const startDate = parseDateFromYmd(getStartDate(streak));
        if (!startDate) {
          return "";
        }

        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + targetDays - 1);
        return formatLocalDate(endDate);
      }

      function getElapsedDurationDays(streak) {
        const startStr = getStartDate(streak);
        const todayStr = getTodayDateString();
        const endStr = getEndDate(streak);

        const effectiveEndStr = endStr && endStr < todayStr ? endStr : todayStr;
        const startDate = parseDateFromYmd(startStr);
        const effectiveEndDate = parseDateFromYmd(effectiveEndStr);
        if (!startDate || !effectiveEndDate || effectiveEndDate < startDate) {
          return 0;
        }

        const startUtc = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
        const endUtc = Date.UTC(effectiveEndDate.getFullYear(), effectiveEndDate.getMonth(), effectiveEndDate.getDate());
        const msPerDay = 24 * 60 * 60 * 1000;
        return Math.floor((endUtc - startUtc) / msPerDay) + 1;
      }

      function getStreakDurationDays(streak) {
        const targetDays = Number(streak?.targetDays || 0);
        if (Number.isInteger(targetDays) && targetDays > 0) {
          return targetDays;
        }
        return getElapsedDurationDays(streak);
      }

      function getDoneDaysInPlan(streak) {
        return getReportLogSet(streak).size;
      }

      function getSelectedStreak() {
        const selected = streaks.find((s) => getStreakId(s) === String(selectedStreakId));
        if (selected) {
          return selected;
        }
        if (!streaks.length) {
          return null;
        }
        selectedStreakId = getStreakId(streaks[0]);
        return streaks[0];
      }

      function syncCalendarStreakSelect() {
        if (!streaks.length) {
          selectedStreakId = null;
          return;
        }

        const hasSelected = streaks.some((s) => getStreakId(s) === String(selectedStreakId));
        if (!hasSelected) {
          selectedStreakId = getStreakId(streaks[0]);
        }
      }

      function getDayStatus(dateStr, streak) {
        const logs = getNormalizedLogArray(streak);
        const today = getTodayDateString();
        const startDate = getStartDate(streak);
        const endDate = getEndDate(streak);

        if (dateStr < startDate) {
          return "inactive";
        }
        if (endDate && dateStr > endDate) {
          return "after";
        }
        if (dateStr > today) {
          return "future";
        }
        if (logs.includes(dateStr)) {
          return "done";
        }
        return "missed";
      }

      function formatDayCountLabel(value) {
        const safeValue = Math.max(0, Number(value) || 0);
        return `${safeValue} ${safeValue === 1 ? "Day" : "Days"}`;
      }

      function getLastDoneDate(streak) {
        const logs = Array.from(getReportLogSet(streak)).sort();
        return logs.length ? logs[logs.length - 1] : "";
      }

      function getCurrentMonthReport(streak) {
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const todayStr = getTodayDateString();
        const todayDate = parseDateFromYmd(todayStr);
        const startDate = parseDateFromYmd(getStartDate(streak));
        const endDateStr = getEndDate(streak);
        const logs = getReportLogSet(streak);

        const lastDay = todayDate ? todayDate.getDate() : monthEnd.getDate();
        let doneDays = 0;
        let missedDays = 0;

        for (let day = 1; day <= lastDay; day += 1) {
          const date = new Date(now.getFullYear(), now.getMonth(), day);
          const dateStr = formatLocalDate(date);

          if (startDate && date < startDate) {
            continue;
          }
          if (endDateStr && dateStr > endDateStr) {
            continue;
          }

          const isToday = dateStr === todayStr;
          if (logs.has(dateStr)) {
            doneDays += 1;
          } else if (!isToday) {
            missedDays += 1;
          }
        }

        const trackedDays = doneDays + missedDays;
        const successPercent = trackedDays ? Math.round((doneDays / trackedDays) * 100) : 0;

        return {
          label: formatMonthLabel(monthStart),
          doneDays,
          missedDays,
          successPercent,
        };
      }

      function getLastSevenDayTimeline(streak) {
        const todayStr = getTodayDateString();
        const todayDate = parseDateFromYmd(todayStr);
        const startDate = parseDateFromYmd(getStartDate(streak));
        const endDateStr = getEndDate(streak);
        const logs = getNormalizedLogSet(streak);

        if (!todayDate) {
          return [];
        }

        return Array.from({ length: 7 }, (_, index) => {
          const offset = 6 - index;
          const date = new Date(todayDate);
          date.setDate(todayDate.getDate() - offset);
          const dateStr = formatLocalDate(date);
          const isToday = dateStr === todayStr;

          let status = "missed";
          if (startDate && date < startDate) {
            status = "inactive";
          } else if (endDateStr && dateStr > endDateStr) {
            status = "inactive";
          } else if (logs.has(dateStr)) {
            status = "done";
          } else if (isToday) {
            status = "pending";
          }

          return {
            dateStr,
            dayLabel: new Intl.DateTimeFormat("en-US", { weekday: "narrow" }).format(date),
            status,
            isToday,
          };
        });
      }

      function getStreakReportData(streak) {
        if (!streak) {
          return null;
        }

        const today = getTodayDateString();
        const logs = getReportLogSet(streak);
        const totalDoneDays = logs.size;
        const currentStreak = Math.max(0, Number(streak.currentStreak || 0));
        const longestStreak = Math.max(0, Number(streak.longestStreak || 0));
        const streakDuration = getStreakDurationDays(streak);
        const targetDays = Number(streak.targetDays || 0);
        const hasTarget = Number.isInteger(targetDays) && targetDays > 0;
        const rawDoneInPlan = getDoneDaysInPlan(streak);
        const doneInPlan = hasTarget ? Math.min(rawDoneInPlan, targetDays) : rawDoneInPlan;
        const remainingDays = hasTarget ? Math.max(0, targetDays - doneInPlan) : 0;
        const progressPercent = hasTarget ? Math.round((doneInPlan / Math.max(1, targetDays)) * 100) : 0;
        const monthReport = getCurrentMonthReport(streak);
        const timeline = getLastSevenDayTimeline(streak);
        const todayStatus = logs.has(today) ? "Done" : "Pending";
        const lastDoneDate = getLastDoneDate(streak);
        const reminderOn = Boolean(streak.reminderEnabled && streak.reminderTime);
        const reminderStatus = reminderOn ? `On (${streak.reminderTime})` : "Off";

        return {
          totalDoneDays,
          currentStreak,
          longestStreak,
          streakDuration,
          targetDays,
          hasTarget,
          doneInPlan,
          remainingDays,
          progressPercent,
          monthReport,
          timeline,
          todayStatus,
          lastDoneDate,
          reminderStatus,
        };
      }

      function getTimelineMarkup(timeline) {
        const timelineBadge = {
          done: { icon: "&#10003;", label: "Done" },
          missed: { icon: "!", label: "Missed" },
          pending: { icon: "&#8226;", label: "Pending" },
          inactive: { icon: "-", label: "Inactive" },
        };

        return timeline
          .map((item) => {
            const badge = timelineBadge[item.status] || timelineBadge.pending;
            const stateClass = `${item.status}${item.isToday ? " today" : ""}`;
            return `
              <div class="timeline-pill ${stateClass}" title="${formatReadableDate(item.dateStr)}: ${badge.label}">
                <span class="timeline-dot">${badge.icon}</span>
                <span class="timeline-day">${item.dayLabel}</span>
              </div>
            `;
          })
          .join("");
      }

      function buildStreakReportMarkup(streak, options = {}) {
        const reportData = getStreakReportData(streak);
        if (!reportData) {
          return '<div class="calendar-report-empty">No streak selected.</div>';
        }

        const title = String(options.title || "Streak Report").trim();
        const subText = String(options.subText || reportData.monthReport.label).trim();
        const showLegend = options.showLegend !== false;
        const timelineHtml = getTimelineMarkup(reportData.timeline);

        return `
          <div class="calendar-report-head">
            <p class="calendar-report-title">${title}</p>
            <p class="calendar-report-sub">${subText}</p>
          </div>

          <div class="calendar-report-grid">
            <div class="calendar-report-card">
              <p class="calendar-report-key">Current Streak</p>
              <p class="calendar-report-value">${formatDayCountLabel(reportData.currentStreak)}</p>
            </div>
            <div class="calendar-report-card">
              <p class="calendar-report-key">Longest Streak</p>
              <p class="calendar-report-value">${formatDayCountLabel(reportData.longestStreak)}</p>
            </div>
            <div class="calendar-report-card">
              <p class="calendar-report-key">Total Done Days</p>
              <p class="calendar-report-value">${formatDayCountLabel(reportData.totalDoneDays)}</p>
            </div>
            <div class="calendar-report-card">
              <p class="calendar-report-key">Streak Duration</p>
              <p class="calendar-report-value">${formatDayCountLabel(reportData.streakDuration)}</p>
            </div>
          </div>

          <div class="calendar-report-block">
            <p class="calendar-report-block-title">Plan Progress</p>
            <ul class="calendar-report-list">
              <li><span>Target days</span><strong>${reportData.hasTarget ? formatDayCountLabel(reportData.targetDays) : "Open-ended"}</strong></li>
              <li><span>Done in plan</span><strong>${formatDayCountLabel(reportData.doneInPlan)}</strong></li>
              <li><span>Remaining days</span><strong>${reportData.hasTarget ? formatDayCountLabel(reportData.remainingDays) : "--"}</strong></li>
              <li><span>Progress %</span><strong>${reportData.hasTarget ? `${reportData.progressPercent}%` : "--"}</strong></li>
            </ul>
          </div>

          <div class="calendar-report-block">
            <p class="calendar-report-block-title">This Month Report</p>
            <ul class="calendar-report-list">
              <li><span>Done days</span><strong>${formatDayCountLabel(reportData.monthReport.doneDays)}</strong></li>
              <li><span>Missed days</span><strong>${formatDayCountLabel(reportData.monthReport.missedDays)}</strong></li>
              <li><span>Monthly success %</span><strong>${reportData.monthReport.successPercent}%</strong></li>
            </ul>
          </div>

          <div class="calendar-report-block">
            <p class="calendar-report-block-title">Last 7 Days Timeline</p>
            <div class="calendar-report-timeline">${timelineHtml}</div>
            ${showLegend ? '<p class="calendar-report-note">Green tick = done, red = missed, gray = pending.</p>' : ""}
          </div>

          <div class="calendar-report-block">
            <p class="calendar-report-block-title">Status</p>
            <ul class="calendar-report-list">
              <li><span>Today Status</span><strong>${reportData.todayStatus}</strong></li>
              <li><span>Last Done Date</span><strong>${reportData.lastDoneDate ? formatReadableDate(reportData.lastDoneDate) : "No logs yet"}</strong></li>
              <li><span>Reminder Status</span><strong>${reportData.reminderStatus}</strong></li>
            </ul>
          </div>
        `;
      }

      function getStreakStateLabel(streak) {
        if (isArchivedStreak(streak)) {
          return "Archived";
        }
        if (isCompletedStreak(streak)) {
          return "Completed";
        }
        return "Active";
      }

      function syncReportFilterOptions() {
        if (!reportStreakFilter) {
          return;
        }

        reportStreakFilter.innerHTML = "";

        if (!streaks.length) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No streaks available";
          reportStreakFilter.appendChild(option);
          reportStreakFilter.disabled = true;
          reportSelectedStreakId = null;
          return;
        }

        reportStreakFilter.disabled = false;
        const hasSelected = streaks.some((streak) => getStreakId(streak) === String(reportSelectedStreakId));
        if (!hasSelected) {
          reportSelectedStreakId = getStreakId(streaks[0]);
        }

        streaks.forEach((streak) => {
          const option = document.createElement("option");
          option.value = getStreakId(streak);
          option.textContent = `${streak.name || "Untitled"} (${getStreakStateLabel(streak)})`;
          reportStreakFilter.appendChild(option);
        });

        reportStreakFilter.value = String(reportSelectedStreakId);
      }

      function getOverallReportData() {
        const reports = streaks
          .map((streak) => ({ streak, report: getStreakReportData(streak) }))
          .filter((entry) => Boolean(entry.report));

        const totalStreaks = reports.length;
        const activeCount = getActiveStreaks().length;
        const completedCount = getCompletedStreaks().length;
        const archivedCount = getArchivedStreaks().length;
        const doneTodayCount = reports.filter((entry) => entry.report.todayStatus === "Done").length;
        const totalDoneDays = reports.reduce((sum, entry) => sum + entry.report.totalDoneDays, 0);
        const longestOverall = reports.reduce((max, entry) => Math.max(max, entry.report.longestStreak), 0);
        const remindersOn = reports.filter((entry) => Boolean(entry.streak.reminderEnabled && entry.streak.reminderTime)).length;

        let totalTargetDays = 0;
        let totalDoneInPlan = 0;
        let totalRemainingDays = 0;
        reports.forEach((entry) => {
          if (!entry.report.hasTarget) {
            return;
          }
          totalTargetDays += entry.report.targetDays;
          totalDoneInPlan += entry.report.doneInPlan;
          totalRemainingDays += entry.report.remainingDays;
        });

        const overallPlanProgress = totalTargetDays > 0
          ? Math.round((totalDoneInPlan / Math.max(1, totalTargetDays)) * 100)
          : 0;

        const monthTotals = reports.reduce(
          (acc, entry) => {
            acc.done += entry.report.monthReport.doneDays;
            acc.missed += entry.report.monthReport.missedDays;
            return acc;
          },
          { done: 0, missed: 0 }
        );
        const monthTracked = monthTotals.done + monthTotals.missed;
        const monthSuccess = monthTracked ? Math.round((monthTotals.done / monthTracked) * 100) : 0;

        return {
          totalStreaks,
          activeCount,
          completedCount,
          archivedCount,
          doneTodayCount,
          totalDoneDays,
          longestOverall,
          remindersOn,
          totalTargetDays,
          totalDoneInPlan,
          totalRemainingDays,
          overallPlanProgress,
          monthDoneDays: monthTotals.done,
          monthMissedDays: monthTotals.missed,
          monthSuccess,
        };
      }

      function renderOverallReport() {
        if (!overallReportGrid) {
          return;
        }

        if (!streaks.length) {
          overallReportGrid.innerHTML = '<div class="report-summary-empty">No streak data available for report.</div>';
          return;
        }

        const overall = getOverallReportData();

        const kpis = [
          { label: "Total Streaks", value: String(overall.totalStreaks), hint: "All streak records" },
          { label: "Active", value: String(overall.activeCount), hint: "Running now" },
          { label: "Completed", value: String(overall.completedCount), hint: "Target reached" },
          { label: "Archived", value: String(overall.archivedCount), hint: "Paused/archived" },
          { label: "Done Today", value: String(overall.doneTodayCount), hint: "Marked today" },
          { label: "Total Done Days", value: formatDayCountLabel(overall.totalDoneDays), hint: "All-time valid logs" },
          { label: "Target Days", value: overall.totalTargetDays > 0 ? formatDayCountLabel(overall.totalTargetDays) : "--", hint: "All planned streak targets" },
          { label: "Done In Plan", value: overall.totalTargetDays > 0 ? formatDayCountLabel(overall.totalDoneInPlan) : "--", hint: "Done days inside plan range" },
          { label: "Remaining Days", value: overall.totalTargetDays > 0 ? formatDayCountLabel(overall.totalRemainingDays) : "--", hint: "Pending days in planned streaks" },
          { label: "Plan Progress", value: overall.totalTargetDays > 0 ? `${overall.overallPlanProgress}%` : "--", hint: "Done/target across planned streaks" },
          { label: "Month Done", value: formatDayCountLabel(overall.monthDoneDays), hint: "All streaks this month" },
          { label: "Month Missed", value: formatDayCountLabel(overall.monthMissedDays), hint: "All streaks this month" },
          { label: "Month Success", value: `${overall.monthSuccess}%`, hint: "Done vs tracked this month" },
          { label: "Best Longest", value: formatDayCountLabel(overall.longestOverall), hint: "Top streak record" },
          { label: "Reminders On", value: `${overall.remindersOn}/${overall.totalStreaks}`, hint: "Streak reminders enabled" },
        ];

        overallReportGrid.innerHTML = kpis
          .map(
            (kpi) => `
              <article class="report-kpi">
                <p class="report-kpi-label">${kpi.label}</p>
                <p class="report-kpi-value">${kpi.value}</p>
                <p class="report-kpi-hint">${kpi.hint}</p>
              </article>
            `
          )
          .join("");
      }

      function renderReportDetail() {
        if (!reportDetail) {
          return;
        }

        if (!streaks.length) {
          reportDetail.innerHTML = '<div class="calendar-report-empty">No streaks available yet.</div>';
          return;
        }

        const selected = streaks.find((streak) => getStreakId(streak) === String(reportSelectedStreakId)) || streaks[0];
        reportSelectedStreakId = getStreakId(selected);
        if (reportStreakFilter) {
          reportStreakFilter.value = String(reportSelectedStreakId);
        }

        reportDetail.innerHTML = `
          <div class="calendar-report">
            ${buildStreakReportMarkup(selected, {
              title: "Streak-wise Report",
              subText: `${selected.name || "Untitled"} - ${getCurrentMonthReport(selected).label}`,
              showLegend: true,
            })}
          </div>
        `;
      }

      function renderReportSection() {
        syncReportFilterOptions();
        renderOverallReport();
        renderReportDetail();
      }

      function renderCalendarReport(streak) {
        if (!calendarReport) {
          return;
        }

        if (!streak) {
          calendarReport.innerHTML = '<div class="calendar-report-empty">Select a streak to view full report.</div>';
          return;
        }

        calendarReport.innerHTML = buildStreakReportMarkup(streak, {
          title: "Streak Report",
          subText: getCurrentMonthReport(streak).label,
          showLegend: true,
        });
      }
      function setActiveTab(tabName) {
        sectionDashboard.classList.toggle("active", tabName === "dashboard");
        sectionAdd.classList.toggle("active", tabName === "add");
        sectionReport.classList.toggle("active", tabName === "report");
        sectionProfile.classList.toggle("active", tabName === "profile");
        tabDashboard.classList.toggle("active", tabName === "dashboard");
        tabAdd.classList.toggle("active", tabName === "add");
        tabReport.classList.toggle("active", tabName === "report");
        tabProfile.classList.toggle("active", tabName === "profile");

        if (tabName !== "dashboard") {
          closeCalendarSheet();
        }
        closeShareSheet();

        if (tabName === "report") {
          renderReportSection();
        }
      }

      function openCalendarSheet(streakId = null) {
        if (!calendarPanel || !calendarGrid) {
          return;
        }
        if (shareSheet && shareSheet.classList.contains("open")) {
          closeShareSheet();
        }
        if (calendarPanel.classList.contains("open")) {
          return;
        }

        const now = new Date();
        calendarMonthCursor = new Date(now.getFullYear(), now.getMonth(), 1);

        if (streakId) {
          selectedStreakId = String(streakId);
        }

        syncCalendarStreakSelect();
        renderCalendar();

        lockBodyScroll();
        calendarPanel.classList.add("open");
        calendarPanel.setAttribute("aria-hidden", "false");
        document.body.classList.add("calendar-open");

        if (calendarBackdrop) {
          calendarBackdrop.hidden = false;
          requestAnimationFrame(() => {
            calendarBackdrop.classList.add("show");
          });
        }
      }

      function closeCalendarSheet() {
        if (!calendarPanel) {
          return;
        }
        if (!calendarPanel.classList.contains("open")) {
          return;
        }

        calendarPanel.classList.remove("open");
        calendarPanel.setAttribute("aria-hidden", "true");
        document.body.classList.remove("calendar-open");

        if (calendarBackdrop) {
          calendarBackdrop.classList.remove("show");
          window.setTimeout(() => {
            if (!calendarBackdrop.classList.contains("show")) {
              calendarBackdrop.hidden = true;
            }
            unlockBodyScroll();
          }, 260);
        } else {
          unlockBodyScroll();
        }
      }

      function updateReminderTimeField() {
        const enabled = reminderEnabledInput.checked;
        reminderTimeField.classList.toggle("hidden", !enabled);
        reminderTimeInput.required = enabled;
      }

      function updateReminderControlFieldState() {
        if (followupDelayMinutesInput) {
          followupDelayMinutesInput.disabled = !Boolean(followupToggle && followupToggle.checked);
        }
        if (lastChanceTimeInput) {
          lastChanceTimeInput.disabled = !Boolean(lastChanceToggle && lastChanceToggle.checked);
        }

        const riskEnabled = Boolean(riskAlertToggle && riskAlertToggle.checked);
        if (riskThresholdDaysInput) {
          riskThresholdDaysInput.disabled = !riskEnabled;
        }
        if (riskLeadMinutesInput) {
          riskLeadMinutesInput.disabled = !riskEnabled;
        }

        if (weeklyPlanningTimeInput) {
          weeklyPlanningTimeInput.disabled = !Boolean(weeklyPlanningToggle && weeklyPlanningToggle.checked);
        }

        const quietEnabled = Boolean(quietHoursToggle && quietHoursToggle.checked);
        if (quietHoursStartInput) {
          quietHoursStartInput.disabled = !quietEnabled;
        }
        if (quietHoursEndInput) {
          quietHoursEndInput.disabled = !quietEnabled;
        }
      }

      function renderReminderControls() {
        const settings = getReminderSettings();

        if (followupToggle) {
          followupToggle.checked = settings.followUpEnabled;
        }
        if (followupDelayMinutesInput) {
          followupDelayMinutesInput.value = String(settings.followUpDelayMinutes);
        }

        if (lastChanceToggle) {
          lastChanceToggle.checked = settings.lastChanceEnabled;
        }
        if (lastChanceTimeInput) {
          lastChanceTimeInput.value = settings.lastChanceTime;
        }

        if (riskAlertToggle) {
          riskAlertToggle.checked = settings.riskAlertEnabled;
        }
        if (riskThresholdDaysInput) {
          riskThresholdDaysInput.value = String(settings.riskThresholdDays);
        }
        if (riskLeadMinutesInput) {
          riskLeadMinutesInput.value = String(settings.riskLeadMinutes);
        }

        if (weeklyPlanningToggle) {
          weeklyPlanningToggle.checked = settings.weeklyPlanningEnabled;
        }
        if (weeklyPlanningTimeInput) {
          weeklyPlanningTimeInput.value = settings.weeklyPlanningTime;
        }

        if (quietHoursToggle) {
          quietHoursToggle.checked = settings.quietHoursEnabled;
        }
        if (quietHoursStartInput) {
          quietHoursStartInput.value = settings.quietHoursStart;
        }
        if (quietHoursEndInput) {
          quietHoursEndInput.value = settings.quietHoursEnd;
        }

        if (snoozeMinutesInput) {
          snoozeMinutesInput.value = String(settings.snoozeMinutes);
        }

        const snoozeUntil = getSnoozeUntilTimestamp();
        if (snoozeUntil) {
          setReminderControlStatus(`Snoozed until ${formatReminderDateTime(snoozeUntil)}.`, "success");
        } else {
          setReminderControlStatus("No active snooze.");
        }

        updateReminderControlFieldState();
      }

      function getReminderSettingsFromInputs() {
        const nextSettings = {
          followUpEnabled: Boolean(followupToggle && followupToggle.checked),
          followUpDelayMinutes: Number(followupDelayMinutesInput?.value || 0),
          lastChanceEnabled: Boolean(lastChanceToggle && lastChanceToggle.checked),
          lastChanceTime: String(lastChanceTimeInput?.value || "").trim(),
          riskAlertEnabled: Boolean(riskAlertToggle && riskAlertToggle.checked),
          riskThresholdDays: Number(riskThresholdDaysInput?.value || 0),
          riskLeadMinutes: Number(riskLeadMinutesInput?.value || 0),
          weeklyPlanningEnabled: Boolean(weeklyPlanningToggle && weeklyPlanningToggle.checked),
          weeklyPlanningTime: String(weeklyPlanningTimeInput?.value || "").trim(),
          quietHoursEnabled: Boolean(quietHoursToggle && quietHoursToggle.checked),
          quietHoursStart: String(quietHoursStartInput?.value || "").trim(),
          quietHoursEnd: String(quietHoursEndInput?.value || "").trim(),
          snoozeMinutes: Number(snoozeMinutesInput?.value || 0),
        };

        if (nextSettings.followUpEnabled && !Number.isInteger(nextSettings.followUpDelayMinutes)) {
          throw new Error("Follow-up delay should be a whole number.");
        }
        if (nextSettings.followUpEnabled && (nextSettings.followUpDelayMinutes < 5 || nextSettings.followUpDelayMinutes > 360)) {
          throw new Error("Follow-up delay should be between 5 and 360 minutes.");
        }

        if (nextSettings.lastChanceEnabled && !parseTimeParts(nextSettings.lastChanceTime)) {
          throw new Error("Last chance time should be in HH:MM format.");
        }

        if (nextSettings.riskAlertEnabled) {
          if (!Number.isInteger(nextSettings.riskThresholdDays) || nextSettings.riskThresholdDays < 1 || nextSettings.riskThresholdDays > 3650) {
            throw new Error("Risk threshold should be between 1 and 3650 days.");
          }
          if (!Number.isInteger(nextSettings.riskLeadMinutes) || nextSettings.riskLeadMinutes < 5 || nextSettings.riskLeadMinutes > 360) {
            throw new Error("Risk lead should be between 5 and 360 minutes.");
          }
        }

        if (nextSettings.weeklyPlanningEnabled && !parseTimeParts(nextSettings.weeklyPlanningTime)) {
          throw new Error("Weekly planning time should be in HH:MM format.");
        }

        if (nextSettings.quietHoursEnabled) {
          if (!parseTimeParts(nextSettings.quietHoursStart) || !parseTimeParts(nextSettings.quietHoursEnd)) {
            throw new Error("Quiet hours start/end should be in HH:MM format.");
          }
        }

        if (!Number.isInteger(nextSettings.snoozeMinutes) || nextSettings.snoozeMinutes < 5 || nextSettings.snoozeMinutes > 720) {
          throw new Error("Snooze minutes should be between 5 and 720.");
        }

        return sanitizeReminderSettings(nextSettings);
      }

      async function syncReminderSettingsFromServer() {
        try {
          const data = await apiRequest(REMINDER_SETTINGS_API);
          if (data && data.settings) {
            const sanitized = sanitizeReminderSettings(data.settings);
            setReminderSettings({
              ...sanitized,
              snoozeUntil: data.settings.snoozeUntil || null,
            });
            if (data.settings.snoozeUntil) {
              const parsed = new Date(data.settings.snoozeUntil);
              if (!Number.isNaN(parsed.getTime())) {
                setSnoozeUntilTimestamp(parsed.getTime());
              }
            } else {
              clearReminderSnooze();
            }
            renderReminderControls();
          }
        } catch {
          // Keep local settings fallback when backend settings API is unavailable.
        }
      }

      async function saveReminderSettingsFromUI() {
        const nextSettings = getReminderSettingsFromInputs();
        const saved = setReminderSettings(nextSettings);
        if (snoozeMinutesInput) {
          snoozeMinutesInput.value = String(saved.snoozeMinutes);
        }
        updateReminderControlFieldState();
        let syncedWithBackend = true;
        try {
          const data = await apiRequest(REMINDER_SETTINGS_API, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(nextSettings),
          });
          if (data && data.settings) {
            const serverSettings = sanitizeReminderSettings(data.settings);
            setReminderSettings({
              ...serverSettings,
              snoozeUntil: data.settings.snoozeUntil || null,
            });
            if (data.settings.snoozeUntil) {
              const parsed = new Date(data.settings.snoozeUntil);
              if (!Number.isNaN(parsed.getTime())) {
                setSnoozeUntilTimestamp(parsed.getTime());
              }
            }
          }
        } catch {
          syncedWithBackend = false;
          setProfileStatus("Saved locally. Backend settings sync failed.", "error");
        }
        scheduleAllReminders();
        if (syncedWithBackend) {
          setProfileStatus("Reminder logic saved.", "success");
        }
        return saved;
      }

      async function applyReminderSnoozeFromInput() {
        const settings = getReminderSettings();
        const minutes = clampInteger(snoozeMinutesInput?.value, 5, 720, settings.snoozeMinutes);
        if (snoozeMinutesInput) {
          snoozeMinutesInput.value = String(minutes);
        }
        let until = setSnoozeUntilTimestamp(Date.now() + minutes * 60 * 1000);
        try {
          const data = await apiRequest(REMINDER_SNOOZE_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ minutes }),
          });
          if (data && data.settings) {
            const serverSettings = sanitizeReminderSettings(data.settings);
            setReminderSettings({
              ...serverSettings,
              snoozeUntil: data.settings.snoozeUntil || null,
            });
          }
          if (data && data.snoozeUntil) {
            const parsed = new Date(data.snoozeUntil);
            if (!Number.isNaN(parsed.getTime())) {
              until = setSnoozeUntilTimestamp(parsed.getTime());
            }
          }
        } catch {
          // Keep local snooze if backend call fails.
        }
        setReminderControlStatus(`Snoozed until ${formatReminderDateTime(until)}.`, "success");
        scheduleAllReminders();
      }

      function renderSummary() {
        const today = getTodayDateString();
        const activeStreaks = getActiveStreaks();
        const nonArchivedCount = streaks.filter((s) => !isArchivedStreak(s)).length;
        const doneToday = activeStreaks.filter((s) => getNormalizedLogSet(s).has(today)).length;
        const activePlanTargets = activeStreaks
          .map((streak) => {
            const targetDaysRaw = Number(streak?.targetDays || 0);
            return Number.isInteger(targetDaysRaw) && targetDaysRaw > 0 ? targetDaysRaw : 0;
          })
          .filter((targetDays) => targetDays > 0);
        const plannedDisplayDays = activePlanTargets.length ? Math.max(...activePlanTargets) : 0;

        animateCounterValue(activeCount, activeStreaks.length);
        animateCounterValue(doneTodayCount, doneToday);
        animateCounterValue(bestCount, plannedDisplayDays);
        profileActive.textContent = String(activeStreaks.length);

        const activeRatio = activeStreaks.length / Math.max(1, nonArchivedCount);
        const doneRatio = doneToday / Math.max(1, activeStreaks.length);
        const plannedRatio = activeStreaks.length > 0
          ? (activePlanTargets.length / Math.max(1, activeStreaks.length))
          : 0;

        setRingProgress(activeRing, activeRatio);
        setRingProgress(doneRing, doneRatio);
        setRingProgress(bestRing, plannedRatio);

        if (activeHint) {
          activeHint.textContent = `${activeStreaks.length}/${Math.max(nonArchivedCount, 0)}`;
        }
        if (doneHint) {
          doneHint.textContent = `${Math.round(Math.max(0, Math.min(1, doneRatio)) * 100)}%`;
        }
        if (plannedHint) {
          if (!activeStreaks.length) {
            plannedHint.textContent = "No plan";
          } else if (plannedDisplayDays > 0) {
            plannedHint.textContent = `${activePlanTargets.length}\u00A0STRK`;
          } else {
            plannedHint.textContent = "Open";
          }
        }
      }

      function getWeekProgressForStreak(streak) {
        const labels = ["S", "M", "T", "W", "T", "F", "S"];
        const todayStr = getTodayDateString();
        const todayDate = parseDateFromYmd(todayStr);
        const startDate = parseDateFromYmd(getStartDate(streak));
        const endDateStr = getEndDate(streak);
        const logs = getNormalizedLogSet(streak);

        if (!todayDate) {
          return labels.map((label) => ({ label, status: "future", isToday: false }));
        }

        const weekStart = new Date(todayDate);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());

        return labels.map((label, index) => {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + index);
          const dayStr = formatLocalDate(dayDate);
          const isToday = dayStr === todayStr;

          let status = "missed";
          if (startDate && dayDate < startDate) {
            status = "inactive";
          } else if (endDateStr && dayStr > endDateStr) {
            status = "inactive";
          } else if (logs.has(dayStr)) {
            status = "done";
          } else if (dayStr > todayStr) {
            status = "future";
          } else if (dayStr === todayStr) {
            status = "today";
          }

          return { label, status, isToday };
        });
      }

      function getCardGoalText(streak) {
        const explicitGoal = String(streak?.dailyGoal || "").trim();
        if (explicitGoal) {
          return explicitGoal;
        }

        const nameGoal = String(streak?.name || "").trim();
        if (nameGoal) {
          return nameGoal;
        }

        return "Complete once daily";
      }

      function createIconActionButton({ iconName, title, action, streakId, className = "" }) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = `icon-btn ${className}`.trim();
        button.dataset.action = action;
        button.dataset.id = streakId;
        button.title = title;
        button.setAttribute("aria-label", title);
        button.appendChild(createIconNode(iconName));
        return button;
      }

      function createStreakCard(streak, cardIndex = 0) {
        const card = document.createElement("article");
        card.className = "card";
        applyCardStagger(card, cardIndex);

        const streakId = getStreakId(streak);
        const theme = getCardThemeByStreak(streak);
        card.dataset.id = streakId;
        card.style.setProperty("--card-bg", theme.cardBg);
        card.style.setProperty("--card-border", theme.cardBorder);
        card.style.setProperty("--card-shadow", theme.cardShadow);

        if (streakId === String(selectedStreakId)) {
          card.classList.add("selected");
        }

        const start = getStartDate(streak);
        const end = getEndDate(streak);
        const targetDays = Number(streak.targetDays || 0);
        const doneDays = targetDays > 0
          ? Math.min(getDoneDaysInPlan(streak), targetDays)
          : getDoneDaysInPlan(streak);
        const reminder = streak.reminderEnabled && streak.reminderTime
          ? `Reminder ${streak.reminderTime}`
          : "No reminder";
        const planText = targetDays > 0 ? `${doneDays}/${targetDays}` : `${doneDays}/open`;
        card.title = `Plan ${planText} | Start ${formatReadableDate(start)}${end ? ` | End ${formatReadableDate(end)}` : ""} | ${reminder}`;

        const top = document.createElement("div");
        top.className = "card-top";

        const head = document.createElement("div");
        head.className = "card-head";

        const icon = document.createElement("div");
        icon.className = "card-icon";
        icon.appendChild(createIconNode("streak", "card-glyph"));
        icon.style.setProperty("--card-icon-bg", theme.iconBg);
        icon.style.setProperty("--card-icon-color", theme.iconColor);
        icon.style.setProperty("--card-icon-inset", theme.iconInset);

        const name = document.createElement("h3");
        name.className = "card-name";
        name.textContent = streak.name || "Untitled";

        head.appendChild(icon);
        head.appendChild(name);

        const calendarBtn = document.createElement("button");
        calendarBtn.type = "button";
        calendarBtn.className = "card-calendar-btn";
        calendarBtn.dataset.action = "calendar";
        calendarBtn.dataset.id = streakId;

        const calendarIcon = createIconNode("calendar");
        const calendarText = document.createElement("span");
        calendarText.textContent = "Streak Calendar";

        calendarBtn.appendChild(calendarIcon);
        calendarBtn.appendChild(calendarText);

        const cardTools = document.createElement("div");
        cardTools.className = "card-tools";
        cardTools.appendChild(calendarBtn);
        cardTools.appendChild(createIconActionButton({
          iconName: "share",
          title: "Share streak",
          action: "share",
          streakId,
          className: "share",
        }));
        cardTools.appendChild(createIconActionButton({
          iconName: "archive",
          title: "Archive streak",
          action: "archive",
          streakId,
          className: "archive",
        }));
        cardTools.appendChild(createIconActionButton({
          iconName: "delete",
          title: "Delete streak",
          action: "delete",
          streakId,
          className: "delete",
        }));

        top.appendChild(head);
        top.appendChild(cardTools);

        const weekTrack = createWeekHeatmap(streak);

        const stats = document.createElement("div");
        stats.className = "card-stats";

        const currentStat = document.createElement("div");
        currentStat.className = "card-stat";

        const currentLabel = document.createElement("div");
        currentLabel.className = "card-stat-label";
        currentLabel.textContent = "Current Streak";

        const currentValue = document.createElement("p");
        currentValue.className = "card-stat-value";
        const currentDays = Number(streak.currentStreak || 0);
        currentValue.textContent = `${currentDays} ${currentDays === 1 ? "Day" : "Days"}`;

        currentStat.appendChild(currentLabel);
        currentStat.appendChild(currentValue);

        const durationStat = document.createElement("div");
        durationStat.className = "card-stat";

        const durationLabel = document.createElement("div");
        durationLabel.className = "card-stat-label";
        durationLabel.textContent = "Streak Duration";

        const durationValue = document.createElement("p");
        durationValue.className = "card-stat-value";
        const durationDays = getStreakDurationDays(streak);
        durationValue.textContent = `${durationDays} ${durationDays === 1 ? "Day" : "Days"}`;

        durationStat.appendChild(durationLabel);
        durationStat.appendChild(durationValue);

        stats.appendChild(currentStat);
        stats.appendChild(durationStat);

        const actions = document.createElement("div");
        actions.className = "card-actions";

        const markBtn = document.createElement("button");
        markBtn.type = "button";
        markBtn.className = "btn btn-main";
        markBtn.dataset.action = "mark";
        markBtn.dataset.id = streakId;

        const today = getTodayDateString();
        const todayDate = parseDateFromYmd(today);
        const startDate = parseDateFromYmd(start);
        const logs = getNormalizedLogArray(streak);

        if (logs.includes(today)) {
          markBtn.textContent = "Today Completed";
          markBtn.disabled = true;
        } else if (startDate && todayDate && todayDate < startDate) {
          markBtn.textContent = `Starts ${start}`;
          markBtn.disabled = true;
        } else if (end && today > end) {
          markBtn.textContent = "Plan Ended";
          markBtn.disabled = true;
        } else {
          markBtn.textContent = "Mark Done for Today";
        }

        actions.appendChild(markBtn);

        card.appendChild(top);
        card.appendChild(weekTrack);
        card.appendChild(stats);
        card.appendChild(actions);

        return card;
      }

      function renderStreakList() {
        streakList.innerHTML = "";
        const activeStreaks = getActiveStreaks();
        if (!activeStreaks.length) {
          streakList.appendChild(
            createEmptyStateCard(
              "active",
              "No active streaks. Add a new streak or restore one from Archive."
            )
          );
          return;
        }
        activeStreaks.forEach((streak, index) => {
          streakList.appendChild(createStreakCard(streak, index));
        });
      }

      function createArchivedCard(streak, cardIndex = 0) {
        const card = document.createElement("article");
        card.className = "card card-archived";
        applyCardStagger(card, cardIndex);
        const streakId = getStreakId(streak);
        const theme = getCardThemeByStreak(streak);
        card.dataset.id = streakId;
        card.style.setProperty("--card-bg", theme.cardBg);
        card.style.setProperty("--card-border", theme.cardBorder);
        card.style.setProperty("--card-shadow", theme.cardShadow);

        const top = document.createElement("div");
        top.className = "card-top";

        const head = document.createElement("div");
        head.className = "card-head";

        const icon = document.createElement("div");
        icon.className = "card-icon";
        icon.appendChild(createIconNode("archived", "card-glyph"));
        icon.style.setProperty("--card-icon-bg", theme.iconBg);
        icon.style.setProperty("--card-icon-color", theme.iconColor);
        icon.style.setProperty("--card-icon-inset", theme.iconInset);

        const name = document.createElement("h3");
        name.className = "card-name";
        name.textContent = streak.name || "Untitled";

        head.appendChild(icon);
        head.appendChild(name);

        const tools = document.createElement("div");
        tools.className = "card-tools";
        tools.appendChild(createIconActionButton({
          iconName: "calendar",
          title: "Open calendar",
          action: "calendar",
          streakId,
        }));
        tools.appendChild(createIconActionButton({
          iconName: "share",
          title: "Share streak",
          action: "share",
          streakId,
          className: "share",
        }));
        tools.appendChild(createIconActionButton({
          iconName: "restore",
          title: "Restore streak",
          action: "unarchive",
          streakId,
          className: "restore",
        }));
        tools.appendChild(createIconActionButton({
          iconName: "delete",
          title: "Delete streak",
          action: "delete",
          streakId,
          className: "delete",
        }));

        top.appendChild(head);
        top.appendChild(tools);

        const archivedLabel = document.createElement("p");
        archivedLabel.className = "card-goal-label";
        const archivedDate = streak.archivedAt ? new Date(streak.archivedAt) : null;
        archivedLabel.textContent =
          archivedDate && !Number.isNaN(archivedDate.getTime())
            ? `Archived on ${new Intl.DateTimeFormat("en-US", { month: "short", day: "numeric", year: "numeric" }).format(archivedDate)}`
            : "Archived streak";

        const goalText = document.createElement("p");
        goalText.className = "card-goal-text";
        goalText.textContent = getCardGoalText(streak);

        card.appendChild(top);
        card.appendChild(archivedLabel);
        card.appendChild(goalText);
        return card;
      }

      function createCompletedCard(streak, cardIndex = 0) {
        const card = document.createElement("article");
        card.className = "card card-completed";
        applyCardStagger(card, cardIndex);
        const streakId = getStreakId(streak);
        const theme = getCardThemeByStreak(streak);
        card.dataset.id = streakId;
        card.style.setProperty("--card-bg", theme.cardBg);
        card.style.setProperty("--card-border", theme.cardBorder);
        card.style.setProperty("--card-shadow", theme.cardShadow);

        const top = document.createElement("div");
        top.className = "card-top";

        const head = document.createElement("div");
        head.className = "card-head";

        const icon = document.createElement("div");
        icon.className = "card-icon";
        icon.appendChild(createIconNode("completed", "card-glyph"));
        icon.style.setProperty("--card-icon-bg", theme.iconBg);
        icon.style.setProperty("--card-icon-color", theme.iconColor);
        icon.style.setProperty("--card-icon-inset", theme.iconInset);

        const name = document.createElement("h3");
        name.className = "card-name";
        name.textContent = streak.name || "Untitled";

        head.appendChild(icon);
        head.appendChild(name);

        const tools = document.createElement("div");
        tools.className = "card-tools";
        tools.appendChild(createIconActionButton({
          iconName: "calendar",
          title: "Open calendar",
          action: "calendar",
          streakId,
        }));
        tools.appendChild(createIconActionButton({
          iconName: "share",
          title: "Share streak",
          action: "share",
          streakId,
          className: "share",
        }));
        tools.appendChild(createIconActionButton({
          iconName: "archive",
          title: "Archive streak",
          action: "archive",
          streakId,
          className: "archive",
        }));
        tools.appendChild(createIconActionButton({
          iconName: "delete",
          title: "Delete streak",
          action: "delete",
          streakId,
          className: "delete",
        }));

        top.appendChild(head);
        top.appendChild(tools);

        const completedBadge = document.createElement("p");
        completedBadge.className = "complete-badge";
        completedBadge.textContent = "Completed";

        const goalText = document.createElement("p");
        goalText.className = "card-goal-text";
        goalText.textContent = getCardGoalText(streak);

        card.appendChild(top);
        card.appendChild(completedBadge);
        card.appendChild(goalText);
        return card;
      }

      function renderArchiveList() {
        archiveList.innerHTML = "";
        const archivedStreaks = getArchivedStreaks();
        if (!archivedStreaks.length) {
          archiveList.appendChild(
            createEmptyStateCard(
              "archive",
              "Nothing has been archived yet. Archived streaks will appear here."
            )
          );
          return;
        }

        archivedStreaks.forEach((streak, index) => {
          archiveList.appendChild(createArchivedCard(streak, index));
        });
      }

      function renderCompletedList() {
        completedList.innerHTML = "";
        const completedStreaks = getCompletedStreaks();
        if (!completedStreaks.length) {
          completedList.appendChild(
            createEmptyStateCard(
              "completed",
              "Complete a streak target to unlock trophy cards here."
            )
          );
          return;
        }

        completedStreaks.forEach((streak, index) => {
          completedList.appendChild(createCompletedCard(streak, index));
        });
      }

      function renderCalendar() {
        if (!calendarGrid || !monthLabel) {
          return;
        }

        const selected = getSelectedStreak();
        monthLabel.textContent = formatMonthLabel(calendarMonthCursor);
        calendarGrid.innerHTML = "";

        if (!selected) {
          if (selectedLabel) {
            selectedLabel.textContent = "Select a streak";
          }
          if (calendarCurrentValue) {
            calendarCurrentValue.textContent = "0 Days";
          }
          if (calendarDurationValue) {
            calendarDurationValue.textContent = "0 Days";
          }
          renderCalendarReport(null);

          for (let i = 0; i < 35; i += 1) {
            const cell = document.createElement("div");
            cell.className = "day empty";
            calendarGrid.appendChild(cell);
          }
          return;
        }

        if (selectedLabel) {
          selectedLabel.textContent = selected.name || "Streak Calendar";
        }
        if (calendarCurrentValue) {
          const current = Number(selected.currentStreak || 0);
          calendarCurrentValue.textContent = `${current} ${current === 1 ? "Day" : "Days"}`;
        }
        if (calendarDurationValue) {
          const duration = getStreakDurationDays(selected);
          calendarDurationValue.textContent = `${duration} ${duration === 1 ? "Day" : "Days"}`;
        }
        renderCalendarReport(selected);

        const year = calendarMonthCursor.getFullYear();
        const month = calendarMonthCursor.getMonth();
        const firstDay = new Date(year, month, 1);
        const totalDays = new Date(year, month + 1, 0).getDate();
        const startOffset = firstDay.getDay();

        for (let i = 0; i < startOffset; i += 1) {
          const blank = document.createElement("div");
          blank.className = "day empty";
          calendarGrid.appendChild(blank);
        }

        const today = getTodayDateString();
        const usedCells = startOffset + totalDays;
        const totalGridCells = usedCells <= 35 ? 35 : 42;

        for (let day = 1; day <= totalDays; day += 1) {
          const date = new Date(year, month, day);
          const dateStr = formatLocalDate(date);
          const cell = document.createElement("div");
          cell.className = `day ${getDayStatus(dateStr, selected)}`;
          cell.textContent = String(day);
          if (dateStr === today) {
            cell.classList.add("today");
          }
          calendarGrid.appendChild(cell);
        }

        for (let i = usedCells; i < totalGridCells; i += 1) {
          const blank = document.createElement("div");
          blank.className = "day empty";
          calendarGrid.appendChild(blank);
        }
      }

      function renderProfile() {
        let user = currentUser;
        if (!user) {
          try {
            user = JSON.parse(localStorage.getItem("streak_user") || "{}");
          } catch {
            user = {};
          }
        }
        profileName.textContent = user.name || "-";
        profileEmail.textContent = user.email || "-";
        appReminderToggle.checked = isAppReminderEnabled();
        renderReminderControls();

        if (!("Notification" in window)) {
          notificationState.textContent = "Permission: Notification API not supported";
          allowNotificationBtn.disabled = true;
          if (testNotificationBtn) {
            testNotificationBtn.disabled = true;
          }
        } else {
          notificationState.textContent = `Permission: ${Notification.permission}`;
          allowNotificationBtn.disabled = Notification.permission === "granted";
          if (testNotificationBtn) {
            testNotificationBtn.disabled = Notification.permission !== "granted";
          }
        }
      }

      function renderAll() {
        todayLabel.textContent = `Today: ${formatTopDate(new Date())}`;
        refreshStreakThemeIndexes();
        syncCalendarStreakSelect();
        renderWelcome();
        renderSummary();
        renderStreakList();
        renderArchiveList();
        renderCompletedList();
        renderReportSection();
        renderCalendar();
        renderProfile();
      }

      function clearAllReminderTimers() {
        reminderTimers.forEach((timerId) => clearTimeout(timerId));
        reminderTimers.clear();
      }

      function buildStreakReminderEvents(streak, now, settings) {
        const events = [];
        const streakId = getStreakId(streak);
        if (!streakId) {
          return events;
        }
        if (isArchivedStreak(streak) || isCompletedStreak(streak)) {
          return events;
        }
        if (!streak.reminderEnabled || !parseTimeParts(streak.reminderTime)) {
          return events;
        }

        const primary = findNextStreakEventTime(
          streak,
          (dayDate) => getDateAtTime(dayDate, streak.reminderTime),
          now,
          settings,
          { allowQuietShift: true, preserveDate: true }
        );
        if (primary) {
          events.push({
            key: `primary:${streakId}:${primary.dayStr}`,
            type: "primary",
            streakId,
            dayStr: primary.dayStr,
            time: primary.time,
          });
        }

        if (settings.followUpEnabled) {
          const followUp = findNextStreakEventTime(
            streak,
            (dayDate) => getFollowUpDateAt(dayDate, streak.reminderTime, settings.followUpDelayMinutes),
            now,
            settings,
            { allowQuietShift: true, preserveDate: true }
          );
          if (followUp) {
            events.push({
              key: `followup:${streakId}:${followUp.dayStr}`,
              type: "followup",
              streakId,
              dayStr: followUp.dayStr,
              time: followUp.time,
            });
          }
        }

        if (settings.lastChanceEnabled && parseTimeParts(settings.lastChanceTime)) {
          const lastChance = findNextStreakEventTime(
            streak,
            (dayDate) => getDateAtTime(dayDate, settings.lastChanceTime),
            now,
            settings,
            { allowQuietShift: false, preserveDate: true }
          );
          if (lastChance) {
            events.push({
              key: `lastchance:${streakId}:${lastChance.dayStr}`,
              type: "lastchance",
              streakId,
              dayStr: lastChance.dayStr,
              time: lastChance.time,
            });
          }
        }

        const currentStreakDays = Math.max(0, Number(streak.currentStreak || 0));
        if (
          settings.riskAlertEnabled
          && currentStreakDays >= settings.riskThresholdDays
          && parseTimeParts(settings.lastChanceTime)
        ) {
          const riskEvent = findNextStreakEventTime(
            streak,
            (dayDate) => getRiskAlertDateAt(dayDate, settings.lastChanceTime, settings.riskLeadMinutes),
            now,
            settings,
            { allowQuietShift: false, preserveDate: true }
          );
          if (riskEvent) {
            events.push({
              key: `risk:${streakId}:${riskEvent.dayStr}`,
              type: "risk",
              streakId,
              dayStr: riskEvent.dayStr,
              time: riskEvent.time,
            });
          }
        }

        return events;
      }

      function buildWeeklyPlanningEvent(now, settings) {
        if (!settings.weeklyPlanningEnabled || !parseTimeParts(settings.weeklyPlanningTime)) {
          return null;
        }

        const todayStr = getTodayDateString();
        const todayDate = parseDateFromYmd(todayStr)
          || new Date(now.getFullYear(), now.getMonth(), now.getDate());

        for (let offset = 0; offset <= 14; offset += 1) {
          const dayDate = new Date(todayDate);
          dayDate.setDate(todayDate.getDate() + offset);
          if (dayDate.getDay() !== 0) {
            continue;
          }

          const rawTarget = getDateAtTime(dayDate, settings.weeklyPlanningTime);
          if (!rawTarget) {
            continue;
          }

          const target = applyReminderRuntimeGates(rawTarget, settings, {
            allowQuietShift: true,
            preserveDate: false,
          });
          if (!target || target.getTime() <= now.getTime()) {
            continue;
          }

          const sourceDay = formatLocalDate(dayDate);
          return {
            key: `weekly:${sourceDay}`,
            type: "weekly",
            dayStr: sourceDay,
            time: target,
          };
        }

        return null;
      }

      function triggerScheduledReminderEvent(event) {
        if (!event || !isAppReminderEnabled()) {
          return;
        }

        const eventKey = String(event.key || "").trim();
        if (eventKey && wasReminderEventRecentlySent(eventKey)) {
          return;
        }

        const settings = getReminderSettings();
        if (event.type === "weekly") {
          if (!settings.weeklyPlanningEnabled) {
            return;
          }

          const active = getActiveStreaks();
          const count = active.length;
          const preview = active
            .slice(0, 3)
            .map((streak) => String(streak.name || "Untitled").trim())
            .filter((name) => Boolean(name))
            .join(", ");
          const body = count > 0
            ? `Plan next week for ${count} active streak${count === 1 ? "" : "s"}${preview ? `: ${preview}${count > 3 ? "..." : ""}` : "."}`
            : "Plan your next week habits and add a new streak.";

          notifyReminder("Weekly Planning", body, [90, 70, 90], {
            tag: eventKey || `weekly:${event.dayStr || getTodayDateString()}`,
            eventType: "weekly",
            dayStr: event.dayStr || getTodayDateString(),
            url: "./dashboard.html?tab=report",
          });
          if (eventKey) {
            markReminderEventSent(eventKey);
          }
          return;
        }

        const latest = streaks.find((s) => getStreakId(s) === String(event.streakId));
        if (!latest || isArchivedStreak(latest) || isCompletedStreak(latest) || !latest.reminderEnabled || !latest.reminderTime) {
          return;
        }

        const dayStr = String(event.dayStr || getTodayDateString()).trim();
        if (!dayStr || !isStreakDateInPlan(latest, dayStr)) {
          return;
        }

        if (getNormalizedLogSet(latest).has(dayStr)) {
          return;
        }

        const streakName = String(latest.name || "Untitled streak").trim();
        const currentStreakDays = Math.max(0, Number(latest.currentStreak || 0));

        let title = "Streak Reminder";
        let body = `${streakName} is pending today.`;
        let vibratePattern = [110, 70, 110];

        if (event.type === "followup") {
          if (!settings.followUpEnabled) {
            return;
          }
          title = "Follow-up Nudge";
          body = `${streakName} is still pending. Complete it now.`;
          vibratePattern = [90, 70, 90];
        } else if (event.type === "lastchance") {
          if (!settings.lastChanceEnabled) {
            return;
          }
          title = "Last Chance";
          body = `Last chance for ${streakName} before ${settings.lastChanceTime}.`;
          vibratePattern = [150, 80, 150];
        } else if (event.type === "risk") {
          if (!settings.riskAlertEnabled || currentStreakDays < settings.riskThresholdDays) {
            return;
          }
          title = "Streak Risk Alert";
          body = `${streakName} has a ${currentStreakDays}-day streak at risk.`;
          vibratePattern = [180, 80, 180, 80, 180];
        } else if (event.type === "primary") {
          title = "Streak Reminder";
          body = `Time for ${streakName}. Mark today's completion.`;
        }

        notifyReminder(title, body, vibratePattern, {
          tag: eventKey || `${event.type || "primary"}:${getStreakId(latest)}:${dayStr}`,
          eventType: event.type || "primary",
          streakId: getStreakId(latest),
          dayStr,
          requireInteraction: event.type === "lastchance" || event.type === "risk",
          url: "./dashboard.html?tab=dashboard",
        });
        if (eventKey) {
          markReminderEventSent(eventKey);
        }
      }

      function scheduleAllReminders() {
        clearAllReminderTimers();
        if (!isAppReminderEnabled()) {
          return;
        }

        const settings = getReminderSettings();
        if (settings.quietHoursEnabled && isAlwaysQuiet(settings)) {
          return;
        }

        const now = new Date();
        const events = [];

        getActiveStreaks().forEach((streak) => {
          if (!streak.reminderEnabled || !streak.reminderTime) {
            return;
          }
          events.push(...buildStreakReminderEvents(streak, now, settings));
        });

        const weekly = buildWeeklyPlanningEvent(now, settings);
        if (weekly) {
          events.push(weekly);
        }

        events
          .sort((a, b) => a.time.getTime() - b.time.getTime())
          .forEach((event) => {
            const targetTime = event.time.getTime();
            const delay = Math.max(1000, targetTime - Date.now());
            const safeDelay = Math.min(delay, 2147483647);
            const timeoutId = setTimeout(() => {
              if (Date.now() + 1000 < targetTime) {
                scheduleAllReminders();
                return;
              }
              triggerScheduledReminderEvent(event);
              scheduleAllReminders();
            }, safeDelay);
            reminderTimers.set(event.key, timeoutId);
          });
      }

      async function ensureAuth() {
        const data = await apiRequest(AUTH_ME_API);
        if (data.user) {
          currentUser = data.user;
          localStorage.setItem("streak_user", JSON.stringify(data.user));
          renderWelcome();
        }
      }

      async function fetchStreaks() {
        setGlobalStatus("Loading streaks...");
        streaks = await apiRequest(STREAKS_API);
        if (!selectedStreakId && streaks.length) {
          selectedStreakId = getStreakId(streaks[0]);
        }
        renderAll();
        scheduleAllReminders();
        setGlobalStatus("");
      }

      async function createStreak(event) {
        event.preventDefault();

        const name = String(streakNameInput.value || "")
          .replace(/\s+/g, " ")
          .trim();
        const targetDaysRaw = String(targetDaysInput.value || "").trim();
        let targetDays = null;
        const startDate = String(startDateInput.value || "").trim();
        const reminderEnabled = reminderEnabledInput.checked;
        const reminderTime = String(reminderTimeInput.value || "").trim();

        if (!name) {
          setAddStatus("Please enter streak name.", "error");
          return;
        }
        if (name.length > STREAK_NAME_MAX_LENGTH) {
          setAddStatus(`Streak name must be ${STREAK_NAME_MAX_LENGTH} characters or less.`, "error");
          return;
        }

        if (targetDaysRaw) {
          const parsedTargetDays = Number(targetDaysRaw);
          if (!Number.isInteger(parsedTargetDays) || parsedTargetDays < 1 || parsedTargetDays > 3650) {
            setAddStatus("Target days must be between 1 and 3650, or leave it blank.", "error");
            return;
          }
          targetDays = parsedTargetDays;
        }

        if (!parseDateFromYmd(startDate)) {
          setAddStatus("Please choose valid start date.", "error");
          return;
        }
        if (reminderEnabled && !/^([01]\d|2[0-3]):([0-5]\d)$/.test(reminderTime)) {
          setAddStatus("Reminder time should be HH:MM format.", "error");
          return;
        }

        try {
          setAddStatus("Creating streak...");

          const payload = {
            name,
            startDate,
            reminderEnabled,
            reminderTime: reminderEnabled ? reminderTime : null,
          };
          if (targetDays !== null) {
            payload.targetDays = targetDays;
          }

          const created = await apiRequest(STREAKS_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          streaks.unshift(created);
          selectedStreakId = getStreakId(created);
          streakForm.reset();
          targetDaysInput.value = "";
          startDateInput.value = getTodayDateString();
          reminderEnabledInput.checked = false;
          updateReminderTimeField();
          renderAll();
          scheduleAllReminders();
          setAddStatus("Streak created successfully.", "success");
          setGlobalStatus("New streak added.", "success");
          setActiveTab("dashboard");
        } catch (error) {
          setAddStatus(error.message || "Could not create streak.", "error");
        }
      }

      async function markStreakDone(streakId, button) {
        const today = getTodayDateString();
        const previous = streaks.find((s) => getStreakId(s) === String(streakId));
        const wasDoneToday = getNormalizedLogSet(previous).has(today);

        try {
          if (button) {
            button.disabled = true;
            button.textContent = "Saving...";
          }

          const data = await apiRequest(`${STREAKS_API}/${streakId}/mark`, { method: "POST" });
          let updatedHabit = null;
          if (data.habit) {
            updatedHabit = data.habit;
            streaks = streaks.map((s) => (getStreakId(s) === String(streakId) ? data.habit : s));
          } else {
            // Fallback sync when API response does not include updated habit payload.
            streaks = await apiRequest(STREAKS_API);
            updatedHabit = streaks.find((s) => getStreakId(s) === String(streakId)) || null;
          }
          selectedStreakId = String(streakId);

          if (button) {
            button.disabled = true;
            button.textContent = "Today Completed";
          }

          const isNowDoneToday = getNormalizedLogSet(updatedHabit).has(today);
          if (!wasDoneToday && isNowDoneToday) {
            playCelebration(updatedHabit?.name || previous?.name || "");
          }

          renderAll();
          scheduleAllReminders();
          setGlobalStatus(data.message || "Streak updated and calendar marked.", "success");
        } catch (error) {
          if (button) {
            button.disabled = false;
            button.textContent = "Mark Done for Today";
          }
          setGlobalStatus(error.message || "Could not update streak.", "error");
        }
      }

      async function archiveStreak(streakId, button = null) {
        try {
          if (button) {
            button.disabled = true;
          }

          const data = await apiRequest(STREAK_ARCHIVE_API(streakId), { method: "PATCH" });
          if (data.habit) {
            streaks = streaks.map((s) => (getStreakId(s) === String(streakId) ? data.habit : s));
          }

          renderAll();
          scheduleAllReminders();
          setGlobalStatus(data.message || "Streak archived.", "success");
        } catch (error) {
          if (button) {
            button.disabled = false;
          }
          setGlobalStatus(error.message || "Could not archive streak.", "error");
        }
      }

      async function unarchiveStreak(streakId, button = null) {
        try {
          if (button) {
            button.disabled = true;
          }

          const data = await apiRequest(STREAK_UNARCHIVE_API(streakId), { method: "PATCH" });
          if (data.habit) {
            streaks = streaks.map((s) => (getStreakId(s) === String(streakId) ? data.habit : s));
          }

          renderAll();
          scheduleAllReminders();
          setGlobalStatus(data.message || "Streak restored.", "success");
        } catch (error) {
          if (button) {
            button.disabled = false;
          }
          setGlobalStatus(error.message || "Could not restore streak.", "error");
        }
      }

      async function deleteStreak(streakId, button = null) {
        const target = streaks.find((s) => getStreakId(s) === String(streakId));
        const label = String(target?.name || "this streak").trim();
        const shouldDelete = window.confirm(`Delete "${label}" permanently?`);
        if (!shouldDelete) {
          return;
        }

        try {
          if (button) {
            button.disabled = true;
          }

          const data = await apiRequest(STREAK_DELETE_API(streakId), { method: "DELETE" });
          streaks = streaks.filter((s) => getStreakId(s) !== String(streakId));
          if (String(selectedStreakId) === String(streakId)) {
            selectedStreakId = null;
          }

          renderAll();
          scheduleAllReminders();
          setGlobalStatus(data.message || "Streak deleted.", "success");
        } catch (error) {
          if (button) {
            button.disabled = false;
          }
          setGlobalStatus(error.message || "Could not delete streak.", "error");
        }
      }

      async function logout() {
        try {
          await apiRequest(AUTH_LOGOUT_API, { method: "POST" });
        } catch {
          // Ignore server errors.
        }
        clearSession();
        clearAllReminderTimers();
        redirectToLogin();
      }

      function handleActionButton(button) {
        if (!button) {
          return;
        }

        const streakId = String(button.dataset.id || "").trim();
        if (!streakId) {
          return;
        }

        if (button.dataset.action === "calendar") {
          openCalendarSheet(streakId);
          setGlobalStatus("Selected streak calendar loaded.", "success");
          return;
        }

        if (button.dataset.action === "share") {
          openShareSheet(streakId);
          return;
        }

        if (button.dataset.action === "mark") {
          markStreakDone(streakId, button);
          return;
        }

        if (button.dataset.action === "archive") {
          archiveStreak(streakId, button);
          return;
        }

        if (button.dataset.action === "unarchive") {
          unarchiveStreak(streakId, button);
          return;
        }

        if (button.dataset.action === "delete") {
          deleteStreak(streakId, button);
        }
      }

      streakList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (button) {
          handleActionButton(button);
          return;
        }

        const card = event.target.closest(".card[data-id]");
        if (!card) {
          return;
        }

        const cardStreakId = String(card.dataset.id || "").trim();
        if (!cardStreakId) {
          return;
        }

        selectedStreakId = cardStreakId;
        syncCalendarStreakSelect();
        renderSummary();
        renderStreakList();
        renderCalendar();
        setGlobalStatus("Streak selected.", "success");
      });

      archiveList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
          return;
        }
        handleActionButton(button);
      });

      completedList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
          return;
        }
        handleActionButton(button);
      });

      if (prevMonthBtn) {
        prevMonthBtn.addEventListener("click", () => {
          calendarMonthCursor = new Date(calendarMonthCursor.getFullYear(), calendarMonthCursor.getMonth() - 1, 1);
          renderCalendar();
        });
      }

      if (nextMonthBtn) {
        nextMonthBtn.addEventListener("click", () => {
          calendarMonthCursor = new Date(calendarMonthCursor.getFullYear(), calendarMonthCursor.getMonth() + 1, 1);
          renderCalendar();
        });
      }

      if (todayMonthBtn) {
        todayMonthBtn.addEventListener("click", () => {
          const now = new Date();
          calendarMonthCursor = new Date(now.getFullYear(), now.getMonth(), 1);
          renderCalendar();
        });
      }

      if (closeCalendarBtn) {
        closeCalendarBtn.addEventListener("click", closeCalendarSheet);
      }

      if (shareSheet) {
        shareSheet.addEventListener("click", (event) => {
          const shareButton = event.target.closest("button[data-share-action]");
          if (!shareButton) {
            return;
          }
          const action = String(shareButton.dataset.shareAction || "").trim();
          if (action) {
            handleShareAction(action);
          }
        });
      }

      if (closeShareBtn) {
        closeShareBtn.addEventListener("click", closeShareSheet);
      }

      if (calendarBackdrop) {
        calendarBackdrop.addEventListener("click", closeCalendarSheet);
      }

      if (shareBackdrop) {
        shareBackdrop.addEventListener("click", closeShareSheet);
      }

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          if (shareSheet && shareSheet.classList.contains("open")) {
            closeShareSheet();
          } else {
            closeCalendarSheet();
          }
        }
      });

      streakForm.addEventListener("submit", createStreak);
      reminderEnabledInput.addEventListener("change", updateReminderTimeField);
      [followupToggle, lastChanceToggle, riskAlertToggle, weeklyPlanningToggle, quietHoursToggle]
        .filter((el) => Boolean(el))
        .forEach((el) => {
          el.addEventListener("change", updateReminderControlFieldState);
        });
      if (reportStreakFilter) {
        reportStreakFilter.addEventListener("change", () => {
          reportSelectedStreakId = String(reportStreakFilter.value || "").trim() || null;
          renderReportDetail();
        });
      }

      [tabDashboard, tabAdd, tabReport, tabProfile].forEach((button) => {
        if (!button) {
          return;
        }
        button.addEventListener("click", () => {
          const tab = button.dataset.tab;
          if (tab) {
            setActiveTab(tab);
          }
        });
      });

      appReminderToggle.addEventListener("change", async () => {
        const enabled = appReminderToggle.checked;
        setAppReminderEnabled(enabled);
        scheduleAllReminders();

        if (enabled && "Notification" in window && Notification.permission === "default") {
          try {
            const permission = await Notification.requestPermission();
            notificationState.textContent = `Permission: ${permission}`;
            allowNotificationBtn.disabled = permission === "granted";
            if (testNotificationBtn) {
              testNotificationBtn.disabled = permission !== "granted";
            }
          } catch {
            // Permission prompt failed; keep reminder toggle state unchanged.
          }
        }

        if (enabled && (!("Notification" in window) || Notification.permission !== "granted")) {
          setProfileStatus("Reminders are on, but notification permission is not granted.", "error");
          return;
        }

        setProfileStatus(enabled ? "In-app reminders enabled." : "In-app reminders disabled.", "success");
      });

      if (saveReminderSettingsBtn) {
        saveReminderSettingsBtn.addEventListener("click", async () => {
          try {
            await saveReminderSettingsFromUI();
          } catch (error) {
            setProfileStatus(error.message || "Could not save reminder settings.", "error");
          }
        });
      }

      if (snoozeReminderBtn) {
        snoozeReminderBtn.addEventListener("click", async () => {
          try {
            const saved = await saveReminderSettingsFromUI();
            if (snoozeMinutesInput) {
              snoozeMinutesInput.value = String(saved.snoozeMinutes);
            }
            await applyReminderSnoozeFromInput();
          } catch (error) {
            setProfileStatus(error.message || "Could not snooze reminders.", "error");
          }
        });
      }

      if (clearSnoozeBtn) {
        clearSnoozeBtn.addEventListener("click", async () => {
          clearReminderSnooze();
          try {
            await apiRequest(REMINDER_SNOOZE_API, { method: "DELETE" });
            setReminderControlStatus("Snooze cleared.");
          } catch {
            setReminderControlStatus("Snooze cleared locally.");
          }
          scheduleAllReminders();
        });
      }

      allowNotificationBtn.addEventListener("click", async () => {
        if (!("Notification" in window)) {
          setProfileStatus("Notification API is not supported.", "error");
          if (testNotificationBtn) {
            testNotificationBtn.disabled = true;
          }
          return;
        }

        try {
          const permission = await Notification.requestPermission();
          notificationState.textContent = `Permission: ${permission}`;
          allowNotificationBtn.disabled = permission === "granted";
          if (testNotificationBtn) {
            testNotificationBtn.disabled = permission !== "granted";
          }
          setProfileStatus(permission === "granted" ? "Notification permission granted." : "Notification permission not granted.", permission === "granted" ? "success" : "error");
        } catch {
          setProfileStatus("Could not request notification permission.", "error");
        }
      });

      if (testNotificationBtn) {
        testNotificationBtn.addEventListener("click", async () => {
          if (!("Notification" in window)) {
            setProfileStatus("Notification API is not supported.", "error");
            return;
          }
          if (Notification.permission !== "granted") {
            setProfileStatus("Allow notifications first, then retry test.", "error");
            return;
          }

          const sent = await showRichNotification(
            "Streak Up Reminder",
            "Test alert: Android-style reminder notification is active.",
            {
              tag: "manual-test",
              eventType: "manual-test",
              requireInteraction: true,
              vibratePattern: [110, 70, 110],
              url: "./dashboard.html?tab=dashboard",
            }
          );

          setProfileStatus(sent ? "Test notification sent." : "Could not send test notification.", sent ? "success" : "error");
        });
      }

      window.addEventListener("beforeinstallprompt", (event) => {
        event.preventDefault();
        deferredInstallPromptEvent = event;
        installMarkedDone = false;
        writeInstallMarker(false);
        updateInstallUiState();
      });

      window.addEventListener("appinstalled", () => {
        deferredInstallPromptEvent = null;
        installMarkedDone = true;
        writeInstallMarker(true);
        updateInstallUiState();
        setProfileStatus("App installed successfully.", "success");
      });

      window.addEventListener("pageshow", () => {
        updateInstallUiState();
      });

      if (window.matchMedia) {
        const standaloneMedia = window.matchMedia("(display-mode: standalone)");
        if (typeof standaloneMedia.addEventListener === "function") {
          standaloneMedia.addEventListener("change", updateInstallUiState);
        } else if (typeof standaloneMedia.addListener === "function") {
          standaloneMedia.addListener(updateInstallUiState);
        }
      }

      async function handleInstallRequest() {
          if (isRunningStandalone()) {
            updateInstallUiState();
            return;
          }

          if (deferredInstallPromptEvent) {
            try {
              await deferredInstallPromptEvent.prompt();
              const choice = await deferredInstallPromptEvent.userChoice;
              if (choice?.outcome === "accepted") {
                setInstallStatus("Install started. Check home screen/app list.", "success");
              } else {
                setInstallStatus("Install cancelled.", "error");
              }
            } catch {
              setInstallStatus("Could not open install prompt.", "error");
            } finally {
              deferredInstallPromptEvent = null;
              updateInstallUiState();
            }
            return;
          }

          if (isIosDevice()) {
            setInstallStatus("Open Share icon in Safari and tap Add to Home Screen.", "success");
            return;
          }

          setInstallStatus("Install prompt unavailable right now. Retry after using app for some time.", "error");
      }

      getInstallButtons().forEach((button) => {
        button.addEventListener("click", handleInstallRequest);
      });

      profileLogoutBtn.addEventListener("click", logout);

      (async function boot() {
        if (!getToken()) {
          redirectToLogin();
          return;
        }

        startDateInput.value = getTodayDateString();
        reminderEnabledInput.checked = false;
        appReminderToggle.checked = isAppReminderEnabled();
        installMarkedDone = readInstallMarker();
        if (isRunningStandalone()) {
          installMarkedDone = true;
          writeInstallMarker(true);
        }
        updateInstallUiState();
        updateReminderTimeField();
        renderReminderControls();

        try {
          await ensureAuth();
          await syncReminderSettingsFromServer();
          await fetchStreaks();
          setActiveTab("dashboard");
        } catch (error) {
          setGlobalStatus(error.message || "Could not load dashboard.", "error");
        }
      })();
    </script>
    <script src="./pwa.js"></script>
  </body>
</html>


